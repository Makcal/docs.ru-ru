---
description: 'Узнайте подробнее о: Обход NAT с помощью IPv6 и Teredo'
title: Обход NAT с помощью IPv6 и Teredo
ms.date: 03/30/2017
ms.assetid: 568cd245-3300-49ef-a995-d81bf845d961
ms.openlocfilehash: 4ff7f273c01ef52f4d307cbd3e0698c5cc2ead4d
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99785748"
---
# <a name="nat-traversal-using-ipv6-and-teredo"></a><span data-ttu-id="75707-103">Обход NAT с помощью IPv6 и Teredo</span><span class="sxs-lookup"><span data-stu-id="75707-103">NAT Traversal using IPv6 and Teredo</span></span>

<span data-ttu-id="75707-104">Были внесены улучшения, которые предоставляют поддержку обхода преобразования сетевых адресов (NAT).</span><span class="sxs-lookup"><span data-stu-id="75707-104">Enhancements were made that provide support for Network Address Translation (NAT) traversal.</span></span> <span data-ttu-id="75707-105">Эти изменения предназначены для использования с IPv6 и Teredo, но также могут применяться к другим технологиям туннелирования IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="75707-105">These changes are designed for use with IPv6 and Teredo, but they are also applicable to other IP tunneling technologies.</span></span> <span data-ttu-id="75707-106">Эти улучшения влияют на классы в <xref:System.Net> и соответствующие пространства имен.</span><span class="sxs-lookup"><span data-stu-id="75707-106">These enhancements affect classes in the <xref:System.Net> and related namespaces.</span></span>  
  
 <span data-ttu-id="75707-107">Эти изменения могут повлиять на клиентские и серверные приложения, в которых планируется использовать технологии туннелирования IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="75707-107">These changes can affect client and server applications that plan to use IP tunneling technologies.</span></span>  
  
 <span data-ttu-id="75707-108">Изменения для поддержки обхода NAT доступны только для приложений, которые используют платформу .NET Framework 4.</span><span class="sxs-lookup"><span data-stu-id="75707-108">The changes to support NAT traversal are available only for applications using .NET Framework version 4.</span></span> <span data-ttu-id="75707-109">Эти функции недоступны в более ранних версиях .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="75707-109">These features are not available on earlier versions of the .NET Framework.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="75707-110">Обзор</span><span class="sxs-lookup"><span data-stu-id="75707-110">Overview</span></span>  

 <span data-ttu-id="75707-111">В протоколе IP версии 4 (IPv4) длина IP-адреса IPv4 составляет 32 бита.</span><span class="sxs-lookup"><span data-stu-id="75707-111">The Internet Protocol version 4 (IPv4) defined an IPv4 address as 32 bits long.</span></span> <span data-ttu-id="75707-112">Следовательно, IPv4 поддерживает примерно 4 миллиарда уникальных IP-адресов (2 в 32-й степени).</span><span class="sxs-lookup"><span data-stu-id="75707-112">As a result, IPv4 supports approximately 4 billion unique IP addresses (2^32).</span></span> <span data-ttu-id="75707-113">С увеличением количества компьютеров и сетевых устройств в Интернете в девяностые годы XX века ограничения адресного пространства IPv4 стали очевидными.</span><span class="sxs-lookup"><span data-stu-id="75707-113">As the number of computers and network devices on the Internet expanded in the 1990s, the limits of the IPv4 address space became apparent.</span></span>  
  
 <span data-ttu-id="75707-114">Одна из несколько методик, используемых для увеличения времени существования адреса IPv4, — развертывание NAT, благодаря которому один общедоступный IP-адрес может представлять большое количество частных IP-адресов (частную интрасеть).</span><span class="sxs-lookup"><span data-stu-id="75707-114">One of several techniques used to extend the lifetime of IPv4 has been to deploy NAT to allow a single unique public IP address to represent a large number of private IP addresses (private Intranet).</span></span> <span data-ttu-id="75707-115">Частные IP-адреса, находящиеся за устройством NAT, соответствуют одному и тому же общедоступному IP-адресу IPv4.</span><span class="sxs-lookup"><span data-stu-id="75707-115">The private IP addresses behind the NAT device share the single public IPv4 address.</span></span> <span data-ttu-id="75707-116">В качестве устройства NAT может использоваться специализированное аппаратное устройство (например, точка беспроводного доступа и маршрутизатор) или компьютер, на котором запущена служба NAT.</span><span class="sxs-lookup"><span data-stu-id="75707-116">The NAT device may be a dedicated hardware device (an inexpensive Wireless Access Point and router, for example) or a computer running a service to provide NAT.</span></span> <span data-ttu-id="75707-117">Устройство или служба для этого общедоступного IP-адреса преобразует сетевые пакеты IP между общедоступным Интернетом и частной интрасетью.</span><span class="sxs-lookup"><span data-stu-id="75707-117">A device or service for this public IP address translates IP network packets between the public Internet and the private Intranet.</span></span>  
  
 <span data-ttu-id="75707-118">Эта схема подходит для клиентских приложений в частной интрасети, которые отправляют запросы к другим IP-адресам (обычно серверам) в Интернете.</span><span class="sxs-lookup"><span data-stu-id="75707-118">This scheme works well for client applications running on the private Intranet that send requests to other IP addresses (usually servers) on the Internet.</span></span> <span data-ttu-id="75707-119">Устройство NAT или сервер может содержать сведения о сопоставлении клиентских запросов, чтобы при получении ответа определить место назначения для этого ответа.</span><span class="sxs-lookup"><span data-stu-id="75707-119">The NAT device or server can keep a mapping of client requests so when a response is returned it knows where to send the response.</span></span> <span data-ttu-id="75707-120">Однако эта схема создает проблемы для приложений, работающих в частной интрасети за устройством NAT, которым необходимо предоставлять службы, прослушивать пакеты и отправлять ответы.</span><span class="sxs-lookup"><span data-stu-id="75707-120">But this scheme poses problems for applications running in the private Intranet behind the NAT device that want to provide services, listen for packets, and respond.</span></span> <span data-ttu-id="75707-121">Это особенно актуально в случае с одноранговыми приложениями.</span><span class="sxs-lookup"><span data-stu-id="75707-121">This is particularly the case for peer-to-peer applications.</span></span>  
  
 <span data-ttu-id="75707-122">В протоколе IPv6 длина адреса IPv4 составляет 128 бит.</span><span class="sxs-lookup"><span data-stu-id="75707-122">The IPv6 protocol defined an IPv4 address as 128 bits long.</span></span> <span data-ttu-id="75707-123">Поэтому протокол IPv6 поддерживает очень большое количество IP-адресов — 3.2x10 в 38-й степени уникальных адресов (2 в 128-й степени).</span><span class="sxs-lookup"><span data-stu-id="75707-123">As a result, IPv6 supports very a large IP address space of 3.2 x 10^38 unique addresses (2^128).</span></span> <span data-ttu-id="75707-124">С адресным пространством такого размера можно предоставить уникальный адрес для каждого устройства, подключенного к Интернету.</span><span class="sxs-lookup"><span data-stu-id="75707-124">With an address space of this size, it is possible for every device connected to the Internet to be given a unique address.</span></span> <span data-ttu-id="75707-125">Но существуют проблемы.</span><span class="sxs-lookup"><span data-stu-id="75707-125">But there are problems.</span></span> <span data-ttu-id="75707-126">На большей части компьютеров во всем мире все еще используются только адреса IPv4.</span><span class="sxs-lookup"><span data-stu-id="75707-126">Much of the world is still using only IPv4.</span></span> <span data-ttu-id="75707-127">В частности, многие из существующих маршрутизаторов и точек беспроводного доступа, которые используются в небольших организациях и дома, не поддерживают IPv6.</span><span class="sxs-lookup"><span data-stu-id="75707-127">In particular, many of the existing routers and wireless access points used by small companies, organizations, and households do not support IPv6.</span></span> <span data-ttu-id="75707-128">Также некоторые поставщики услуг Интернета, которые обслуживают этих клиентов, не поддерживают IPv6 либо у них не настроена поддержка IPv6.</span><span class="sxs-lookup"><span data-stu-id="75707-128">Also some Internet service providers that serve these customers either do not support or have not configured support for IPv6.</span></span>  
  
 <span data-ttu-id="75707-129">Было разработано несколько технологий туннелирования адресов IPv6 в пакет IPv4.</span><span class="sxs-lookup"><span data-stu-id="75707-129">Several IPv6 transition technologies have been developed to tunnel IPv6 addresses in an IPv4 packet.</span></span> <span data-ttu-id="75707-130">Эти технологии включают 6to4, ISATAP и туннели Teredo, которые предоставляют назначение адресов и автоматическое туннелирование одноадресного трафика IPv6 между узлами, при котором узлы IPv6 должны проходить по сетям IPv4, чтобы достичь других сетей IPv6.</span><span class="sxs-lookup"><span data-stu-id="75707-130">These technologies include 6to4, ISATAP, and Teredo tunnels that provide address assignment and host-to-host automatic tunneling for unicast IPv6 traffic when IPv6 hosts must traverse IP4 networks to reach other IPv6 networks.</span></span> <span data-ttu-id="75707-131">Пакеты IPv6 отправляются c туннелированием в пакетах IPv4.</span><span class="sxs-lookup"><span data-stu-id="75707-131">IPv6 packets are sent tunneled as IPv4 packets.</span></span> <span data-ttu-id="75707-132">Существует несколько методов туннелирования, которые позволяют обойти NAT для адресов IPv6 через устройство NAT.</span><span class="sxs-lookup"><span data-stu-id="75707-132">Several tunneling techniques are being used that allow NAT traversal for IPv6 addresses through a NAT device.</span></span>  
  
 <span data-ttu-id="75707-133">Teredo — одна из технологий туннелирования IPv6, которая позволяет использовать адреса IPv6 в сетях IPv4.</span><span class="sxs-lookup"><span data-stu-id="75707-133">Teredo is one of the IPv6 transition technologies which brings IPv6 connectivity to IPv4 networks.</span></span> <span data-ttu-id="75707-134">Спецификация Teredo приведена в стандарте RFC 4380, опубликованном IETF.</span><span class="sxs-lookup"><span data-stu-id="75707-134">Teredo is documented in RFC 4380 published by the Internet Engineering Task Force (IETF).</span></span> <span data-ttu-id="75707-135">В Windows XP с пакетом обновления 2 (SP2) и более поздней версии поддерживается виртуальный адаптер Teredo, который позволяет получить общедоступный адрес IPv6 в диапазоне 2001:0::/32.</span><span class="sxs-lookup"><span data-stu-id="75707-135">Windows XP SP2 and later provide support for a virtual Teredo adapter which can provide a public IPv6 address in the range 2001:0::/32.</span></span> <span data-ttu-id="75707-136">Этот адрес IPv6 можно использовать для прослушивания входящих подключений из Интернета. Его можно предоставить клиентам с поддержкой IPv6, которые хотят подключиться к службе прослушивания.</span><span class="sxs-lookup"><span data-stu-id="75707-136">This IPv6 address can be used to listen for incoming connections from the Internet and can be provided to IPv6 enabled clients that wish to connect to the listening service.</span></span> <span data-ttu-id="75707-137">Это позволяет приложению не беспокоиться об адресации компьютера за устройством NAT, так как приложение может просто подключиться к нему по адресу IPv6 Teredo.</span><span class="sxs-lookup"><span data-stu-id="75707-137">This frees an application from worrying about how to address a computer behind a NAT device, since the application can just connect to it using its IPv6 Teredo address.</span></span>  
  
## <a name="enhancements-to-support-nat-traversal-and-teredo"></a><span data-ttu-id="75707-138">Улучшения поддержки обхода NAT и Teredo</span><span class="sxs-lookup"><span data-stu-id="75707-138">Enhancements to Support NAT Traversal and Teredo</span></span>  

 <span data-ttu-id="75707-139">В пространства имен <xref:System.Net>, <xref:System.Net.NetworkInformation> и <xref:System.Net.Sockets> добавлены улучшения для поддержки обхода преобразования сетевых адресов (NAT) с помощью IPv6 и Teredo.</span><span class="sxs-lookup"><span data-stu-id="75707-139">Enhancements are added to the <xref:System.Net>, <xref:System.Net.NetworkInformation>, and <xref:System.Net.Sockets> namespaces for supporting NAT traversal using IPv6 and Teredo.</span></span>  
  
 <span data-ttu-id="75707-140">В класс <xref:System.Net.NetworkInformation.IPGlobalProperties?displayProperty=nameWithType> добавлены несколько методов для получения списка IP-адресов одноадресной рассылки на узле.</span><span class="sxs-lookup"><span data-stu-id="75707-140">Several methods are added to the <xref:System.Net.NetworkInformation.IPGlobalProperties?displayProperty=nameWithType> class to get the list of unicast IP addresses on the host.</span></span> <span data-ttu-id="75707-141">Метод <xref:System.Net.NetworkInformation.IPGlobalProperties.BeginGetUnicastAddresses%2A> отправляет асинхронный запрос для получения таблицы стабильных IP-адресов одноадресной рассылки на локальном компьютере.</span><span class="sxs-lookup"><span data-stu-id="75707-141">The <xref:System.Net.NetworkInformation.IPGlobalProperties.BeginGetUnicastAddresses%2A> method begins an asynchronous request to retrieve the stable unicast IP address table on the local computer.</span></span> <span data-ttu-id="75707-142">Метод <xref:System.Net.NetworkInformation.IPGlobalProperties.EndGetUnicastAddresses%2A> завершает ожидающий асинхронный запрос для получения таблицы стабильных IP-адресов одноадресной рассылки на локальном компьютере.</span><span class="sxs-lookup"><span data-stu-id="75707-142">The <xref:System.Net.NetworkInformation.IPGlobalProperties.EndGetUnicastAddresses%2A> method ends a pending asynchronous request to retrieve the stable unicast IP address table on the local computer.</span></span> <span data-ttu-id="75707-143">Метод <xref:System.Net.NetworkInformation.IPGlobalProperties.GetUnicastAddresses%2A> отправляет синхронный запрос на получение таблицы стабильных IP-адресов одноадресной рассылки на локальном компьютере, при необходимости ожидая, пока таблица стабилизируется.</span><span class="sxs-lookup"><span data-stu-id="75707-143">The <xref:System.Net.NetworkInformation.IPGlobalProperties.GetUnicastAddresses%2A> method is a synchronous request to retrieve the stable unicast IP address table on the local computer, waiting until the address table stabilizes if necessary.</span></span>  
  
 <span data-ttu-id="75707-144">Чтобы определить, является ли <xref:System.Net.IPAddress> IP-адресом IPv6 Teredo, можно использовать свойство <xref:System.Net.IPAddress.IsIPv6Teredo%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="75707-144">The <xref:System.Net.IPAddress.IsIPv6Teredo%2A?displayProperty=nameWithType> property can be used to determine if an <xref:System.Net.IPAddress> is an IPv6 Teredo address.</span></span>  
  
 <span data-ttu-id="75707-145">Используя эти новые методы класса <xref:System.Net.NetworkInformation.IPGlobalProperties> в сочетании со свойством <xref:System.Net.IPAddress.IsIPv6Teredo%2A>, приложение может легко определить адрес Teredo.</span><span class="sxs-lookup"><span data-stu-id="75707-145">Using these new <xref:System.Net.NetworkInformation.IPGlobalProperties> class methods in combination with the <xref:System.Net.IPAddress.IsIPv6Teredo%2A> property allows an application to easily find the Teredo address.</span></span> <span data-ttu-id="75707-146">Для связи с удаленными приложениями приложению обычно необходим только локальный адрес Teredo.</span><span class="sxs-lookup"><span data-stu-id="75707-146">An application normally only needs to know the local Teredo address if it is communicating this information to remote applications.</span></span> <span data-ttu-id="75707-147">Например, одноранговое приложение может отправлять все IP-адреса IPv6 координирующему серверу, который затем может перенаправлять их другим одноранговым узлам для прямого взаимодействия.</span><span class="sxs-lookup"><span data-stu-id="75707-147">For example, a peer-to-peer application might send all of its IPv6 addresses to a matchmaking server which can then forward them to others peers to enable direct communication.</span></span>  
  
 <span data-ttu-id="75707-148">В службе прослушивания приложения необходимо настроить прослушивание <xref:System.Net.IPAddress.IPv6Any?displayProperty=nameWithType>, а не локального адреса Teredo.</span><span class="sxs-lookup"><span data-stu-id="75707-148">An application should normally set its listening service to listen on <xref:System.Net.IPAddress.IPv6Any?displayProperty=nameWithType> rather than on the local Teredo address.</span></span> <span data-ttu-id="75707-149">Это позволит удаленному клиенту или одноранговому узлу, у которого есть прямой маршрут IPv6 для службы прослушивания, подключиться напрямую с помощью протокола IPv6 и не использовать Teredo для туннелирования пакетов.</span><span class="sxs-lookup"><span data-stu-id="75707-149">So if a remote client or peer has a direct IPv6 route to the host of the listening service, the client or peer can connect directly using IPv6 and not have to use Teredo to tunnel packets.</span></span>  
  
 <span data-ttu-id="75707-150">Для включения обхода NAT в приложениях TCP используется метод <xref:System.Net.Sockets.TcpListener.AllowNatTraversal%2A> класса <xref:System.Net.Sockets.TcpListener?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="75707-150">For TCP applications, the <xref:System.Net.Sockets.TcpListener?displayProperty=nameWithType> class has an <xref:System.Net.Sockets.TcpListener.AllowNatTraversal%2A> method to enable NAT traversal.</span></span> <span data-ttu-id="75707-151">Для включения обхода NAT в приложениях UDP используется метод <xref:System.Net.Sockets.UdpClient.AllowNatTraversal%2A> класса <xref:System.Net.Sockets.UdpClient?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="75707-151">For UDP applications, the <xref:System.Net.Sockets.UdpClient?displayProperty=nameWithType> class has an <xref:System.Net.Sockets.UdpClient.AllowNatTraversal%2A> method to enable NAT traversal.</span></span>  
  
 <span data-ttu-id="75707-152">Для отправки запросов для обхода NAT, а также для включения или отключения обхода NAT в приложениях, в которых используется класс <xref:System.Net.Sockets.Socket?displayProperty=nameWithType> и связанные классы, можно использовать методы <xref:System.Net.Sockets.Socket.GetSocketOption%2A> и <xref:System.Net.Sockets.Socket.SetSocketOption%2A> с параметром сокета <xref:System.Net.Sockets.SocketOptionName.IPProtectionLevel?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="75707-152">For applications that use the <xref:System.Net.Sockets.Socket?displayProperty=nameWithType> and related classes, the <xref:System.Net.Sockets.Socket.GetSocketOption%2A> and <xref:System.Net.Sockets.Socket.SetSocketOption%2A> methods can be used with the <xref:System.Net.Sockets.SocketOptionName.IPProtectionLevel?displayProperty=nameWithType> socket option to query, enable, or disable NAT traversal.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="75707-153">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="75707-153">See also</span></span>

- <xref:System.Net.IPAddress.IsIPv6Teredo%2A?displayProperty=nameWithType>
- <xref:System.Net.NetworkInformation.IPGlobalProperties.BeginGetUnicastAddresses%2A?displayProperty=nameWithType>
- <xref:System.Net.NetworkInformation.IPGlobalProperties.EndGetUnicastAddresses%2A?displayProperty=nameWithType>
- <xref:System.Net.NetworkInformation.IPGlobalProperties.GetUnicastAddresses%2A?displayProperty=nameWithType>
- <xref:System.Net.Sockets.IPProtectionLevel?displayProperty=nameWithType>
- <xref:System.Net.Sockets.Socket.SetIPProtectionLevel%2A?displayProperty=nameWithType>
- <xref:System.Net.Sockets.TcpListener.AllowNatTraversal%2A?displayProperty=nameWithType>
- <xref:System.Net.Sockets.UdpClient.AllowNatTraversal%2A?displayProperty=nameWithType>
