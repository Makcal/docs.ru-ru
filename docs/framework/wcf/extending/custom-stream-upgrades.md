---
description: 'Дополнительные сведения: настраиваемые обновления потока'
title: Пользовательские обновления потоков
ms.date: 03/30/2017
ms.assetid: e3da85c8-57f3-4e32-a4cb-50123f30fea6
ms.openlocfilehash: fe52b99de382d5a5d5b41a0bff2c4a9a7698f6f5
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99735248"
---
# <a name="custom-stream-upgrades"></a><span data-ttu-id="0827e-103">Пользовательские обновления потоков</span><span class="sxs-lookup"><span data-stu-id="0827e-103">Custom Stream Upgrades</span></span>

<span data-ttu-id="0827e-104">Ориентированные на потоки виды транспорта, например TCP и именованные каналы, работают с непрерывным потоком данных, установленным между клиентом и сервером.</span><span class="sxs-lookup"><span data-stu-id="0827e-104">Stream-oriented transports such as TCP and Named Pipes operate on a continuous stream of bytes between the client and server.</span></span> <span data-ttu-id="0827e-105">Поток реализуется объектом <xref:System.IO.Stream>.</span><span class="sxs-lookup"><span data-stu-id="0827e-105">This stream is realized by a  <xref:System.IO.Stream> object.</span></span> <span data-ttu-id="0827e-106">при обновлении потока клиенту требуется добавить дополнительный уровень протокола в стек каналов и он отправляет соответствующий запрос другому участнику коммуникационного канала.</span><span class="sxs-lookup"><span data-stu-id="0827e-106">In a stream upgrade, the client wants to add an optional protocol layer to the channel stack, and asks the other end of the communication channel to do so.</span></span> <span data-ttu-id="0827e-107">Обновление канала предполагает замену исходного объекта <xref:System.IO.Stream> на обновленный.</span><span class="sxs-lookup"><span data-stu-id="0827e-107">The stream upgrade consists in replacing the original <xref:System.IO.Stream> object with an upgraded one.</span></span>  
  
 <span data-ttu-id="0827e-108">Например, можно создать поток сжатия непосредственно поверх транспортного потока.</span><span class="sxs-lookup"><span data-stu-id="0827e-108">For example, you can build a compression stream directly on top of the transport stream.</span></span> <span data-ttu-id="0827e-109">В этом случае исходный транспортный поток <xref:System.IO.Stream> заменяется потоком, который выступает в роли оболочки потока <xref:System.IO.Stream> сжатия вокруг исходного потока.</span><span class="sxs-lookup"><span data-stu-id="0827e-109">In this case the original transport <xref:System.IO.Stream> is replaced with one that wraps the compression <xref:System.IO.Stream> around the original one.</span></span>  
  
 <span data-ttu-id="0827e-110">Можно применить несколько обновлений потоков, каждое из которых будет служить оболочкой для предыдущего.</span><span class="sxs-lookup"><span data-stu-id="0827e-110">You can apply multiple stream upgrades, each wrapping the preceding one.</span></span>  
  
## <a name="how-stream-upgrades-work"></a><span data-ttu-id="0827e-111">Принципы работы обновления потока</span><span class="sxs-lookup"><span data-stu-id="0827e-111">How Stream Upgrades Work</span></span>  

 <span data-ttu-id="0827e-112">Имеется четыре компонента процесса обновления потока.</span><span class="sxs-lookup"><span data-stu-id="0827e-112">There are four components to the stream upgrade process.</span></span>  
  
1. <span data-ttu-id="0827e-113">*Инициатор* потока обновления начинает процесс: во время выполнения он может инициировать запрос к другому концу соединения, чтобы обновить уровень транспорта канала.</span><span class="sxs-lookup"><span data-stu-id="0827e-113">An upgrade stream *Initiator* begins the process: at run-time it can initiate a request to the other end of its connection to upgrade the channel transport layer.</span></span>  
  
2. <span data-ttu-id="0827e-114">*Принимающий* поток обновления выполняет обновление: во время выполнения он получает запрос на обновление от другого компьютера, и, если возможно, принимает обновление.</span><span class="sxs-lookup"><span data-stu-id="0827e-114">An upgrade stream *Acceptor* carries out the upgrade: at run-time it receives the upgrade request from the other machine, and if possible, accepts the upgrade.</span></span>  
  
3. <span data-ttu-id="0827e-115">*Поставщик* обновления создает *инициатор* на клиенте *и на сервере* .</span><span class="sxs-lookup"><span data-stu-id="0827e-115">An upgrade *Provider* creates the *Initiator* on the client and the *Acceptor* on the server.</span></span>  
  
4. <span data-ttu-id="0827e-116">*Элемент привязки* обновления потока добавляется к привязкам в службе и клиенту и создает поставщик во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="0827e-116">A stream upgrade *Binding Element* is added to the bindings on the service and the client, and creates the provider at runtime.</span></span>  
  
 <span data-ttu-id="0827e-117">Обратите внимание, что в случае нескольких обновлений инициатор и акцептор инкапсулируют конечные автоматы для определения переходов обновления, которые являются допустимыми для каждой инициации.</span><span class="sxs-lookup"><span data-stu-id="0827e-117">Note that in the case of multiple upgrades, the Initiator and Acceptor encapsulate state machines to enforce which upgrade transitions are valid for each Initiation.</span></span>  
  
## <a name="how-to-implement-a-stream-upgrade"></a><span data-ttu-id="0827e-118">Реализация обновления потока</span><span class="sxs-lookup"><span data-stu-id="0827e-118">How to Implement a Stream Upgrade</span></span>  

 <span data-ttu-id="0827e-119">Windows Communication Foundation (WCF) предоставляет четыре `abstract` класса, которые можно реализовать:</span><span class="sxs-lookup"><span data-stu-id="0827e-119">Windows Communication Foundation (WCF) provides four `abstract` classes that you can implement:</span></span>  
  
- <xref:System.ServiceModel.Channels.StreamUpgradeInitiator?displayProperty=nameWithType>  
  
- <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor?displayProperty=nameWithType>  
  
- <xref:System.ServiceModel.Channels.StreamUpgradeProvider?displayProperty=nameWithType>  
  
- <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement?displayProperty=nameWithType>  
  
 <span data-ttu-id="0827e-120">Чтобы реализовать пользовательское обновление потока, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="0827e-120">To implement a custom stream upgrade, do the following.</span></span> <span data-ttu-id="0827e-121">Ниже приведена процедура минимального обновления потока на клиентском и сервером компьютерах.</span><span class="sxs-lookup"><span data-stu-id="0827e-121">This procedure implements a minimal stream upgrade process on both the client and server machines.</span></span>  
  
1. <span data-ttu-id="0827e-122">Создайте класс, реализующий <xref:System.ServiceModel.Channels.StreamUpgradeInitiator>.</span><span class="sxs-lookup"><span data-stu-id="0827e-122">Create a class that implements <xref:System.ServiceModel.Channels.StreamUpgradeInitiator>.</span></span>  
  
    1. <span data-ttu-id="0827e-123">Переопределите метод <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.InitiateUpgrade%2A>, чтобы он принимал обновляемый поток и возвращал обновленный поток.</span><span class="sxs-lookup"><span data-stu-id="0827e-123">Override the <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.InitiateUpgrade%2A> method to take in the stream to be upgraded, and return the upgraded stream.</span></span> <span data-ttu-id="0827e-124">Этот метод работает синхронно; имеются аналогичные методы для асинхронной инициации обновления.</span><span class="sxs-lookup"><span data-stu-id="0827e-124">This method works synchronously; there are analogous methods to initiate the upgrade asynchronously.</span></span>  
  
    2. <span data-ttu-id="0827e-125">Переопределите метод <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A>, чтобы он проверял на необходимость дополнительных обновлений.</span><span class="sxs-lookup"><span data-stu-id="0827e-125">Override the <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A> method to check for additional upgrades.</span></span>  
  
2. <span data-ttu-id="0827e-126">Создайте класс, реализующий <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor>.</span><span class="sxs-lookup"><span data-stu-id="0827e-126">Create a class that implements <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor>.</span></span>  
  
    1. <span data-ttu-id="0827e-127">Переопределите метод <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.AcceptUpgrade%2A>, чтобы он принимал обновляемый поток и возвращал обновленный поток.</span><span class="sxs-lookup"><span data-stu-id="0827e-127">Override the <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.AcceptUpgrade%2A> method to take in the stream to be upgraded, and return the upgraded stream.</span></span> <span data-ttu-id="0827e-128">Этот метод работает синхронно; имеются аналогичные методы для асинхронного принятия обновления.</span><span class="sxs-lookup"><span data-stu-id="0827e-128">This method works synchronously; there are analogous methods to accept the upgrade asynchronously.</span></span>  
  
    2. <span data-ttu-id="0827e-129">Переопределите метод <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A>, чтобы он проверял, поддерживается ли запрошенное обновление текущим акцептором обновления в данной точке процесса обновления.</span><span class="sxs-lookup"><span data-stu-id="0827e-129">Override the <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A> method to determine if the upgrade requested is supported by this upgrade acceptor at this point in the upgrade process.</span></span>  
  
3. <span data-ttu-id="0827e-130">Создайте класс, реализующий <xref:System.ServiceModel.Channels.StreamUpgradeProvider>.</span><span class="sxs-lookup"><span data-stu-id="0827e-130">Create a class the implements <xref:System.ServiceModel.Channels.StreamUpgradeProvider>.</span></span> <span data-ttu-id="0827e-131">Переопределите методы <xref:System.ServiceModel.Channels.StreamUpgradeProvider.CreateUpgradeAcceptor%2A> и <xref:System.ServiceModel.Channels.StreamUpgradeProvider.CreateUpgradeInitiator%2A>, чтобы они возвращали экземпляры акцептора и инициатора, определенные на шагах 2 и 1.</span><span class="sxs-lookup"><span data-stu-id="0827e-131">Override the <xref:System.ServiceModel.Channels.StreamUpgradeProvider.CreateUpgradeAcceptor%2A> and the <xref:System.ServiceModel.Channels.StreamUpgradeProvider.CreateUpgradeInitiator%2A> methods to return instances of the acceptor and initiator defined in steps 2 and 1.</span></span>  
  
4. <span data-ttu-id="0827e-132">Создайте класс, реализующий <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement>.</span><span class="sxs-lookup"><span data-stu-id="0827e-132">Create a class that implements <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement>.</span></span>  
  
    1. <span data-ttu-id="0827e-133">Переопределите метод <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement.BuildClientStreamUpgradeProvider%2A> клиента и метод <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement.BuildServerStreamUpgradeProvider%2A> службы.</span><span class="sxs-lookup"><span data-stu-id="0827e-133">Override the <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement.BuildClientStreamUpgradeProvider%2A> method on the client and the <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement.BuildServerStreamUpgradeProvider%2A> method on the service.</span></span>  
  
    2. <span data-ttu-id="0827e-134">Переопределите метод <xref:System.ServiceModel.Channels.BindingElement.BuildChannelFactory%2A> клиента и метод <xref:System.ServiceModel.Channels.BindingElement.BuildChannelListener%2A> службы, чтобы добавлять в свойство <xref:System.ServiceModel.Channels.BindingContext.BindingParameters%2A> элемент привязки обновления.</span><span class="sxs-lookup"><span data-stu-id="0827e-134">Override the <xref:System.ServiceModel.Channels.BindingElement.BuildChannelFactory%2A> method on the client and the <xref:System.ServiceModel.Channels.BindingElement.BuildChannelListener%2A> method on the service to add the upgrade Binding Element to <xref:System.ServiceModel.Channels.BindingContext.BindingParameters%2A>.</span></span>  
  
5. <span data-ttu-id="0827e-135">Добавьте новый элемент привязки обновления потока в привязки на клиентском и серверном компьютерах.</span><span class="sxs-lookup"><span data-stu-id="0827e-135">Add the new stream upgrade binding element to bindings on the server and client machines.</span></span>  
  
## <a name="security-upgrades"></a><span data-ttu-id="0827e-136">Обновления системы безопасности</span><span class="sxs-lookup"><span data-stu-id="0827e-136">Security Upgrades</span></span>  

 <span data-ttu-id="0827e-137">Добавление обновления системы безопасности представляет собой специальную версию общего процесса обновления потока.</span><span class="sxs-lookup"><span data-stu-id="0827e-137">Adding a security upgrade is a specialized version of the general stream upgrade process.</span></span>  
  
 <span data-ttu-id="0827e-138">В WCF уже есть два элемента привязки для обновления системы безопасности потоков.</span><span class="sxs-lookup"><span data-stu-id="0827e-138">WCF already provides two binding elements for upgrading stream security.</span></span> <span data-ttu-id="0827e-139">Конфигурация безопасности транспортного уровня инкапсулируется в элементах <xref:System.ServiceModel.Channels.WindowsStreamSecurityBindingElement> и <xref:System.ServiceModel.Channels.SslStreamSecurityBindingElement>, которые можно настроить и добавить в пользовательскую привязку.</span><span class="sxs-lookup"><span data-stu-id="0827e-139">The configuration of transport-level security is encapsulated by the <xref:System.ServiceModel.Channels.WindowsStreamSecurityBindingElement> and the <xref:System.ServiceModel.Channels.SslStreamSecurityBindingElement> which can be configured and added to a custom binding.</span></span> <span data-ttu-id="0827e-140">Эти элементы привязки расширяют класс <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement>, создающий поставщики обновления потока клиента и сервера.</span><span class="sxs-lookup"><span data-stu-id="0827e-140">These binding elements extend the <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement> class that builds the client and server stream upgrade providers.</span></span> <span data-ttu-id="0827e-141">У этих элементов привязки имеются методы, создающие специальные классы поставщиков обновления системы безопасности потоков, которые не являются `public`, поэтому в этих двух случаях достаточно просто добавить элемент привязки в привязку.</span><span class="sxs-lookup"><span data-stu-id="0827e-141">These binding elements have methods that create the specialized security stream upgrade provider classes, which are not `public`, so for these two cases all you need to do is to add the binding element to the binding.</span></span>  
  
 <span data-ttu-id="0827e-142">Для сценариев обеспечения безопасности, не реализуемых с помощью описанных выше двух элементов привязки, от вышеупомянутых базовых классов инициатора, акцептора и поставщика наследуются три класса `abstract`, связанных с обеспечением безопасности:</span><span class="sxs-lookup"><span data-stu-id="0827e-142">For security scenarios not met by the above two binding elements, three security-related `abstract` classes are derived from the above initiator, acceptor and provider base classes:</span></span>  
  
1. <xref:System.ServiceModel.Channels.StreamSecurityUpgradeInitiator?displayProperty=nameWithType>  
  
2. <xref:System.ServiceModel.Channels.StreamSecurityUpgradeAcceptor?displayProperty=nameWithType>  
  
3. <xref:System.ServiceModel.Channels.StreamSecurityUpgradeProvider?displayProperty=nameWithType>  
  
 <span data-ttu-id="0827e-143">Процесс реализации обновления безопасности потока такой же, как и раньше, лишь с тем отличием, что наследование выполняется от этих трех классов.</span><span class="sxs-lookup"><span data-stu-id="0827e-143">The process of implementing a security stream upgrade is the same as before, with the difference that you would derive from these three classes.</span></span> <span data-ttu-id="0827e-144">Переопределите дополнительные свойства в этих классах, чтобы предоставить среде выполнения сведения о безопасности.</span><span class="sxs-lookup"><span data-stu-id="0827e-144">Override the additional properties in these classes to supply security information to the runtime.</span></span>  
  
## <a name="multiple-upgrades"></a><span data-ttu-id="0827e-145">Несколько обновлений</span><span class="sxs-lookup"><span data-stu-id="0827e-145">Multiple Upgrades</span></span>  

 <span data-ttu-id="0827e-146">Чтобы создать дополнительные запросы на обновление, повторите описанный выше процесс: создайте дополнительные расширения поставщика <xref:System.ServiceModel.Channels.StreamUpgradeProvider> и элементы привязки.</span><span class="sxs-lookup"><span data-stu-id="0827e-146">To create additional upgrade requests repeat the above process: create additional extensions of <xref:System.ServiceModel.Channels.StreamUpgradeProvider> and binding elements.</span></span> <span data-ttu-id="0827e-147">Добавьте в привязку элементы привязки.</span><span class="sxs-lookup"><span data-stu-id="0827e-147">Add the binding elements to the binding.</span></span> <span data-ttu-id="0827e-148">Дополнительные элементы привязки обрабатываться последовательно, начиная с первого элемента привязки, добавленного в привязку.</span><span class="sxs-lookup"><span data-stu-id="0827e-148">The additional binding elements are processed sequentially, starting with the first binding element added to the binding.</span></span> <span data-ttu-id="0827e-149">В методах <xref:System.ServiceModel.Channels.BindingElement.BuildChannelFactory%2A> и <xref:System.ServiceModel.Channels.BindingElement.BuildChannelListener%2A> каждый поставщик обновления может определять, как расположить себя относительно существующих параметров привязки обновления.</span><span class="sxs-lookup"><span data-stu-id="0827e-149">In <xref:System.ServiceModel.Channels.BindingElement.BuildChannelFactory%2A> and <xref:System.ServiceModel.Channels.BindingElement.BuildChannelListener%2A> each upgrade provider can determine how to layer itself on any pre-existing upgrade binding parameters.</span></span> <span data-ttu-id="0827e-150">В этом случае он должен заменить существующий параметр привязки обновления на новый составной параметр привязки обновления.</span><span class="sxs-lookup"><span data-stu-id="0827e-150">It should then replace the existing upgrade binding parameter with a new composite upgrade binding parameter.</span></span>  
  
 <span data-ttu-id="0827e-151">Кроме того, один поставщик обновления может поддерживать несколько обновлений.</span><span class="sxs-lookup"><span data-stu-id="0827e-151">Alternatively, one upgrade provider can support multiple upgrades.</span></span> <span data-ttu-id="0827e-152">Например, может потребоваться реализовать пользовательский поставщик обновления потока, который поддерживает как безопасность, так и сжатие.</span><span class="sxs-lookup"><span data-stu-id="0827e-152">For example, you might want to implement a custom stream upgrade provider that supports both security and compression.</span></span> <span data-ttu-id="0827e-153">Выполните следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="0827e-153">Do the following steps:</span></span>  
  
1. <span data-ttu-id="0827e-154">На основе класса <xref:System.ServiceModel.Channels.StreamSecurityUpgradeProvider> создайте класс поставщика, который создает инициатор и акцептор.</span><span class="sxs-lookup"><span data-stu-id="0827e-154">Subclass <xref:System.ServiceModel.Channels.StreamSecurityUpgradeProvider> to write the provider class that creates the Initiator and Acceptor.</span></span>  
  
2. <span data-ttu-id="0827e-155">Создайте подкласс <xref:System.ServiceModel.Channels.StreamSecurityUpgradeInitiator>, переопределив метод <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A>, чтобы он возвращал типы содержимого для потока сжатия и потока защиты в нужном порядке.</span><span class="sxs-lookup"><span data-stu-id="0827e-155">Subclass the <xref:System.ServiceModel.Channels.StreamSecurityUpgradeInitiator> making sure to override the <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A> method to return the content types for the compression stream and the secure stream in order.</span></span>  
  
3. <span data-ttu-id="0827e-156">Создайте подкласс <xref:System.ServiceModel.Channels.StreamSecurityUpgradeAcceptor>, метод <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A> которого может распознавать пользовательские типы содержимого.</span><span class="sxs-lookup"><span data-stu-id="0827e-156">Subclass the <xref:System.ServiceModel.Channels.StreamSecurityUpgradeAcceptor> that understands the custom content types in its <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A> method.</span></span>  
  
4. <span data-ttu-id="0827e-157">Поток будет обновляться после каждого вызова методов <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A> и <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A>.</span><span class="sxs-lookup"><span data-stu-id="0827e-157">The stream will be upgraded after each call to <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A> and <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A>.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="0827e-158">См. также</span><span class="sxs-lookup"><span data-stu-id="0827e-158">See also</span></span>

- <xref:System.ServiceModel.Channels.StreamUpgradeInitiator>
- <xref:System.ServiceModel.Channels.StreamSecurityUpgradeInitiator>
- <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor>
- <xref:System.ServiceModel.Channels.StreamSecurityUpgradeAcceptor>
- <xref:System.ServiceModel.Channels.StreamUpgradeProvider>
- <xref:System.ServiceModel.Channels.StreamSecurityUpgradeProvider>
- <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement>
- <xref:System.ServiceModel.Channels.SslStreamSecurityBindingElement>
- <xref:System.ServiceModel.Channels.WindowsStreamSecurityBindingElement>
