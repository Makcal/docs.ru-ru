---
description: Дополнительные сведения о том, как создать федеративный клиент.
title: Практическое руководство. Создание федеративного клиента
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, federation
- federation
ms.assetid: 56ece47e-98bf-4346-b92b-fda1fc3b4d9c
ms.openlocfilehash: 0078a07ff23dd364dcb8513a55e4ea6a54df40db
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99734742"
---
# <a name="how-to-create-a-federated-client"></a><span data-ttu-id="cec73-103">Практическое руководство. Создание федеративного клиента</span><span class="sxs-lookup"><span data-stu-id="cec73-103">How to: Create a Federated Client</span></span>

<span data-ttu-id="cec73-104">В Windows Communication Foundation (WCF) создание клиента для *федеративной службы* состоит из трех основных этапов:</span><span class="sxs-lookup"><span data-stu-id="cec73-104">In Windows Communication Foundation (WCF), creating a client for a *federated service* consists of three main steps:</span></span>  
  
1. <span data-ttu-id="cec73-105">Настройте [\<wsFederationHttpBinding>](../../configure-apps/file-schema/wcf/wsfederationhttpbinding.md) или аналогичную пользовательскую привязку.</span><span class="sxs-lookup"><span data-stu-id="cec73-105">Configure a [\<wsFederationHttpBinding>](../../configure-apps/file-schema/wcf/wsfederationhttpbinding.md) or similar custom binding.</span></span> <span data-ttu-id="cec73-106">Дополнительные сведения о создании подходящей привязки см. в разделе [инструкции. Создание WSFederationHttpBinding](how-to-create-a-wsfederationhttpbinding.md).</span><span class="sxs-lookup"><span data-stu-id="cec73-106">For more information about creating an appropriate binding, see [How to: Create a WSFederationHttpBinding](how-to-create-a-wsfederationhttpbinding.md).</span></span> <span data-ttu-id="cec73-107">Кроме того, запустите [служебную программу метаданных ServiceModel (Svcutil.exe)](../servicemodel-metadata-utility-tool-svcutil-exe.md) в конечной точке метаданных федеративной службы, чтобы создать файл конфигурации для взаимодействия с федеративной службой и одной или нескольких служб маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="cec73-107">Alternatively, run the [ServiceModel Metadata Utility Tool (Svcutil.exe)](../servicemodel-metadata-utility-tool-svcutil-exe.md) against the metadata endpoint of the federated service to generate a configuration file for communicating with the federated service and one or more security token services.</span></span>  
  
2. <span data-ttu-id="cec73-108">Задайте свойства <xref:System.ServiceModel.Security.IssuedTokenClientCredential>, управляющие различными аспектами взаимодействия клиента со службой маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="cec73-108">Set the properties of the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> that controls various aspects of a client's interaction with a security token service.</span></span>  
  
3. <span data-ttu-id="cec73-109">Задайте свойства <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential>, разрешающие сертификаты, необходимые для безопасного обмена данными с определенными конечными точками, такими как служба маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="cec73-109">Set the properties of the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential>, which allows certificates needed to communicate securely with given endpoints, such as security token services.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="cec73-110">Исключение <xref:System.Security.Cryptography.CryptographicException> может возникнуть, если клиент использует олицетворенные учетные данные, привязку <xref:System.ServiceModel.WSFederationHttpBinding> или выданный пользовательский маркер и асимметричные ключи.</span><span class="sxs-lookup"><span data-stu-id="cec73-110">A <xref:System.Security.Cryptography.CryptographicException> might be thrown when a client uses impersonated credentials, the <xref:System.ServiceModel.WSFederationHttpBinding> binding or a custom-issued token, and asymmetric keys.</span></span> <span data-ttu-id="cec73-111">Асимметричные ключи используются с привязкой <xref:System.ServiceModel.WSFederationHttpBinding> и выданными пользовательскими маркерами, если для свойств <xref:System.ServiceModel.FederatedMessageSecurityOverHttp.IssuedKeyType%2A> и <xref:System.ServiceModel.Security.Tokens.IssuedSecurityTokenParameters.KeyType%2A> соответственно задано значение <xref:System.IdentityModel.Tokens.SecurityKeyType.AsymmetricKey>.</span><span class="sxs-lookup"><span data-stu-id="cec73-111">Asymmetric keys are used with the <xref:System.ServiceModel.WSFederationHttpBinding> binding and custom-issued tokens when the <xref:System.ServiceModel.FederatedMessageSecurityOverHttp.IssuedKeyType%2A> and <xref:System.ServiceModel.Security.Tokens.IssuedSecurityTokenParameters.KeyType%2A> properties, respectively, are set to <xref:System.IdentityModel.Tokens.SecurityKeyType.AsymmetricKey>.</span></span> <span data-ttu-id="cec73-112">Исключение <xref:System.Security.Cryptography.CryptographicException> возникает, когда клиент пытается отправить сообщение, а для идентификации, которую олицетворяет клиент, отсутствует профиль пользователя.</span><span class="sxs-lookup"><span data-stu-id="cec73-112">The <xref:System.Security.Cryptography.CryptographicException> is thrown when the client attempts to send a message and a user profile doesn’t exist for the identity that the client is impersonating.</span></span> <span data-ttu-id="cec73-113">Чтобы подавить эту проблему, перед отправкой сообщения войдите в систему на клиентском компьютере или вызовите метод `LoadUserProfile`.</span><span class="sxs-lookup"><span data-stu-id="cec73-113">To mitigate this issue, log on to the client computer or call `LoadUserProfile` before sending the message.</span></span>  
  
 <span data-ttu-id="cec73-114">В этом разделе приведены подробные сведения об этих процедурах.</span><span class="sxs-lookup"><span data-stu-id="cec73-114">This topic provides detailed information about these procedures.</span></span> <span data-ttu-id="cec73-115">Дополнительные сведения о создании подходящей привязки см. в разделе [инструкции. Создание WSFederationHttpBinding](how-to-create-a-wsfederationhttpbinding.md).</span><span class="sxs-lookup"><span data-stu-id="cec73-115">For more information about creating an appropriate binding, see [How to: Create a WSFederationHttpBinding](how-to-create-a-wsfederationhttpbinding.md).</span></span> <span data-ttu-id="cec73-116">Дополнительные сведения о работе федеративной службы см. в разделе [Федерация](federation.md).</span><span class="sxs-lookup"><span data-stu-id="cec73-116">For more information about how a federated service works, see [Federation](federation.md).</span></span>  
  
### <a name="to-generate-and-examine-the-configuration-for-a-federated-service"></a><span data-ttu-id="cec73-117">Создание и проверка конфигурации для федеративной службы</span><span class="sxs-lookup"><span data-stu-id="cec73-117">To generate and examine the configuration for a federated service</span></span>  
  
1. <span data-ttu-id="cec73-118">Запустите [средство служебной программы метаданных ServiceModel (Svcutil.exe)](../servicemodel-metadata-utility-tool-svcutil-exe.md) с адресом URL-адреса метаданных службы в качестве параметра командной строки.</span><span class="sxs-lookup"><span data-stu-id="cec73-118">Run the [ServiceModel Metadata Utility Tool (Svcutil.exe)](../servicemodel-metadata-utility-tool-svcutil-exe.md) with the address of the metadata URL of the service as a command-line parameter.</span></span>  
  
2. <span data-ttu-id="cec73-119">Откройте созданный файл конфигурации в подходящем редакторе.</span><span class="sxs-lookup"><span data-stu-id="cec73-119">Open the generated configuration file in an appropriate editor.</span></span>  
  
3. <span data-ttu-id="cec73-120">Изучите атрибуты и содержимое всех созданных [\<issuer>](../../configure-apps/file-schema/wcf/issuer.md) [\<issuerMetadata>](../../configure-apps/file-schema/wcf/issuermetadata.md) элементов и.</span><span class="sxs-lookup"><span data-stu-id="cec73-120">Examine the attributes and content of any generated [\<issuer>](../../configure-apps/file-schema/wcf/issuer.md) and [\<issuerMetadata>](../../configure-apps/file-schema/wcf/issuermetadata.md) elements.</span></span> <span data-ttu-id="cec73-121">Они находятся внутри [\<security>](../../configure-apps/file-schema/wcf/security-of-wsfederationhttpbinding.md) элементов для [\<wsFederationHttpBinding>](../../configure-apps/file-schema/wcf/wsfederationhttpbinding.md) элементов или пользовательских привязок.</span><span class="sxs-lookup"><span data-stu-id="cec73-121">These are located within the [\<security>](../../configure-apps/file-schema/wcf/security-of-wsfederationhttpbinding.md) elements for the [\<wsFederationHttpBinding>](../../configure-apps/file-schema/wcf/wsfederationhttpbinding.md) or custom bindings elements.</span></span> <span data-ttu-id="cec73-122">Убедитесь, что адреса содержат ожидаемые имена доменов или другую адресную информацию.</span><span class="sxs-lookup"><span data-stu-id="cec73-122">Ensure that the addresses contain the expected domain names or other address information.</span></span> <span data-ttu-id="cec73-123">Важно проверить эту информацию, так как клиент проверяет свою подлинность по этим адресам, и возможно раскрытие такой информации, как пары "имя пользователя-пароль".</span><span class="sxs-lookup"><span data-stu-id="cec73-123">It is important to check this information because the client authenticates to these addresses and may disclose information such as user name/password pairs.</span></span> <span data-ttu-id="cec73-124">Если адреса отличаются от ожидаемых, это может привести к передаче информации неправильному получателю.</span><span class="sxs-lookup"><span data-stu-id="cec73-124">If the address is not the expected address, this could result in information disclosure to an unintended recipient.</span></span>  
  
4. <span data-ttu-id="cec73-125">Изучите дополнительные элементы в элементе [\<issuedTokenParameters>](../../configure-apps/file-schema/wcf/issuedtokenparameters.md) <> с комментарием `alternativeIssuedTokenParameters` .</span><span class="sxs-lookup"><span data-stu-id="cec73-125">Examine any additional [\<issuedTokenParameters>](../../configure-apps/file-schema/wcf/issuedtokenparameters.md) elements inside the commented out <`alternativeIssuedTokenParameters`> element.</span></span> <span data-ttu-id="cec73-126">Если при использовании средства Svcutil.exe для создания конфигурации для федеративной службы эта федеративная служба или любая промежуточная служба маркеров безопасности указывает не адрес издателя, а адрес метаданных для службы маркеров безопасности с несколькими конечными точками, получающийся файл конфигурации ссылается на первую конечную точку.</span><span class="sxs-lookup"><span data-stu-id="cec73-126">When using the Svcutil.exe tool to generate configuration for a federated service, if the federated service or any intermediate security token services do not specify an issuer address, but rather specify a metadata address for a security token service that exposes multiple endpoints, the resulting configuration file refers to the first endpoint.</span></span> <span data-ttu-id="cec73-127">Дополнительные конечные точки находятся в файле конфигурации как <> элементов с комментариями `alternativeIssuedTokenParameters` .</span><span class="sxs-lookup"><span data-stu-id="cec73-127">Additional endpoints are in the configuration file as commented-out <`alternativeIssuedTokenParameters`> elements.</span></span>  
  
     <span data-ttu-id="cec73-128">Определите, является ли один из этих <`issuedTokenParameters`> предпочтительным для того, который уже существует в конфигурации.</span><span class="sxs-lookup"><span data-stu-id="cec73-128">Determine whether one of these <`issuedTokenParameters`> is preferable to the one already present in the configuration.</span></span> <span data-ttu-id="cec73-129">Например, клиент может предпочесть проверку подлинности в службе маркеров безопасности с помощью маркера Windows CardSpace, а не пары имя пользователя и пароль.</span><span class="sxs-lookup"><span data-stu-id="cec73-129">For example, the client may prefer to authenticate to a security token service using a Windows CardSpace token rather than a user name/password pair.</span></span>  
  
    > [!NOTE]
    > <span data-ttu-id="cec73-130">Если перед началом взаимодействия со службой необходимо пройти через несколько служб маркеров безопасности, промежуточная служба маркеров безопасности может направить клиента в неправильную службу маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="cec73-130">Where multiple security token services must be traversed before communicating with the service, it is possible for an intermediate security token service to direct the client to an incorrect security token service.</span></span> <span data-ttu-id="cec73-131">Поэтому убедитесь, что конечная точка службы маркеров безопасности в [\<issuedTokenParameters>](../../configure-apps/file-schema/wcf/issuedtokenparameters.md) является ожидаемой службой маркеров безопасности, а не неизвестной службой маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="cec73-131">Therefore, ensure that the endpoint for the security token service in the [\<issuedTokenParameters>](../../configure-apps/file-schema/wcf/issuedtokenparameters.md) is the expected security token service and not an unknown security token service.</span></span>  
  
### <a name="to-configure-an-issuedtokenclientcredential-in-code"></a><span data-ttu-id="cec73-132">Настройка IssuedTokenClientCredential в коде</span><span class="sxs-lookup"><span data-stu-id="cec73-132">To configure an IssuedTokenClientCredential in code</span></span>  
  
1. <span data-ttu-id="cec73-133">Получите доступ к <xref:System.ServiceModel.Security.IssuedTokenClientCredential> через свойство <xref:System.ServiceModel.Description.ClientCredentials.IssuedToken%2A> класса <xref:System.ServiceModel.Description.ClientCredentials> (возвращается свойством <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> класса <xref:System.ServiceModel.ClientBase%601> или через класс <xref:System.ServiceModel.ChannelFactory>), как показано в следующем примере кода.</span><span class="sxs-lookup"><span data-stu-id="cec73-133">Access the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> through the <xref:System.ServiceModel.Description.ClientCredentials.IssuedToken%2A> property of the <xref:System.ServiceModel.Description.ClientCredentials> class (returned by the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class, or through the <xref:System.ServiceModel.ChannelFactory> class), as shown in the following example code.</span></span>  
  
     [!code-csharp[c_CreateSTS#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#9)]
     [!code-vb[c_CreateSTS#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#9)]  
  
2. <span data-ttu-id="cec73-134">Если кэширование маркера не требуется, установите для свойства <xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> значение `false`.</span><span class="sxs-lookup"><span data-stu-id="cec73-134">If token caching is not required, set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> property to `false`.</span></span> <span data-ttu-id="cec73-135">Свойство <xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> определяет, будут ли кэшироваться такие маркеры, полученные от службы маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="cec73-135">The <xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> property controls whether such tokens from a security token service are cached.</span></span> <span data-ttu-id="cec73-136">Если для этого свойства задано значение `false`, клиент запрашивает новый маркер у службы маркеров безопасности каждый раз, когда ему требуется заново подтвердить свою подлинность в федеративной службе, независимо от того, действует ли еще предыдущий маркер.</span><span class="sxs-lookup"><span data-stu-id="cec73-136">If this property is set to `false`, the client requests a new token from the security token service whenever it must re-authenticate itself to the federated service, regardless of whether a previous token is still valid.</span></span> <span data-ttu-id="cec73-137">Если для этого свойства задано значение `true`, клиент повторно использует существующий маркер, когда ему требуется заново подтвердить свою подлинность в федеративной службе (до тех пор, пока не истечет срок действия этого маркера).</span><span class="sxs-lookup"><span data-stu-id="cec73-137">If this property is set to `true`, the client reuses an existing token whenever it must re-authenticate itself to the federated service (as long as the token has not expired).</span></span> <span data-ttu-id="cec73-138">Значение по умолчанию — `true`.</span><span class="sxs-lookup"><span data-stu-id="cec73-138">The default is `true`.</span></span>  
  
3. <span data-ttu-id="cec73-139">Если для кэшированных маркеров требуется ограничение по времени, задайте для свойства <xref:System.ServiceModel.Security.IssuedTokenClientCredential.MaxIssuedTokenCachingTime%2A> значение <xref:System.TimeSpan>.</span><span class="sxs-lookup"><span data-stu-id="cec73-139">If a time limit is required on cached tokens, set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.MaxIssuedTokenCachingTime%2A> property to a <xref:System.TimeSpan> value.</span></span> <span data-ttu-id="cec73-140">Это свойство указывает, как долго маркер может оставаться в кэше.</span><span class="sxs-lookup"><span data-stu-id="cec73-140">The property specifies how long a token can be cached.</span></span> <span data-ttu-id="cec73-141">По истечении указанного времени маркер удаляется из кэша клиента.</span><span class="sxs-lookup"><span data-stu-id="cec73-141">After the specified time span has elapsed, the token is removed from the client cache.</span></span> <span data-ttu-id="cec73-142">По умолчанию время нахождения маркеров в кэше не ограничено.</span><span class="sxs-lookup"><span data-stu-id="cec73-142">By default, tokens are cached indefinitely.</span></span> <span data-ttu-id="cec73-143">В следующем примере задается промежуток времени 10 минут.</span><span class="sxs-lookup"><span data-stu-id="cec73-143">The following example sets the time span to 10 minutes.</span></span>  
  
     [!code-csharp[c_CreateSTS#15](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#15)]
     [!code-vb[c_CreateSTS#15](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#15)]  
  
4. <span data-ttu-id="cec73-144">Необязательный элемент.</span><span class="sxs-lookup"><span data-stu-id="cec73-144">Optional.</span></span> <span data-ttu-id="cec73-145">Задайте для <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> значение в процентах.</span><span class="sxs-lookup"><span data-stu-id="cec73-145">Set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> to a percentage.</span></span> <span data-ttu-id="cec73-146">По умолчанию используется значение 60 процентов.</span><span class="sxs-lookup"><span data-stu-id="cec73-146">The default is 60 (percent).</span></span> <span data-ttu-id="cec73-147">Это свойство задается в процентах от срока действия маркера.</span><span class="sxs-lookup"><span data-stu-id="cec73-147">The property specifies a percentage of the token's validity period.</span></span> <span data-ttu-id="cec73-148">Например, если срок действия выданного маркера составляет 10 часов, и для параметра <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> задано значение 80, маркер обновляется через 8 часов.</span><span class="sxs-lookup"><span data-stu-id="cec73-148">For example, if the issued token is valid for 10 hours and <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> is set to 80, then the token is renewed after eight hours.</span></span> <span data-ttu-id="cec73-149">В следующем примере задается значение 80 процентов.</span><span class="sxs-lookup"><span data-stu-id="cec73-149">The following example sets the value to 80 percent.</span></span>  
  
     [!code-csharp[c_CreateSTS#16](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#16)]
     [!code-vb[c_CreateSTS#16](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#16)]  
  
     <span data-ttu-id="cec73-150">Интервал обновления, заданный сроком действия маркера и значением `IssuedTokenRenewalThresholdPercentage`, заменяется значением `MaxIssuedTokenCachingTime`, если время кэширования меньше порогового времени обновления.</span><span class="sxs-lookup"><span data-stu-id="cec73-150">The renewal interval determined by the token validity period and the `IssuedTokenRenewalThresholdPercentage` value is overridden by the `MaxIssuedTokenCachingTime` value in cases where the caching time is shorter than the renewal threshold time.</span></span> <span data-ttu-id="cec73-151">Например, если произведение `IssuedTokenRenewalThresholdPercentage` и срока действия маркера равно восьми часам, а значение `MaxIssuedTokenCachingTime` равно 10 минутам, клиент обращается в службу маркеров безопасности за обновленным маркером каждые 10 минут.</span><span class="sxs-lookup"><span data-stu-id="cec73-151">For example, if the product of `IssuedTokenRenewalThresholdPercentage` and the token's duration is eight hours, and the `MaxIssuedTokenCachingTime` value is 10 minutes, the client contacts the security token service for an updated token every 10 minutes.</span></span>  
  
5. <span data-ttu-id="cec73-152">Если для привязки требуется режим энтропии ключа, отличный от <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy>, и при этом привязка не использует безопасность сообщений или безопасность транспорта с учетными данными сообщения (например,</span><span class="sxs-lookup"><span data-stu-id="cec73-152">If a key entropy mode other than <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy> is needed on a binding that does not use message security or transport security with message credentials (for example.</span></span> <span data-ttu-id="cec73-153">в привязке отсутствует элемент <xref:System.ServiceModel.Channels.SecurityBindingElement>), задайте свойству <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> соответствующее значение.</span><span class="sxs-lookup"><span data-stu-id="cec73-153">the binding does not have a <xref:System.ServiceModel.Channels.SecurityBindingElement>), set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> property to an appropriate value.</span></span> <span data-ttu-id="cec73-154">Режим *энтропии* определяет, можно ли управлять симметричными ключами с помощью <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> Свойства.</span><span class="sxs-lookup"><span data-stu-id="cec73-154">The *entropy* mode determines whether symmetric keys can be controlled using the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> property.</span></span> <span data-ttu-id="cec73-155">По умолчанию используется значение <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy>, когда и клиент, и издатель маркера предоставляют данные, совместно используемые для создания фактического ключа.</span><span class="sxs-lookup"><span data-stu-id="cec73-155">This default is <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy>, where both the client and the token issuer provide data that is combined to produce the actual key.</span></span> <span data-ttu-id="cec73-156">Также предусмотрены значения <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ClientEntropy> и <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ServerEntropy>, которые означают, что весь ключ задается клиентом или сервером соответственно.</span><span class="sxs-lookup"><span data-stu-id="cec73-156">Other values are <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ClientEntropy> and <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ServerEntropy>, which means the entire key is specified by the client or the server, respectively.</span></span> <span data-ttu-id="cec73-157">В следующем примере свойству задается значение, означающее, что для ключа используются только данные сервера.</span><span class="sxs-lookup"><span data-stu-id="cec73-157">The following example sets the property to use only the server data for the key.</span></span>  
  
     [!code-csharp[c_CreateSTS#17](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#17)]
     [!code-vb[c_CreateSTS#17](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#17)]  
  
    > [!NOTE]
    > <span data-ttu-id="cec73-158">Если в привязке службы маркеров безопасности или службы присутствует элемент <xref:System.ServiceModel.Channels.SecurityBindingElement>, параметр <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> со значением <xref:System.ServiceModel.Security.IssuedTokenClientCredential> переопределяется свойством <xref:System.ServiceModel.Channels.SecurityBindingElement.KeyEntropyMode%2A> элемента `SecurityBindingElement`.</span><span class="sxs-lookup"><span data-stu-id="cec73-158">If a <xref:System.ServiceModel.Channels.SecurityBindingElement> is present in a security token service or service binding, the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> set on <xref:System.ServiceModel.Security.IssuedTokenClientCredential> is overridden by the <xref:System.ServiceModel.Channels.SecurityBindingElement.KeyEntropyMode%2A> property of the `SecurityBindingElement`.</span></span>  
  
6. <span data-ttu-id="cec73-159">Настройте все поведения конечных точек, специфичных для издателя, добавив эти поведения в коллекцию, возвращаемую свойством <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuerChannelBehaviors%2A>.</span><span class="sxs-lookup"><span data-stu-id="cec73-159">Configure any issuer-specific endpoint behaviors by adding them to the collection returned by the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuerChannelBehaviors%2A> property.</span></span>  
  
     [!code-csharp[c_CreateSTS#14](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#14)]
     [!code-vb[c_CreateSTS#14](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#14)]  
  
### <a name="to-configure-the-issuedtokenclientcredential-in-configuration"></a><span data-ttu-id="cec73-160">Настройка IssuedTokenClientCredential в конфигурации</span><span class="sxs-lookup"><span data-stu-id="cec73-160">To configure the IssuedTokenClientCredential in configuration</span></span>  
  
1. <span data-ttu-id="cec73-161">Создание [\<issuedToken>](../../configure-apps/file-schema/wcf/issuedtoken.md) элемента в качестве дочернего элемента [\<issuedToken>](../../configure-apps/file-schema/wcf/issuedtoken.md) в поведении конечной точки.</span><span class="sxs-lookup"><span data-stu-id="cec73-161">Create an [\<issuedToken>](../../configure-apps/file-schema/wcf/issuedtoken.md) element as a child of the [\<issuedToken>](../../configure-apps/file-schema/wcf/issuedtoken.md) element in an endpoint behavior.</span></span>  
  
2. <span data-ttu-id="cec73-162">Если кэширование маркеров не требуется, задайте `cacheIssuedTokens` атрибуту (элемента> <`issuedToken` ) значение `false` .</span><span class="sxs-lookup"><span data-stu-id="cec73-162">If token caching is not required, set the `cacheIssuedTokens` attribute (of the <`issuedToken`> element) to `false`.</span></span>  
  
3. <span data-ttu-id="cec73-163">Если для кэшированных токенов требуется ограничение по времени, задайте `maxIssuedTokenCachingTime` для атрибута в `issuedToken` элементе <> соответствующее значение.</span><span class="sxs-lookup"><span data-stu-id="cec73-163">If a time limit is required on cached tokens, set the `maxIssuedTokenCachingTime` attribute on the <`issuedToken`> element to an appropriate value.</span></span> <span data-ttu-id="cec73-164">Пример:</span><span class="sxs-lookup"><span data-stu-id="cec73-164">For example:</span></span>  
    `<issuedToken maxIssuedTokenCachingTime='00:10:00' />`  
  
4. <span data-ttu-id="cec73-165">Если предпочтительным является значение, отличное от значения по умолчанию, установите `issuedTokenRenewalThresholdPercentage` атрибут для `issuedToken` элемента <> в соответствующее значение, например:</span><span class="sxs-lookup"><span data-stu-id="cec73-165">If a value other than the default is preferred, set the `issuedTokenRenewalThresholdPercentage` attribute on the <`issuedToken`> element to an appropriate value, for example:</span></span>  
  
    ```xml  
    <issuedToken issuedTokenRenewalThresholdPercentage = "80" />  
    ```  
  
5. <span data-ttu-id="cec73-166">Если для привязки, не использующей безопасность сообщений или безопасность транспорта с учетными данными сообщения (например, в привязке отсутствует элемент `CombinedEntropy`), требуется режим энтропии ключа, отличный от `SecurityBindingElement`, задайте для атрибута `defaultKeyEntropyMode` элемента `<issuedToken>` требуемое значение `ServerEntropy` или `ClientEntropy`.</span><span class="sxs-lookup"><span data-stu-id="cec73-166">If a key entropy mode other than `CombinedEntropy` is on a binding that does not use message security or transport security with message credentials (for example, the binding does not have a `SecurityBindingElement`), set the `defaultKeyEntropyMode` attribute on the `<issuedToken>` element to a either `ServerEntropy` or `ClientEntropy` as required.</span></span>  
  
    ```xml  
    <issuedToken defaultKeyEntropyMode = "ServerEntropy" />  
    ```  
  
6. <span data-ttu-id="cec73-167">Необязательный элемент.</span><span class="sxs-lookup"><span data-stu-id="cec73-167">Optional.</span></span> <span data-ttu-id="cec73-168">Настройте поведение пользовательской конечной точки, зависящей от поставщика, создав `issuerChannelBehaviors` элемент <> в качестве дочернего элемента <`issuedToken`>.</span><span class="sxs-lookup"><span data-stu-id="cec73-168">Configure any issuer-specific custom endpoint behavior by creating an <`issuerChannelBehaviors`> element as a child of the <`issuedToken`> element.</span></span> <span data-ttu-id="cec73-169">Для каждого поведения создайте `add` элемент> <как дочерний элемент `issuerChannelBehaviors` элемента <>.</span><span class="sxs-lookup"><span data-stu-id="cec73-169">For each behavior, create an <`add`> element as a child of the <`issuerChannelBehaviors`> element.</span></span> <span data-ttu-id="cec73-170">Укажите адрес издателя поведения, задав `issuerAddress` атрибут для `add` элемента <>.</span><span class="sxs-lookup"><span data-stu-id="cec73-170">Specify the issuer address of the behavior by setting the `issuerAddress` attribute on the <`add`> element.</span></span> <span data-ttu-id="cec73-171">Укажите поведение самостоятельно, задав `behaviorConfiguration` атрибут для `add` элемента <>.</span><span class="sxs-lookup"><span data-stu-id="cec73-171">Specify the behavior itself by setting the `behaviorConfiguration` attribute on the <`add`> element.</span></span>  
  
    ```xml  
    <issuerChannelBehaviors>  
    <add issuerAddress="http://fabrikam.org/sts" behaviorConfiguration="FabrikamSTS" />  
    </issuerChannelBehaviors>  
    ```  
  
### <a name="to-configure-an-x509certificaterecipientclientcredential-in-code"></a><span data-ttu-id="cec73-172">Настройка X509CertificateRecipientClientCredential в коде</span><span class="sxs-lookup"><span data-stu-id="cec73-172">To configure an X509CertificateRecipientClientCredential in code</span></span>  
  
1. <span data-ttu-id="cec73-173">Обратитесь к <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> через свойство <xref:System.ServiceModel.Description.ClientCredentials.ServiceCertificate%2A> свойства <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> класса <xref:System.ServiceModel.ClientBase%601> или свойство <xref:System.ServiceModel.ChannelFactory>.</span><span class="sxs-lookup"><span data-stu-id="cec73-173">Access the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> through the <xref:System.ServiceModel.Description.ClientCredentials.ServiceCertificate%2A> property of the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class or the <xref:System.ServiceModel.ChannelFactory> property.</span></span>  
  
     [!code-csharp[c_CreateSTS#18](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#18)]
     [!code-vb[c_CreateSTS#18](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#18)]  
  
2. <span data-ttu-id="cec73-174">Если для сертификата для определенной конечной точки имеется экземпляр <xref:System.Security.Cryptography.X509Certificates.X509Certificate2>, используйте метод <xref:System.Collections.Generic.ICollection%601.Add%2A> коллекции, возвращаемой свойством <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A>.</span><span class="sxs-lookup"><span data-stu-id="cec73-174">If an <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> instance is available for the certificate for a given endpoint, use the <xref:System.Collections.Generic.ICollection%601.Add%2A> method of the collection returned by the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property.</span></span>  
  
     [!code-csharp[c_CreateSTS#19](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#19)]
     [!code-vb[c_CreateSTS#19](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#19)]  
  
3. <span data-ttu-id="cec73-175">Если экземпляр <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> отсутствует, используйте метод <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> класса <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential>, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="cec73-175">If an <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> instance is not available, use the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> method of the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> class as shown in the following example.</span></span>  
  
     [!code-csharp[c_CreateSTS#20](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#20)]
     [!code-vb[c_CreateSTS#20](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#20)]  
  
### <a name="to-configure-an-x509certificaterecipientclientcredential-in-configuration"></a><span data-ttu-id="cec73-176">Настройка X509CertificateRecipientClientCredential в конфигурации</span><span class="sxs-lookup"><span data-stu-id="cec73-176">To configure an X509CertificateRecipientClientCredential in configuration</span></span>  
  
1. <span data-ttu-id="cec73-177">Создайте [\<scopedCertificates>](../../configure-apps/file-schema/wcf/scopedcertificates-element.md) элемент в качестве дочернего элемента для [\<serviceCertificate>](../../configure-apps/file-schema/wcf/servicecertificate-of-clientcredentials-element.md) элемента, который сам является дочерним по отношению к [\<clientCredentials>](../../configure-apps/file-schema/wcf/clientcredentials.md) элементу в поведении конечной точки.</span><span class="sxs-lookup"><span data-stu-id="cec73-177">Create a [\<scopedCertificates>](../../configure-apps/file-schema/wcf/scopedcertificates-element.md) element as a child of the [\<serviceCertificate>](../../configure-apps/file-schema/wcf/servicecertificate-of-clientcredentials-element.md) element that is itself a child of the [\<clientCredentials>](../../configure-apps/file-schema/wcf/clientcredentials.md) element in an endpoint behavior.</span></span>  
  
2. <span data-ttu-id="cec73-178">Создайте элемент `<add>`, являющийся дочерним для элемента `<scopedCertificates>`.</span><span class="sxs-lookup"><span data-stu-id="cec73-178">Create an `<add>` element as a child of the `<scopedCertificates>` element.</span></span> <span data-ttu-id="cec73-179">Задайте значения атрибутов `storeLocation`, `storeName`, `x509FindType` и `findValue`, указывающие на соответствующий сертификат.</span><span class="sxs-lookup"><span data-stu-id="cec73-179">Specify values for the `storeLocation`, `storeName`, `x509FindType`, and `findValue` attributes to refer to the appropriate certificate.</span></span> <span data-ttu-id="cec73-180">Задайте для атрибута `targetUri` значение, предоставляющее адрес конечной точки, для которой предназначен сертификат, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="cec73-180">Set the `targetUri` attribute to a value that provides the address of the endpoint that the certificate is to be used for, as shown in the following example.</span></span>  
  
    ```xml  
    <scopedCertificates>  
     <add targetUri="http://fabrikam.com/sts"
          storeLocation="CurrentUser"  
          storeName="TrustedPeople"  
          x509FindType="FindBySubjectName"  
          findValue="FabrikamSTS" />  
    </scopedCertificates>  
    ```  
  
## <a name="example"></a><span data-ttu-id="cec73-181">Пример</span><span class="sxs-lookup"><span data-stu-id="cec73-181">Example</span></span>  

 <span data-ttu-id="cec73-182">В следующем примере кода экземпляр класса <xref:System.ServiceModel.Security.IssuedTokenClientCredential> настраивается в коде.</span><span class="sxs-lookup"><span data-stu-id="cec73-182">The following code sample configures an instance of the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> class in code.</span></span>  
  
 [!code-csharp[c_FederatedClient#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_federatedclient/cs/source.cs#2)]
 [!code-vb[c_FederatedClient#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_federatedclient/vb/source.vb#2)]  
  
## <a name="net-framework-security"></a><span data-ttu-id="cec73-183">Безопасность .NET Framework</span><span class="sxs-lookup"><span data-stu-id="cec73-183">.NET Framework Security</span></span>  

 <span data-ttu-id="cec73-184">Для исключения возможного раскрытия информации клиенты, запускающие средство Svcutil.exe для обработки метаданных от федеральных конечных точек, должны проверять, что получающиеся адреса служб маркеров безопасности соответствуют ожидаемым.</span><span class="sxs-lookup"><span data-stu-id="cec73-184">To prevent possible information disclosure, clients that are running the Svcutil.exe tool to process metadata from federated endpoints should ensure that the resulting security token service addresses are what they expect.</span></span> <span data-ttu-id="cec73-185">Это особенно важно, если служба маркеров безопасности предоставляет несколько конечных точек, так как средство Svcutil.exe задает в создаваемом файле конфигурации первую такую конечную точку, которая может отличаться от конечной точки, которую должен использовать клиент.</span><span class="sxs-lookup"><span data-stu-id="cec73-185">This is especially important when a security token service exposes multiple endpoints, because the Svcutil.exe tool generates the resulting configuration file to use the first such endpoint, which may not be the one the client should be using.</span></span>  
  
## <a name="localissuer-required"></a><span data-ttu-id="cec73-186">Требуется LocalIssuer</span><span class="sxs-lookup"><span data-stu-id="cec73-186">LocalIssuer Required</span></span>  

 <span data-ttu-id="cec73-187">Если требуется, чтобы клиенты всегда использовали локального издателя, обратите внимание на следующее: выходные данные средства Svcutil.exe по умолчанию задают, что локальный издатель не используется, если в предпоследней службе маркеров безопасности в цепочке указан адрес издателя или адрес метаданных издателя.</span><span class="sxs-lookup"><span data-stu-id="cec73-187">If clients are expected to always use a local issuer, note the following: the default output of Svcutil.exe results in the local issuer not being used if the second-to-last security token service in the chain specifies an issuer address or issuer metadata address.</span></span>  
  
 <span data-ttu-id="cec73-188">Дополнительные сведения о настройке <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerAddress%2A> <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerBinding%2A> свойств, и класса см <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerChannelBehaviors%2A> <xref:System.ServiceModel.Security.IssuedTokenClientCredential> . [в разделе как настроить локальный издатель](how-to-configure-a-local-issuer.md).</span><span class="sxs-lookup"><span data-stu-id="cec73-188">For more information about setting the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerAddress%2A>, <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerBinding%2A>, and <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerChannelBehaviors%2A> properties of the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> class, see [How to: Configure a Local Issuer](how-to-configure-a-local-issuer.md).</span></span>  
  
## <a name="scoped-certificates"></a><span data-ttu-id="cec73-189">Сертификаты с областью действия</span><span class="sxs-lookup"><span data-stu-id="cec73-189">Scoped Certificates</span></span>  

 <span data-ttu-id="cec73-190">Если требуется задать сертификаты службы для взаимодействия с любыми службами маркеров безопасности (обычно в связи с тем, что не используется согласование сертификатов), их можно задать с помощью свойства <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> класса <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential>.</span><span class="sxs-lookup"><span data-stu-id="cec73-190">If service certificates must be specified for communicating with any of the security token services, typically because certificate negotiation is not being used, they can be specified using the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property of the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> class.</span></span> <span data-ttu-id="cec73-191">Метод <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetDefaultCertificate%2A> принимает в качестве параметров <xref:System.Uri> и <xref:System.Security.Cryptography.X509Certificates.X509Certificate2>.</span><span class="sxs-lookup"><span data-stu-id="cec73-191">The <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetDefaultCertificate%2A> method takes a <xref:System.Uri> and an <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> as parameters.</span></span> <span data-ttu-id="cec73-192">Указанный сертификат используется при взаимодействии с конечными точками по указанному универсальному коду ресурса (URI).</span><span class="sxs-lookup"><span data-stu-id="cec73-192">The specified certificate is used when communicating with endpoints at the specified URI.</span></span> <span data-ttu-id="cec73-193">В качестве альтернативы можно с помощью метода <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> добавить сертификат в коллекцию, возвращаемую свойством <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A>.</span><span class="sxs-lookup"><span data-stu-id="cec73-193">Alternatively, you can use the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> method to add a certificate to the collection returned by the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="cec73-194">Концепция сертификатов клиента, область действия которых ограничена только определенным универсальным кодом ресурса (URI), применима только к приложениям, производящим исходящие вызовы служб, предоставляющих конечные точки по этим универсальным кодам ресурса (URI).</span><span class="sxs-lookup"><span data-stu-id="cec73-194">The client idea of certificates that are scoped to a given URI applies only to applications that are making outbound calls to services that expose endpoints at those URIs.</span></span> <span data-ttu-id="cec73-195">Он не применяется к сертификатам, которые используются для подписывания выданных маркеров, например, настроенных на сервере в коллекции, возвращаемой <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> классом.</span><span class="sxs-lookup"><span data-stu-id="cec73-195">It does not apply to certificates that are used to sign issued tokens, such as those configured on the server in the collection returned by the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> of the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> class.</span></span> <span data-ttu-id="cec73-196">Дополнительные сведения см. в разделе [инструкции. Настройка учетных данных на служба федерации](how-to-configure-credentials-on-a-federation-service.md).</span><span class="sxs-lookup"><span data-stu-id="cec73-196">For more information, see [How to: Configure Credentials on a Federation Service](how-to-configure-credentials-on-a-federation-service.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="cec73-197">См. также</span><span class="sxs-lookup"><span data-stu-id="cec73-197">See also</span></span>

- [<span data-ttu-id="cec73-198">Пример федерации</span><span class="sxs-lookup"><span data-stu-id="cec73-198">Federation Sample</span></span>](../samples/federation-sample.md)
- [<span data-ttu-id="cec73-199">Практическое руководство. Порядок отключения безопасных сеансов в WSFederationHttpBinding</span><span class="sxs-lookup"><span data-stu-id="cec73-199">How to: Disable Secure Sessions on a WSFederationHttpBinding</span></span>](how-to-disable-secure-sessions-on-a-wsfederationhttpbinding.md)
- [<span data-ttu-id="cec73-200">Практическое руководство. Создание WSFederationHttpBinding</span><span class="sxs-lookup"><span data-stu-id="cec73-200">How to: Create a WSFederationHttpBinding</span></span>](how-to-create-a-wsfederationhttpbinding.md)
- [<span data-ttu-id="cec73-201">Практическое руководство. Настройка учетных данных службы федерации</span><span class="sxs-lookup"><span data-stu-id="cec73-201">How to: Configure Credentials on a Federation Service</span></span>](how-to-configure-credentials-on-a-federation-service.md)
- [<span data-ttu-id="cec73-202">Практическое руководство. Настройка локального издателя</span><span class="sxs-lookup"><span data-stu-id="cec73-202">How to: Configure a Local Issuer</span></span>](how-to-configure-a-local-issuer.md)
- [<span data-ttu-id="cec73-203">Вопросы безопасности при использовании метаданных</span><span class="sxs-lookup"><span data-stu-id="cec73-203">Security Considerations with Metadata</span></span>](security-considerations-with-metadata.md)
- [<span data-ttu-id="cec73-204">Практическое руководство. Защита конечных точек метаданных</span><span class="sxs-lookup"><span data-stu-id="cec73-204">How to: Secure Metadata Endpoints</span></span>](how-to-secure-metadata-endpoints.md)
