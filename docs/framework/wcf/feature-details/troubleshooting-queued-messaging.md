---
description: 'Дополнительные сведения: Устранение неполадок обмена сообщениями в очереди'
title: Устранение неполадок обмена сообщениями с использованием очередей
ms.date: 03/30/2017
ms.assetid: a5f2836f-018d-42f5-a571-1e97e64ea5b0
ms.openlocfilehash: e7cf2706e7c0853f14bad449b6ecaa8dd5983755
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99733090"
---
# <a name="troubleshooting-queued-messaging"></a><span data-ttu-id="bb2d9-103">Устранение неполадок обмена сообщениями с использованием очередей</span><span class="sxs-lookup"><span data-stu-id="bb2d9-103">Troubleshooting Queued Messaging</span></span>

<span data-ttu-id="bb2d9-104">В этом разделе содержатся часто задаваемые вопросы и Справка по устранению неполадок при использовании очередей в Windows Communication Foundation (WCF).</span><span class="sxs-lookup"><span data-stu-id="bb2d9-104">This section contains common questions and troubleshooting help for using queues in Windows Communication Foundation (WCF).</span></span>

## <a name="common-questions"></a><span data-ttu-id="bb2d9-105">Часто задаваемые вопросы</span><span class="sxs-lookup"><span data-stu-id="bb2d9-105">Common Questions</span></span>

<span data-ttu-id="bb2d9-106">**Вопрос.** Я использовал WCF Beta 1 и установил исправление MSMQ.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-106">**Q:** I used WCF Beta 1 and I installed the MSMQ hotfix.</span></span> <span data-ttu-id="bb2d9-107">Требуется ли удалять исправление?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-107">Do I need to remove the hotfix?</span></span>

<span data-ttu-id="bb2d9-108">**Ответ.** Да.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-108">**A:** Yes.</span></span> <span data-ttu-id="bb2d9-109">Это исправление больше не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-109">This hotfix is no longer supported.</span></span> <span data-ttu-id="bb2d9-110">Теперь WCF работает с MSMQ без необходимости исправления.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-110">WCF now works on MSMQ without a hotfix requirement.</span></span>

<span data-ttu-id="bb2d9-111">**Вопрос.** Существует две привязки для MSMQ: <xref:System.ServiceModel.NetMsmqBinding> и <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding> .</span><span class="sxs-lookup"><span data-stu-id="bb2d9-111">**Q:** There are two bindings for MSMQ: <xref:System.ServiceModel.NetMsmqBinding> and <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span></span> <span data-ttu-id="bb2d9-112">Какую необходимо использовать и когда?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-112">What should I use and when?</span></span>

<span data-ttu-id="bb2d9-113">Ответ **.** Используйте, <xref:System.ServiceModel.NetMsmqBinding> Если вы хотите использовать MSMQ в качестве транспорта для обмена данными между двумя приложениями WCF в очереди.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-113">**A:** Use the <xref:System.ServiceModel.NetMsmqBinding> when you want to use MSMQ as a transport for queued communication between two WCF applications.</span></span> <span data-ttu-id="bb2d9-114">Используйте, <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding> Если вы хотите использовать существующие приложения MSMQ для взаимодействия с новыми приложениями WCF.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-114">Use the <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding> when you want to use existing MSMQ applications to communicate with new WCF applications.</span></span>

<span data-ttu-id="bb2d9-115">**Вопрос.** Нужно ли обновлять MSMQ для использования <xref:System.ServiceModel.NetMsmqBinding> `MsmqIntegration` привязок и?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-115">**Q:** Do I have to upgrade MSMQ to use the <xref:System.ServiceModel.NetMsmqBinding> and `MsmqIntegration` bindings?</span></span>

<span data-ttu-id="bb2d9-116">**Ответ.** Нет.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-116">**A:** No.</span></span> <span data-ttu-id="bb2d9-117">Обе привязки работают с MSMQ 3,0 в Windows XP и Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-117">Both bindings work with MSMQ 3.0 on Windows XP and Windows Server 2003.</span></span> <span data-ttu-id="bb2d9-118">Некоторые функции привязок становятся доступными при обновлении до MSMQ 4,0 в Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-118">Certain features of the bindings become available when you upgrade to MSMQ 4.0 in Windows Vista.</span></span>

<span data-ttu-id="bb2d9-119">**Вопрос.** Какие функции <xref:System.ServiceModel.NetMsmqBinding> и <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding> привязки доступны в MSMQ 4,0, но не в MSMQ 3,0?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-119">**Q:** What features of the <xref:System.ServiceModel.NetMsmqBinding> and <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding> bindings are available in MSMQ 4.0 but not in MSMQ 3.0?</span></span>

<span data-ttu-id="bb2d9-120">Ответ **.** Следующие функции доступны в MSMQ 4,0, но не в MSMQ 3,0:</span><span class="sxs-lookup"><span data-stu-id="bb2d9-120">**A:** The following features are available in MSMQ 4.0 but not in MSMQ 3.0:</span></span>

- <span data-ttu-id="bb2d9-121">Пользовательская очередь недоставленных сообщений поддерживается только в MSMQ 4.0.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-121">Custom dead-letter queue is supported only on MSMQ 4.0.</span></span>

- <span data-ttu-id="bb2d9-122">MSMQ 3.0 и 4.0 обрабатывают опасные сообщения по-разному.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-122">MSMQ 3.0 and 4.0 handle poison messages differently.</span></span>

- <span data-ttu-id="bb2d9-123">Удаленные чтения в транзакциях поддерживаются только MSMQ 4.0.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-123">Only MSMQ 4.0 supports remote transacted read.</span></span>

<span data-ttu-id="bb2d9-124">Дополнительные сведения см. в разделе [различия в возможностях очередей в Windows Vista, Windows Server 2003 и Windows XP](diff-in-queue-in-vista-server-2003-windows-xp.md).</span><span class="sxs-lookup"><span data-stu-id="bb2d9-124">For more information, see [Differences in Queuing Features in Windows Vista, Windows Server 2003, and Windows XP](diff-in-queue-in-vista-server-2003-windows-xp.md).</span></span>

<span data-ttu-id="bb2d9-125">**Вопрос.** Можно ли использовать MSMQ 3,0 на одной стороне связи с очередями и MSMQ 4,0 на другой стороне?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-125">**Q:** Can I use MSMQ 3.0 on one side of a queued communication and MSMQ 4.0 on the other side?</span></span>

<span data-ttu-id="bb2d9-126">**Ответ.** Да.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-126">**A:** Yes.</span></span>

<span data-ttu-id="bb2d9-127">**Вопрос.** Я хочу интегрировать существующие приложения MSMQ с новыми клиентами или серверами WCF.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-127">**Q:** I want to integrate existing MSMQ applications with new WCF clients or servers.</span></span> <span data-ttu-id="bb2d9-128">Требуются ли обновления для обеих сторон инфраструктуры MSMQ?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-128">Do I need to upgrade both sides of my MSMQ infrastructure?</span></span>

<span data-ttu-id="bb2d9-129">**Ответ.** Нет.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-129">**A:** No.</span></span> <span data-ttu-id="bb2d9-130">Для обеих сторон обновление до MSMQ 4.0 не требуется.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-130">You do not have to upgrade to MSMQ 4.0 on either side.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="bb2d9-131">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="bb2d9-131">Troubleshooting</span></span>

<span data-ttu-id="bb2d9-132">Данный раздел содержит ответы на вопросы, связанные с устранением распространенных неполадок.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-132">This section contains answers to most common troubleshooting issues.</span></span> <span data-ttu-id="bb2d9-133">Некоторые вопросы, являющиеся известными ограничениями, описаны также в заметках о выпуске.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-133">Some issues that are known limitations are also described in the release notes.</span></span>

<span data-ttu-id="bb2d9-134">**Вопрос.** Я пытаюсь использовать частную очередь и получаю следующее исключение: `System.InvalidOperationException` : недопустимый URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-134">**Q:** I am trying to use a private queue and I get the following exception: `System.InvalidOperationException`: The URL is invalid.</span></span> <span data-ttu-id="bb2d9-135">URL-адрес очереди не может содержать символ "$".</span><span class="sxs-lookup"><span data-stu-id="bb2d9-135">The URL for the queue cannot contain the '$' character.</span></span> <span data-ttu-id="bb2d9-136">Используйте синтаксис net.msmq://machine/private/queueName, чтобы адресовать частную очередь.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-136">Use the syntax in net.msmq://machine/private/queueName to address a private queue.</span></span>

<span data-ttu-id="bb2d9-137">Ответ **.** Проверьте универсальный код ресурса (URI) очереди в конфигурации и коде.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-137">**A:** Check the queue Uniform Resource Identifier (URI) in your configuration and code.</span></span> <span data-ttu-id="bb2d9-138">Не используйте символ "$" в универсальном коде ресурса (URI).</span><span class="sxs-lookup"><span data-stu-id="bb2d9-138">Do not use the "$" character in the URI.</span></span> <span data-ttu-id="bb2d9-139">Например, чтобы устранить частную очередь с именем Ордерскуеуе, укажите универсальный код ресурса (URI) `net.msmq://localhost/private/ordersQueue` .</span><span class="sxs-lookup"><span data-stu-id="bb2d9-139">For example, to address a private queue named OrdersQueue, specify the URI as `net.msmq://localhost/private/ordersQueue`.</span></span>

<span data-ttu-id="bb2d9-140">**Вопрос.** Вызов `ServiceHost.Open()` в моем приложении, находящихся в очереди, вызывает следующее исключение: `System.ArgumentException` : базовый адрес не может содержать строку запроса URI.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-140">**Q:** Calling `ServiceHost.Open()` on my queued application throws the following exception: `System.ArgumentException`: A base address cannot contain a URI query string.</span></span> <span data-ttu-id="bb2d9-141">Почему?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-141">Why?</span></span>

<span data-ttu-id="bb2d9-142">Ответ **.** Проверьте URI очереди в файле конфигурации и в коде.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-142">**A:** Check the queue URI in your configuration file and in your code.</span></span> <span data-ttu-id="bb2d9-143">Хотя очереди MSMQ поддерживают использование символа "?", универсальные коды ресурсов (URI) интерпретируют этот символ как начало строки запроса.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-143">While MSMQ queues support the use of the '?' character, URIs interpret this character as the beginning of a string query.</span></span> <span data-ttu-id="bb2d9-144">Чтобы избежать этого, не используйте символ "?" в именах очередей.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-144">To avoid this issue, use queue names that do not contain '?' characters.</span></span>

<span data-ttu-id="bb2d9-145">**Вопрос.** Моя отправка завершилась успехом, но на получателе не вызвана операция службы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-145">**Q:** My send succeeded but no service operation is invoked on the receiver.</span></span> <span data-ttu-id="bb2d9-146">Почему?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-146">Why?</span></span>

<span data-ttu-id="bb2d9-147">Ответ **.** Чтобы определить ответ, обратитесь к следующему контрольному списку:</span><span class="sxs-lookup"><span data-stu-id="bb2d9-147">**A:** To determine the answer, work through the following check list:</span></span>

- <span data-ttu-id="bb2d9-148">Проверьте, совместимы ли требования транзакционной очереди с заданными гарантиями.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-148">Check that the transactional queue requirements are compatible with the assurances specified.</span></span> <span data-ttu-id="bb2d9-149">Обратите внимание на следующие принципы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-149">Note the following principles:</span></span>

  - <span data-ttu-id="bb2d9-150">Устойчивые сообщения (датаграммы и сеансы) можно отправить с "только один раз" гарантиями ( <xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A>  =  `true` ) только в транзакционную очередь.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-150">You can send durable messages (datagrams and sessions) with "exactly once" assurances (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `true`) only to a transactional queue.</span></span>

  - <span data-ttu-id="bb2d9-151">Сеансы можно отправлять только с гарантиями доставки точно по одному разу.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-151">You can send sessions only with "exactly once" assurances.</span></span>

  - <span data-ttu-id="bb2d9-152">Необходимо, чтобы в сеансе транзакция получала сообщения из транзакционной очереди.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-152">A transaction is required to receive messages in a session from a transactional queue.</span></span>

  - <span data-ttu-id="bb2d9-153">Вы можете отправлять или получать временные или устойчивые сообщения (только датаграммы) без гарантии ( <xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A>  =  `false` ) только в нетранзакционную очередь.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-153">You can send or receive volatile or durable messages (datagrams only) with no assurances (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `false`) only to a non-transactional queue.</span></span>

- <span data-ttu-id="bb2d9-154">Проверьте очередь недоставленных писем.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-154">Check the dead-letter queue.</span></span> <span data-ttu-id="bb2d9-155">Если в этой очереди есть сообщения, определите причину, по которой они не были доставлены.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-155">If you find the messages there, determine why they were not delivered.</span></span>

- <span data-ttu-id="bb2d9-156">Проверьте очереди исходящих сообщений на наличие проблем с подключением и адресацией.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-156">Check the outgoing queues for connectivity or addressing problems.</span></span>

<span data-ttu-id="bb2d9-157">**Вопрос.** Я указал пользовательскую очередь недоставленных сообщений, но когда я запускаю приложение отправителя, я получаю исключение, что либо очередь недоставленных сообщений не найдена, либо у отправляющего приложения нет разрешения на доступ к очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-157">**Q:** I have specified a custom dead-letter queue, but when I start the sender application, I get an exception that either the dead-letter queue is not found, or the sending application has no permission to the dead-letter queue.</span></span> <span data-ttu-id="bb2d9-158">Почему это происходит?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-158">Why is this happening?</span></span>

<span data-ttu-id="bb2d9-159">Ответ **.** Пользовательский URI очереди недоставленных сообщений должен включать в первый сегмент "localhost" или имя компьютера, например очередь NET. msmq://ЛОКАЛХОСТ/привате/мяппдеад-Леттер.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-159">**A:** The custom dead-letter queue URI must include a "localhost" or the computer name in the first segment, for example, net.msmq://localhost/private/myAppdead-letter queue.</span></span>

<span data-ttu-id="bb2d9-160">**Вопрос.** Нужно ли всегда определять пользовательскую очередь недоставленных сообщений или очередь недоставленных сообщений по умолчанию?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-160">**Q:** Is it always necessary to define a custom dead-letter queue, or is there a default dead-letter queue?</span></span>

<span data-ttu-id="bb2d9-161">Ответ **.** Если в качестве гарантии используются «только один раз» ( <xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A>  =  `true` ) и не указана пользовательская очередь недоставленных сообщений, по умолчанию используется транзакционная очередь недоставленных сообщений на уровне системы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-161">**A:** If assurances are "exactly once" (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `true`), and if you do not specify a custom dead-letter queue, the default is a system-wide transactional dead-letter queue.</span></span>

<span data-ttu-id="bb2d9-162">Если <xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A>  =  `false` параметру Assurance присвоено значение None (), то по умолчанию функция очереди недоставленных сообщений не используется.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-162">If assurances are none (<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> = `false`), then the default is no dead-letter queue functionality.</span></span>

<span data-ttu-id="bb2d9-163">**Вопрос.** Моя служба создает исключение в SvcHost. Open с сообщением «EndpointListener требования не могут быть удовлетворены Листенерфактори».</span><span class="sxs-lookup"><span data-stu-id="bb2d9-163">**Q:** My service throws on SvcHost.Open with a message "EndpointListener requirements cannot be met by the ListenerFactory".</span></span> <span data-ttu-id="bb2d9-164">Почему?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-164">Why?</span></span>

<span data-ttu-id="bb2d9-165">A.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-165">A.</span></span> <span data-ttu-id="bb2d9-166">Проверьте контракт службы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-166">Check your service contract.</span></span> <span data-ttu-id="bb2d9-167">Возможно, вы забыли разместить "IsOneWay = `true` " во всех операциях службы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-167">You may have forgotten to put "IsOneWay=`true`" on all the service operations.</span></span> <span data-ttu-id="bb2d9-168">Очереди поддерживают только односторонние операции службы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-168">Queues support only one-way service operations.</span></span>

<span data-ttu-id="bb2d9-169">**Вопрос.** В очереди есть сообщения, но не вызвана операция службы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-169">**Q:** There are messages in the queue but no service operation is invoked.</span></span> <span data-ttu-id="bb2d9-170">В чем заключается проблема?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-170">What is the problem?</span></span>

<span data-ttu-id="bb2d9-171">Ответ **.** Определение сбоя узла службы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-171">**A:** Determine if your service host is faulted.</span></span> <span data-ttu-id="bb2d9-172">Убедиться в этом можно, просмотрев трассировку или реализовав `IErrorHandler`.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-172">You can check by looking at the trace or implementing `IErrorHandler`.</span></span> <span data-ttu-id="bb2d9-173">По умолчанию сбой узла службы происходит при обнаружении подозрительного сообщения.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-173">Service host faults, by default, if a poison message is detected.</span></span>

<span data-ttu-id="bb2d9-174">**Вопрос.** В очереди есть сообщения, но служба, размещенная в очереди, не активируется.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-174">**Q:** There are messages in the queue but my Web-hosted queued service is not getting activated.</span></span> <span data-ttu-id="bb2d9-175">Почему?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-175">Why?</span></span>

<span data-ttu-id="bb2d9-176">Ответ **.** Наиболее распространенная причина — разрешения.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-176">**A:** The most common reason is permissions.</span></span>

1. <span data-ttu-id="bb2d9-177">Убедитесь в том, что выполняется процесс `NetMsmqActivator` и удостоверению процесса `NetMsmqActivator` предоставлено разрешение на чтение и поиск для данной очереди.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-177">Ensure that the `NetMsmqActivator` process is running and the identity of the `NetMsmqActivator` process is given read and seek permission on the queue.</span></span>

2. <span data-ttu-id="bb2d9-178">Если процесс `NetMsmqActivator` отслеживает очереди на удаленном компьютере, убедитесь в том, что `NetMsmqActivator` не выполняется с маркером ограниченного доступа.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-178">If the `NetMsmqActivator` is monitoring queues on a remote machine, ensure that `NetMsmqActivator` does not run under a restricted token.</span></span> <span data-ttu-id="bb2d9-179">Чтобы выполнить процесс `NetMsmqActivator` с маркером неограниченного доступа, используется следующий код.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-179">To run the `NetMsmqActivator` with an unrestricted token:</span></span>

    ```console
    sc sidtype NetMsmqActivator unrestricted
    ```

<span data-ttu-id="bb2d9-180">Для проблем с веб-узлом, не связанными с безопасностью, см. [веб-узел, в котором размещено приложение в очереди](web-hosting-a-queued-application.md).</span><span class="sxs-lookup"><span data-stu-id="bb2d9-180">For non-security related Web host issues refer to: [Web Hosting a Queued Application](web-hosting-a-queued-application.md).</span></span>

<span data-ttu-id="bb2d9-181">**Вопрос.** Каков самый простой способ доступа к сеансам?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-181">**Q:** What is the easiest way to access sessions?</span></span>

<span data-ttu-id="bb2d9-182">Ответ **.** Задать Автозаполнение = `true` для операции, которая соответствует последнему сообщению в сеансе, и задать Автозаполнение = `false` для всех оставшихся операций службы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-182">**A:** Set AutoComplete=`true` on the operation that corresponds to the last message in the session, and set AutoComplete=`false` on all remaining service operations.</span></span>

<span data-ttu-id="bb2d9-183">**Вопрос.** Почему моя служба создает исключение `ProtocolException` при чтении из очереди, содержащей сообщения, помещенные в очередь, и сообщения, поставленные в очередь?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-183">**Q:** Why does my service throw a `ProtocolException` when reading from a queue that contains both queued session messages and queued datagram messages?</span></span>

<span data-ttu-id="bb2d9-184">Ответ **.** Существует фундаментальное различие в способе обмена сообщениями сеанса в очереди и сообщениями с датаграммами в очереди.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-184">**A:** There is a fundamental difference in the way queued session messages and queued datagram messages are composed.</span></span> <span data-ttu-id="bb2d9-185">Вследствие этого, служба, ожидающая чтения сообщения сеанса из очереди не может получить сообщение датаграммы из очереди, а служба, ожидающая чтения сообщения датаграммы из очереди не может получить сообщения сеанса.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-185">Because of this, a service that is expecting to read a queued session message cannot receive a queued datagram message and a service expecting to read a queued datagram message cannot receive a session message.</span></span> <span data-ttu-id="bb2d9-186">При попытке чтения сообщений обоих типов из одной очереди будет получено следующее исключение.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-186">Attempting to read both types of messages from the same queue throws the following exception:</span></span>

```console
System.ServiceModel.MsmqPoisonMessageException: The transport channel detected a poison message. This occurred because the message exceeded the maximum number of delivery attempts or because the channel detected a fundamental problem with the message. The inner exception may contain additional information.
---> System.ServiceModel.ProtocolException: An incoming MSMQ message contained invalid or unexpected .NET Message Framing information in its body. The message cannot be received. Ensure that the sender is using a compatible service contract with a matching SessionMode.
```

<span data-ttu-id="bb2d9-187">Системная очередь недоставленных сообщений, а также любая пользовательская очередь недоставленных сообщений особенно чувствительна к этой проблеме, если приложение отправляет с одного компьютера как сообщения сеанса в очереди, так и сообщения датаграммы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-187">The system dead-letter queue, as well as any custom dead-letter queue, is particularly susceptible to this issue if an application sends both queued session messages and queued datagram messages from the same computer.</span></span> <span data-ttu-id="bb2d9-188">Если сообщение не удается отправить, оно перемещается в очередь недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-188">If a message cannot be sent successfully, it is moved to the dead-letter queue.</span></span> <span data-ttu-id="bb2d9-189">При этих обстоятельствах в очереди недоставленных сообщений могут быть как сообщения сеанса, так и сообщения датаграмм.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-189">Under these circumstances, it is possible to have both session and datagram messages in the dead-letter queue.</span></span> <span data-ttu-id="bb2d9-190">При чтении из очереди во время выполнения отсутствует возможность разделения двух типов сообщений, поэтому приложения не должны отправлять сообщения сеанса в очереди и сообщения датаграмм в очереди с одного компьютера.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-190">There is no way to separate both types of messages at runtime when reading from a queue, therefore, applications should not send both queued session messages and queued datagram messages from the same computer.</span></span>

### <a name="msmq-integration-specific-troubleshooting"></a><span data-ttu-id="bb2d9-191">Интеграция MSMQ: устранение конкретных неполадок</span><span class="sxs-lookup"><span data-stu-id="bb2d9-191">MSMQ Integration: Specific Troubleshooting</span></span>

<span data-ttu-id="bb2d9-192">**Вопрос.** При отправке сообщения или открытии узла службы появляется сообщение об ошибке, показывающее, что схема неверна.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-192">**Q:** When I send a message, or when I open the service host, I get an error that indicates the scheme is wrong.</span></span> <span data-ttu-id="bb2d9-193">Почему?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-193">Why?</span></span>

<span data-ttu-id="bb2d9-194">Ответ **.** При использовании привязки интеграции MSMQ необходимо использовать схему MSMQ. formatname.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-194">**A:** When you use the MSMQ integration binding, you must use the msmq.formatname scheme.</span></span> <span data-ttu-id="bb2d9-195">Например, msmq.formatname:DIRECT=OS:.\private$\OrdersQueue.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-195">For example, msmq.formatname:DIRECT=OS:.\private$\OrdersQueue.</span></span> <span data-ttu-id="bb2d9-196">Однако если задана пользовательская очередь недоставленных сообщений, необходимо использовать схему net.msmq.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-196">But when you specify the custom dead-letter queue, you must use the net.msmq scheme.</span></span>

<span data-ttu-id="bb2d9-197">**Вопрос.** При использовании имени открытого или закрытого формата и открытии узла службы в Windows Vista появляется сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-197">**Q:** When I use a public or private format name and open the service host on Windows Vista, I get an error.</span></span> <span data-ttu-id="bb2d9-198">Почему?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-198">Why?</span></span>

<span data-ttu-id="bb2d9-199">Ответ **.** Канал интеграции WCF в Windows Vista проверяет, можно ли открыть подочередь для основной очереди приложения для обработки подозрительных сообщений.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-199">**A:** The WCF integration channel on Windows Vista checks to see if a subqueue can be opened for the main application queue for handling poison messages.</span></span> <span data-ttu-id="bb2d9-200">Имя подочереди является производным от URI MSMQ. formatname, переданного прослушивателю.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-200">The subqueue name is derived from an msmq.formatname URI passed to the listener.</span></span> <span data-ttu-id="bb2d9-201">Имя подочереди в MSMQ может иметь только прямое имя формата.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-201">The subqueue name in MSMQ can only be a direct format name.</span></span> <span data-ttu-id="bb2d9-202">Из-за этого возникает ошибка.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-202">So you see the error.</span></span> <span data-ttu-id="bb2d9-203">Измените URI очереди на непосредственное имя формата.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-203">Change the queue URI to a direct format name.</span></span>

<span data-ttu-id="bb2d9-204">**Вопрос.** При получении сообщения от приложения MSMQ оно находится в очереди и не считывается принимающим приложением WCF.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-204">**Q:** When receiving a message from an MSMQ application, the message sits in the queue and is not read by the receiving WCF application.</span></span> <span data-ttu-id="bb2d9-205">Почему?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-205">Why?</span></span>

<span data-ttu-id="bb2d9-206">Ответ **.** Проверьте, есть ли у сообщения текст.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-206">**A:** Check to see whether the message has a body.</span></span> <span data-ttu-id="bb2d9-207">Если в сообщении отсутствует тело, канал интеграции MSMQ игнорирует его.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-207">If the message has no body, the MSMQ integration channel ignores the message.</span></span> <span data-ttu-id="bb2d9-208">Реализуйте интерфейс `IErrorHandler`, чтобы получать уведомления об исключениях, и проверьте трассировки.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-208">Implement `IErrorHandler` to be notified of exceptions and check the traces.</span></span>

### <a name="security-related-troubleshooting"></a><span data-ttu-id="bb2d9-209">Устранение неполадок, связанных с безопасностью</span><span class="sxs-lookup"><span data-stu-id="bb2d9-209">Security-Related Troubleshooting</span></span>

<span data-ttu-id="bb2d9-210">**Вопрос.** При запуске примера, использующего привязку по умолчанию в режиме рабочей группы, сообщения могут отправляться, но никогда не получаются получателем.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-210">**Q:** When I run the sample that uses a default binding in workgroup mode, messages seem to get sent but are never received by the receiver.</span></span>

<span data-ttu-id="bb2d9-211">Ответ **.** По умолчанию сообщения подписываются с помощью внутреннего сертификата MSMQ, для которого требуется служба Active Directory Directory.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-211">**A:** By default, messages are signed using an MSMQ internal certificate that requires the Active Directory directory service.</span></span> <span data-ttu-id="bb2d9-212">В режиме рабочей группы происходит сбой подписи сообщения, так как служба каталогов Active Directory недоступна.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-212">In workgroup mode, because Active Directory is not available, signing the message fails.</span></span> <span data-ttu-id="bb2d9-213">Таким образом, в очереди недоставленных сообщений и причинах сбоя, например "Неправильная подпись", указывается.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-213">So the message lands in the dead-letter queue and failure cause, such as "Bad signature", is indicated.</span></span>

<span data-ttu-id="bb2d9-214">Чтобы обойти эту проблему, можно отключить систему безопасности.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-214">The workaround is to turn off security.</span></span> <span data-ttu-id="bb2d9-215">Это делается путем настройки <xref:System.ServiceModel.NetMsmqSecurity.Mode%2A>  =  <xref:System.ServiceModel.NetMsmqSecurityMode.None> для обеспечения работы в режиме рабочей группы.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-215">This is done by setting <xref:System.ServiceModel.NetMsmqSecurity.Mode%2A> = <xref:System.ServiceModel.NetMsmqSecurityMode.None> to make it work in workgroup mode.</span></span>

<span data-ttu-id="bb2d9-216">Как вариант можно получить <xref:System.ServiceModel.MsmqTransportSecurity> из свойства <xref:System.ServiceModel.NetMsmqSecurity.Transport%2A> и присвоить ему значение <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate>, а затем задать сертификат клиента.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-216">Another workaround is to get the <xref:System.ServiceModel.MsmqTransportSecurity> from the <xref:System.ServiceModel.NetMsmqSecurity.Transport%2A> property and set it to <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate>, and set the client certificate.</span></span>

<span data-ttu-id="bb2d9-217">Еще одним обходным путем является установка MSMQ с интеграцией Active Directory.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-217">Yet another workaround is to install MSMQ with Active Directory integration.</span></span>

<span data-ttu-id="bb2d9-218">**Вопрос.** При отправке сообщения с привязкой по умолчанию (включена безопасность транспорта) в Active Directory в очередь я получаю сообщение "внутренний сертификат не найден".</span><span class="sxs-lookup"><span data-stu-id="bb2d9-218">**Q:** When I send a message with default binding (transport security turned on) in Active Directory to a queue, I get an "internal certificate not found" message.</span></span> <span data-ttu-id="bb2d9-219">Как устранить эту проблему?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-219">How do I fix this?</span></span>

<span data-ttu-id="bb2d9-220">Ответ **.** Это означает, что сертификат в Active Directory для отправителя должен быть продлен.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-220">**A:** This means that the certificate in Active Directory for the sender must be renewed.</span></span> <span data-ttu-id="bb2d9-221">Для этого откройте **Панель управления**, **Администрирование**, **Управление компьютером**, щелкните правой кнопкой мыши **MSMQ** и выберите пункт **Свойства**.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-221">To do so, open **Control Panel**, **Administrative Tools**, **Computer Management**, right-click **MSMQ**, and select **Properties**.</span></span> <span data-ttu-id="bb2d9-222">Выберите вкладку **сертификат пользователя** и нажмите кнопку **продлить** .</span><span class="sxs-lookup"><span data-stu-id="bb2d9-222">Select the **User Certificate** tab and click the **Renew** button.</span></span>

<span data-ttu-id="bb2d9-223">**Вопрос.** Когда я отправил сообщение с помощью <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate> и указал сертификат для использования, я получаю сообщение "Недопустимый сертификат".</span><span class="sxs-lookup"><span data-stu-id="bb2d9-223">**Q:** When I send a message using <xref:System.ServiceModel.MsmqAuthenticationMode.Certificate> and specify the certificate to use, I get an "Invalid certificate" message.</span></span> <span data-ttu-id="bb2d9-224">Как устранить эту проблему?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-224">How do I fix this?</span></span>

<span data-ttu-id="bb2d9-225">Ответ **.** Нельзя использовать хранилище сертификатов локального компьютера с режимом сертификата.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-225">**A:** You cannot use a local machine certificate store with certificate mode.</span></span> <span data-ttu-id="bb2d9-226">Необходимо скопировать сертификат из хранилища сертификатов компьютера в хранилище текущего пользователя с помощью оснастки сертификатов.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-226">You have to copy the certificate from the machine certificate store to the current user store using the Certificate snap-in.</span></span> <span data-ttu-id="bb2d9-227">Чтобы получить оснастку сертификатов, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-227">To get the Certificate snap-in:</span></span>

1. <span data-ttu-id="bb2d9-228">Нажмите кнопку **Пуск**, выберите **выполнить**, введите `mmc` и нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-228">Click **Start**, select **Run**, type `mmc`, and click **OK**.</span></span>

2. <span data-ttu-id="bb2d9-229">В **консоли управления (MMC**) откройте меню **файл** и выберите **Добавить или удалить оснастку**.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-229">In the **Microsoft Management Console**, open the **File** menu and select **Add/Remove Snap-in**.</span></span>

3. <span data-ttu-id="bb2d9-230">В диалоговом окне " **Добавление или удаление оснастки** " нажмите кнопку " **Добавить** ".</span><span class="sxs-lookup"><span data-stu-id="bb2d9-230">In the **Add/Remove Snap-in** dialog box, click the **Add** button.</span></span>

4. <span data-ttu-id="bb2d9-231">В диалоговом окне **Добавить изолированную оснастку** выберите Сертификаты и нажмите кнопку **Добавить**.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-231">In the **Add Standalone Snap-in** dialog box, select Certificates and click **Add**.</span></span>

5. <span data-ttu-id="bb2d9-232">В диалоговом окне Оснастка " **Сертификаты** " выберите **Моя учетная запись пользователя** и нажмите кнопку **Готово**.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-232">In the **Certificates** snap-in dialog box, select **My user account,** and click **Finish**.</span></span>

6. <span data-ttu-id="bb2d9-233">Затем добавьте вторую оснастку сертификатов, выполнив предыдущие действия, но на этот раз выберите **учетная запись компьютера** и нажмите кнопку **Далее**.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-233">Next, add a second Certificates snap-in using the previous steps, but this time select **Computer account** and click **Next**.</span></span>

7. <span data-ttu-id="bb2d9-234">Выберите **Локальный компьютер**, а затем нажмите кнопку **Готово**.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-234">Select **Local Computer** and click **Finish**.</span></span> <span data-ttu-id="bb2d9-235">Теперь сертификаты можно перетаскивать из хранилища сертификатов компьютера в хранилище текущего пользователя.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-235">You can now drag and drop certificates from the machine certificate store to the current user store.</span></span>

<span data-ttu-id="bb2d9-236">**Вопрос.** Когда моя служба считывает данные из очереди на другом компьютере в режиме рабочей группы, я получаю исключение "доступ запрещен".</span><span class="sxs-lookup"><span data-stu-id="bb2d9-236">**Q:** When my service reads from a queue on another computer in workgroup mode, I get an "access denied" exception.</span></span>

<span data-ttu-id="bb2d9-237">Ответ **.** В режиме рабочей группы для удаленного приложения, чтобы получить доступ к очереди, приложение должно иметь разрешение на доступ к очереди.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-237">**A:** In workgroup mode, for a remote application to gain access to the queue, the application must have permission to access the queue.</span></span> <span data-ttu-id="bb2d9-238">Добавьте анонимный вход в список управления доступом (ACL) очереди и предоставьте ему разрешение на чтение.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-238">Add "Anonymous login" to the queue's access control list (ACL) and give it read permission.</span></span>

<span data-ttu-id="bb2d9-239">**Вопрос.** Если клиент сетевой службы (или любой клиент, не имеющий учетной записи домена) отправляет сообщение в очереди, происходит сбой отправки с недопустимым сертификатом.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-239">**Q:** When a network service client (or any client that does not have a domain account) sends a queued message, the send fails with an invalid certificate.</span></span> <span data-ttu-id="bb2d9-240">Как устранить эту проблему?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-240">How do I fix this?</span></span>

<span data-ttu-id="bb2d9-241">Ответ **.** Проверьте конфигурацию привязки.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-241">**A:** Check the binding configuration.</span></span> <span data-ttu-id="bb2d9-242">В привязке по умолчанию включена безопасность транспорта MSMQ для подписи сообщения.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-242">The default binding has MSMQ transport security turned on to sign the message.</span></span> <span data-ttu-id="bb2d9-243">Отключите ее.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-243">Turn it off.</span></span>

### <a name="remote-transacted-receives"></a><span data-ttu-id="bb2d9-244">Удаленное получение транзакций</span><span class="sxs-lookup"><span data-stu-id="bb2d9-244">Remote Transacted Receives</span></span>

<span data-ttu-id="bb2d9-245">**Вопрос.** Если у меня есть очередь на компьютере а и служба WCF, считывающая сообщения из очереди на компьютере б (сценарий удаленного приема транзакций), сообщения не считываются из очереди.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-245">**Q:** When I have a queue on machine A, and a WCF service that reads messages from a queue on machine B (the remote transacted receive scenario), messages are not read from the queue.</span></span> <span data-ttu-id="bb2d9-246">Сведения трассировки указывают на сбой получения с сообщением "не удается импортировать транзакцию".</span><span class="sxs-lookup"><span data-stu-id="bb2d9-246">Tracing information indicates the receive failed with the message "Transaction cannot be imported."</span></span> <span data-ttu-id="bb2d9-247">Как это исправить?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-247">What can I do to fix this?</span></span>

<span data-ttu-id="bb2d9-248">Ответ **.** Существует три возможных причины этого.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-248">**A:** There are three possible reasons for this:</span></span>

- <span data-ttu-id="bb2d9-249">В режиме домена для удаленного получения транзакций требуется доступ к сети координатора распределенных транзакций (Майкрософт) (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="bb2d9-249">If you are in domain mode, remote transacted receive requires Microsoft Distributed Transaction Coordinator (MSDTC) network access.</span></span> <span data-ttu-id="bb2d9-250">Его можно включить с помощью **компонента "Добавление и удаление компонентов**".</span><span class="sxs-lookup"><span data-stu-id="bb2d9-250">You can enable this using **Add/Remove Components**.</span></span>

  ![Снимок экрана, показывающий включение доступа к сети DTC.](./media/troubleshooting-queued-messaging/enable-distributed-transaction-coordinator-access.jpg)

- <span data-ttu-id="bb2d9-252">Проверьте режим проверки подлинности для взаимодействия с диспетчером транзакций.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-252">Check the authentication mode for communicating with the transaction manager.</span></span> <span data-ttu-id="bb2d9-253">Если вы используете режим рабочей группы, необходимо выбрать параметр "не требуется проверка подлинности".</span><span class="sxs-lookup"><span data-stu-id="bb2d9-253">If you are in workgroup mode, "No Authentication Required" must be selected.</span></span> <span data-ttu-id="bb2d9-254">Если вы используете режим домена, необходимо выбрать "требуется взаимная проверка подлинности".</span><span class="sxs-lookup"><span data-stu-id="bb2d9-254">If you are in domain mode, then "Mutual Authentication Required" must be selected.</span></span>

  <span data-ttu-id="bb2d9-255">![Включение транзакций XA](media/4f3695e0-fb0b-4c5b-afac-75f8860d2bb0.jpg "4f3695e0-fb0b-4c5b-afac-75f8860d2bb0")</span><span class="sxs-lookup"><span data-stu-id="bb2d9-255">![Enabling XA transactions](media/4f3695e0-fb0b-4c5b-afac-75f8860d2bb0.jpg "4f3695e0-fb0b-4c5b-afac-75f8860d2bb0")</span></span>

- <span data-ttu-id="bb2d9-256">Убедитесь, что служба MSDTC находится в списке исключений в параметрах **брандмауэра подключения к Интернету** .</span><span class="sxs-lookup"><span data-stu-id="bb2d9-256">Make sure that MSDTC is in the list of exceptions in the **Internet Connection Firewall** settings.</span></span>

- <span data-ttu-id="bb2d9-257">Убедитесь, что используется Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-257">Ensure that you are using Windows Vista.</span></span> <span data-ttu-id="bb2d9-258">MSMQ в Windows Vista поддерживает удаленное чтение транзакций.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-258">MSMQ on Windows Vista supports remote transacted read.</span></span> <span data-ttu-id="bb2d9-259">MSMQ в более ранних версиях Windows не поддерживает удаленное чтение в транзакциях.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-259">MSMQ on earlier Windows releases does not support remote transacted read.</span></span>

<span data-ttu-id="bb2d9-260">**Вопрос.** Если служба считывается из очереди в качестве сетевой службы, например, на веб-узле, почему при чтении из очереди возникает исключение "доступ запрещен"?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-260">**Q:** When the service reading from the queue is a network service, for example, in a Web host, why do I get an access-denied exception is raised when reading from the queue?</span></span>

<span data-ttu-id="bb2d9-261">Ответ **.** Доступ для чтения сетевой службы должен быть добавлен к списку ACL очереди, чтобы сетевая служба могла выполнять чтение из очереди.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-261">**A:** Network service read access must be added to the queue ACL to ensure that a network service can read from the queue.</span></span>

<span data-ttu-id="bb2d9-262">**Вопрос.** Можно ли использовать службу активации MSMQ для активации приложений на основе сообщений в очереди на удаленном компьютере?</span><span class="sxs-lookup"><span data-stu-id="bb2d9-262">**Q:** Can I use the MSMQ activation service to activate applications based on messages in a queue on a remote machine?</span></span>

<span data-ttu-id="bb2d9-263">**Ответ.** Да.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-263">**A:** Yes.</span></span> <span data-ttu-id="bb2d9-264">Для этого необходимо настроить службу активации MSMQ для выполнения в качестве сетевой службы, а также добавить доступ сетевой службы к очереди на удаленном компьютере.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-264">To do this, you must configure the MSMQ activation service to run as a network service, and add network service access to the queue on the remote machine.</span></span>

## <a name="using-custom-msmq-bindings-with-receivecontext-enabled"></a><span data-ttu-id="bb2d9-265">Использование пользовательских привязок MSMQ с включенным ReceiveContext</span><span class="sxs-lookup"><span data-stu-id="bb2d9-265">Using Custom MSMQ Bindings with ReceiveContext Enabled</span></span>

<span data-ttu-id="bb2d9-266">При использовании настраиваемой привязки MSMQ с <xref:System.ServiceModel.Channels.ReceiveContext> включенной функцией обработка входящего сообщения использует поток пула потоков, так как собственный MSMQ не поддерживает завершение ввода-вывода для асинхронного <xref:System.ServiceModel.Channels.ReceiveContext> получения.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-266">When using a custom MSMQ binding with <xref:System.ServiceModel.Channels.ReceiveContext> enabled, processing an incoming message uses a thread pool thread because native MSMQ doesn't support I/O completion for asynchronous <xref:System.ServiceModel.Channels.ReceiveContext> receives.</span></span> <span data-ttu-id="bb2d9-267">Это обусловлено тем, что обработка такого сообщения использует внутренние транзакции для <xref:System.ServiceModel.Channels.ReceiveContext> и MSMQ не поддерживает асинхронную обработку.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-267">This is because processing such a message uses internal transactions for <xref:System.ServiceModel.Channels.ReceiveContext> and MSMQ doesn't support asynchronous processing.</span></span> <span data-ttu-id="bb2d9-268">Чтобы обойти эту ошибку, можно добавить <xref:System.ServiceModel.Description.SynchronousReceiveBehavior> в конечную точку, чтобы принудительно выполнить синхронную обработку или установить значение <xref:System.ServiceModel.Description.DispatcherSynchronizationBehavior.MaxPendingReceives%2A> 1.</span><span class="sxs-lookup"><span data-stu-id="bb2d9-268">To work around this issue, you can add a <xref:System.ServiceModel.Description.SynchronousReceiveBehavior> to the endpoint to force synchronous processing or set <xref:System.ServiceModel.Description.DispatcherSynchronizationBehavior.MaxPendingReceives%2A> to 1.</span></span>
