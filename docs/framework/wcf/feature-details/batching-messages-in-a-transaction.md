---
description: Дополнительные сведения о пакетной обработке сообщений в транзакции
title: Объединение сообщений в одну транзакцию
ms.date: 03/30/2017
helpviewer_keywords:
- batching messages [WCF]
ms.assetid: 53305392-e82e-4e89-aedc-3efb6ebcd28c
ms.openlocfilehash: 0c84d87bc043f4ce1ae4d0a7674e862aa10011ac
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99643700"
---
# <a name="batching-messages-in-a-transaction"></a><span data-ttu-id="32c62-103">Объединение сообщений в одну транзакцию</span><span class="sxs-lookup"><span data-stu-id="32c62-103">Batching Messages in a Transaction</span></span>

<span data-ttu-id="32c62-104">Для обеспечения правильной и надежной доставки сообщений в приложениях с очередью используются транзакции.</span><span class="sxs-lookup"><span data-stu-id="32c62-104">Queued applications use transactions to ensure correctness and reliable delivery of messages.</span></span> <span data-ttu-id="32c62-105">Однако транзакции являются очень ресурсоемкими операциями и могут очень сильно снизить пропускную способность при передаче сообщений.</span><span class="sxs-lookup"><span data-stu-id="32c62-105">Transactions, however, are expensive operations and can dramatically reduce message throughput.</span></span> <span data-ttu-id="32c62-106">Одним из способов повышения пропускной способности при передаче сообщений является чтение и обработка приложением нескольких сообщений в одной транзакции.</span><span class="sxs-lookup"><span data-stu-id="32c62-106">One way to improve message throughput is to have an application read and process multiple messages within a single transaction.</span></span> <span data-ttu-id="32c62-107">Компромисс заключается в балансе производительности и объема восстановления: так как количество сообщений в пакете возрастает, также возрастает объем работы по восстановлению, которую необходимо выполнить при откате транзакции.</span><span class="sxs-lookup"><span data-stu-id="32c62-107">The trade-off is between performance and recovery: as the number of messages in a batch increases, so does the amount of recovery work that required if transactions are rolled back.</span></span> <span data-ttu-id="32c62-108">Важно отметить разницу между объединением сообщений в пакеты в транзакции и в сеансах.</span><span class="sxs-lookup"><span data-stu-id="32c62-108">It is important to note the difference between batching messages in a transaction and sessions.</span></span> <span data-ttu-id="32c62-109">*Сеанс* — это группа связанных сообщений, обрабатываемых одним приложением и зафиксированных как единое целое.</span><span class="sxs-lookup"><span data-stu-id="32c62-109">A *session* is a grouping of related messages that are processed by a single application and committed as a single unit.</span></span> <span data-ttu-id="32c62-110">Сеансы обычно используются, если группа связанных сообщений должна обрабатываться совместно.</span><span class="sxs-lookup"><span data-stu-id="32c62-110">Sessions are generally used when a group of related messages must be processed together.</span></span> <span data-ttu-id="32c62-111">В качестве примера можно привести веб-сайт интернет-магазина.</span><span class="sxs-lookup"><span data-stu-id="32c62-111">An example of this is an online shopping Web site.</span></span> <span data-ttu-id="32c62-112">*Пакеты* используются для обработки нескольких несвязанных сообщений таким образом, чтобы повысить пропускную способность сообщений.</span><span class="sxs-lookup"><span data-stu-id="32c62-112">*Batches* are used to process multiple, unrelated messages in a way that increases message throughput.</span></span> <span data-ttu-id="32c62-113">Дополнительные сведения о сеансах см. [в разделе Группирование сообщений, помещенных в очередь, в сеансе](grouping-queued-messages-in-a-session.md).</span><span class="sxs-lookup"><span data-stu-id="32c62-113">For more information about sessions, see [Grouping Queued Messages in a Session](grouping-queued-messages-in-a-session.md).</span></span> <span data-ttu-id="32c62-114">Сообщения из пакета также обрабатываются одним приложением и фиксируются как единый блок, однако связь между сообщениями из пакета отсутствует.</span><span class="sxs-lookup"><span data-stu-id="32c62-114">Messages in a batch are also processed by a single application and committed as a single unit, but there may be no relationship between the messages in the batch.</span></span> <span data-ttu-id="32c62-115">Объединение сообщений в пакеты внутри транзакции - это способ оптимизации, не влияющий на работу приложения.</span><span class="sxs-lookup"><span data-stu-id="32c62-115">Batching messages in a transaction is an optimization that does not change how the application runs.</span></span>  
  
## <a name="entering-batching-mode"></a><span data-ttu-id="32c62-116">Вход в пакетный режим</span><span class="sxs-lookup"><span data-stu-id="32c62-116">Entering Batching Mode</span></span>  

 <span data-ttu-id="32c62-117">Пакетная обработка управляется поведением конечной точки <xref:System.ServiceModel.Description.TransactedBatchingBehavior>.</span><span class="sxs-lookup"><span data-stu-id="32c62-117">The <xref:System.ServiceModel.Description.TransactedBatchingBehavior> endpoint behavior controls batching.</span></span> <span data-ttu-id="32c62-118">Добавление этого поведения конечной точки в конечную точку службы сообщает Windows Communication Foundation (WCF) пакетным сообщениям в транзакции.</span><span class="sxs-lookup"><span data-stu-id="32c62-118">Adding this endpoint behavior to a service endpoint tells Windows Communication Foundation (WCF) to batch messages in a transaction.</span></span> <span data-ttu-id="32c62-119">Не все сообщения нуждаются в транзакции, поэтому только сообщения, требующие транзакции, помещаются в пакет и учитываются только сообщения, отправленные из операций, помеченных как `TransactionScopeRequired`  =  `true` и `TransactionAutoComplete`  =  `true` , для пакета.</span><span class="sxs-lookup"><span data-stu-id="32c62-119">Not all messages require a transaction, so only messages that require a transaction are placed in a batch, and only messages sent from operations marked with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true` are considered for a batch.</span></span> <span data-ttu-id="32c62-120">Если все операции в контракте службы помечены как `TransactionScopeRequired`  =  `false` и `TransactionAutoComplete`  =  `false` , то режим пакетной обработки никогда не указывается.</span><span class="sxs-lookup"><span data-stu-id="32c62-120">If all operations on the service contract are marked with `TransactionScopeRequired` = `false` and `TransactionAutoComplete` = `false`, then batching mode is never entered.</span></span>  
  
## <a name="committing-a-transaction"></a><span data-ttu-id="32c62-121">Фиксация транзакции</span><span class="sxs-lookup"><span data-stu-id="32c62-121">Committing a Transaction</span></span>  

 <span data-ttu-id="32c62-122">Пакетная транзакция фиксируется на основе следующих параметров.</span><span class="sxs-lookup"><span data-stu-id="32c62-122">A batched transaction is committed based on the following:</span></span>  
  
- <span data-ttu-id="32c62-123">`MaxBatchSize`.</span><span class="sxs-lookup"><span data-stu-id="32c62-123">`MaxBatchSize`.</span></span> <span data-ttu-id="32c62-124">Свойство поведения <xref:System.ServiceModel.Description.TransactedBatchingBehavior>.</span><span class="sxs-lookup"><span data-stu-id="32c62-124">A property of the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> behavior.</span></span> <span data-ttu-id="32c62-125">Это свойство определяет максимальное количество сообщений, помещаемых в пакет.</span><span class="sxs-lookup"><span data-stu-id="32c62-125">This property determines the maximum number of messages that are placed into a batch.</span></span> <span data-ttu-id="32c62-126">При достижении этого количества производится фиксация пакета.</span><span class="sxs-lookup"><span data-stu-id="32c62-126">When this number is reached, the batch is committed.</span></span> <span data-ttu-id="32c62-127">Это значение не является строгим ограничением, возможна фиксация пакета до достижения этого количества сообщений.</span><span class="sxs-lookup"><span data-stu-id="32c62-127">This is value is not a strict limit, it is possible to commit a batch before receiving this number of messages.</span></span>  
  
- <span data-ttu-id="32c62-128">`Transaction Timeout`.</span><span class="sxs-lookup"><span data-stu-id="32c62-128">`Transaction Timeout`.</span></span> <span data-ttu-id="32c62-129">По истечении 80 процентов времени ожидания транзакции пакет фиксируется и создается новый пакет.</span><span class="sxs-lookup"><span data-stu-id="32c62-129">After 80 percent of the transaction's time-out has elapsed, the batch is committed and a new batch is created.</span></span> <span data-ttu-id="32c62-130">Это означает, что если от времени, выделенного для завершения транзакции, осталось 20 процентов или менее, пакет фиксируется.</span><span class="sxs-lookup"><span data-stu-id="32c62-130">This means that if 20 percent or less of the time given for a transaction to complete remains, the batch is committed.</span></span>  
  
- <span data-ttu-id="32c62-131">`TransactionScopeRequired`.</span><span class="sxs-lookup"><span data-stu-id="32c62-131">`TransactionScopeRequired`.</span></span> <span data-ttu-id="32c62-132">При обработке пакета сообщений, если WCF находит одну из них, `TransactionScopeRequired`  =  `false` зафиксирует пакет и повторно открывает новый пакет при получении первого сообщения с помощью `TransactionScopeRequired`  =  `true` и `TransactionAutoComplete`  =  `true` .</span><span class="sxs-lookup"><span data-stu-id="32c62-132">When processing a batch of messages, if WCF finds one that has `TransactionScopeRequired` = `false`, it commits the batch and reopens a new batch on receipt of the first message with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true`.</span></span>  
  
- <span data-ttu-id="32c62-133">Если в очереди больше нет сообщений, текущий пакет фиксируется, даже если еще не достигнуто значение `MaxBatchSize` и 80 процентов времени ожидания транзакции еще не истекли.</span><span class="sxs-lookup"><span data-stu-id="32c62-133">If no more messages exist in the queue, then the current batch is committed, even if the `MaxBatchSize` has not been reached or 80 percent of the transaction's time-out has not elapsed.</span></span>  
  
## <a name="leaving-batching-mode"></a><span data-ttu-id="32c62-134">Выход из пакетного режима</span><span class="sxs-lookup"><span data-stu-id="32c62-134">Leaving Batching Mode</span></span>  

 <span data-ttu-id="32c62-135">Если сообщение из пакета приводит к прерыванию транзакции, выполняются следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="32c62-135">If a message in a batch causes the transaction to abort, the following steps occur:</span></span>  
  
1. <span data-ttu-id="32c62-136">Производится откат всего пакета сообщений.</span><span class="sxs-lookup"><span data-stu-id="32c62-136">The entire batch of messages is rolled back.</span></span>  
  
2. <span data-ttu-id="32c62-137">Сообщения считываются по одному до тех пор, пока количество сообщений не превысит удвоенного максимального размера пакета.</span><span class="sxs-lookup"><span data-stu-id="32c62-137">Messages are read one at a time until the number of messages read exceeds twice the maximum batch size.</span></span>  
  
3. <span data-ttu-id="32c62-138">Производится повторный вход в пакетный режим.</span><span class="sxs-lookup"><span data-stu-id="32c62-138">Batch mode is re-entered.</span></span>  
  
## <a name="choosing-the-batch-size"></a><span data-ttu-id="32c62-139">Выбор размера пакета</span><span class="sxs-lookup"><span data-stu-id="32c62-139">Choosing the Batch Size</span></span>  

 <span data-ttu-id="32c62-140">Размер пакета зависит от приложения.</span><span class="sxs-lookup"><span data-stu-id="32c62-140">The size of a batch is application-dependent.</span></span> <span data-ttu-id="32c62-141">Лучше всего определять оптимальный размер пакета для приложения эмпирическим путем.</span><span class="sxs-lookup"><span data-stu-id="32c62-141">The empirical method is the best way to arrive at an optimal batch size for the application.</span></span> <span data-ttu-id="32c62-142">При выборе размера пакета важно выбирать размер в соответствии с фактической моделью развертывания приложения.</span><span class="sxs-lookup"><span data-stu-id="32c62-142">It is important to remember when choosing a batch size to choose the size according to your application's actual deployment model.</span></span> <span data-ttu-id="32c62-143">Например, если при развертывании приложения требуются сервер SQL Server на удаленном компьютере и транзакции, охватывающие очередь и этот сервер SQL Server, то размер пакета лучше всего определять при работе именно в такой конфигурации.</span><span class="sxs-lookup"><span data-stu-id="32c62-143">For example, when deploying the application, if you need an SQL server on a remote machine and a transaction that spans the queue and the SQL server, then the batch size is best determined by running this exact configuration.</span></span>  
  
## <a name="concurrency-and-batching"></a><span data-ttu-id="32c62-144">Параллелизм и пакетная обработка</span><span class="sxs-lookup"><span data-stu-id="32c62-144">Concurrency and Batching</span></span>  

 <span data-ttu-id="32c62-145">Для увеличения пропускной способности возможна также параллельная обработка нескольких пакетов.</span><span class="sxs-lookup"><span data-stu-id="32c62-145">To increase throughput, you can also have many batches run concurrently.</span></span> <span data-ttu-id="32c62-146">Задав значение `ConcurrencyMode.Multiple` в атрибуте `ServiceBehaviorAttribute`, можно включить параллельную пакетную обработку.</span><span class="sxs-lookup"><span data-stu-id="32c62-146">By setting `ConcurrencyMode.Multiple` in `ServiceBehaviorAttribute`, you enable concurrent batching.</span></span>  
  
 <span data-ttu-id="32c62-147">*Регулирование службы* — это поведение службы, которое используется для указания того, сколько одновременных вызовов может быть выполнено в службе.</span><span class="sxs-lookup"><span data-stu-id="32c62-147">*Service throttling* is a service behavior that is used to indicate how many maximum concurrent calls can be made on the service.</span></span> <span data-ttu-id="32c62-148">При использовании с пакетной обработкой это означает количество параллельно обрабатываемых пакетов.</span><span class="sxs-lookup"><span data-stu-id="32c62-148">When used with batching, this is interpreted as how many concurrent batches can be run.</span></span> <span data-ttu-id="32c62-149">Если регулирование службы не задано, WCF по умолчанию устанавливает максимальное число одновременных вызовов до 16.</span><span class="sxs-lookup"><span data-stu-id="32c62-149">If the service throttling is not set, WCF defaults the maximum concurrent calls to 16.</span></span> <span data-ttu-id="32c62-150">Таким образом, если поведение пакетной обработки было добавлено по умолчанию, одновременно может быть активно не более 16 пакетов.</span><span class="sxs-lookup"><span data-stu-id="32c62-150">Thus, if batching behavior were added by default, a maximum of 16 batches can be active at the same time.</span></span> <span data-ttu-id="32c62-151">Лучше всего настроить регулирование службы и пакетную обработку на основе реальных объемов.</span><span class="sxs-lookup"><span data-stu-id="32c62-151">It is best to tune the service throttling and batching based on your capacity.</span></span> <span data-ttu-id="32c62-152">Например, если очередь содержит 100 сообщений и требуются 20 пакетов, задавать значение 16 в качестве максимального количества параллельных вызовов бесполезно, так как, в зависимости от пропускной способности, могут быть активны 16 транзакций, что равносильно просто выключению пакетной обработки.</span><span class="sxs-lookup"><span data-stu-id="32c62-152">For example, if the queue has 100 messages and a batch of 20 is desired, having the maximum concurrent calls set to 16 is not useful because, depending on throughput, 16 transactions could be active, similar to not having batching turned on.</span></span> <span data-ttu-id="32c62-153">Поэтому при тонкой настройке производительности либо выключите параллельную пакетную обработку, либо включите ее с правильным значением регулирования службы.</span><span class="sxs-lookup"><span data-stu-id="32c62-153">Therefore, when fine-tuning for performance, either do not have concurrent batching or have concurrent batching with the correct service throttle size.</span></span>  
  
## <a name="batching-and-multiple-endpoints"></a><span data-ttu-id="32c62-154">Пакетная обработка и несколько конечных точек</span><span class="sxs-lookup"><span data-stu-id="32c62-154">Batching and Multiple Endpoints</span></span>  

 <span data-ttu-id="32c62-155">Конечная точка состоит из адреса и контракта.</span><span class="sxs-lookup"><span data-stu-id="32c62-155">An endpoint is composed of an address and a contract.</span></span> <span data-ttu-id="32c62-156">Могут существовать несколько конечных точек, совместно использующих одну привязку.</span><span class="sxs-lookup"><span data-stu-id="32c62-156">There may be multiple endpoints that share the same binding.</span></span> <span data-ttu-id="32c62-157">Две конечные точки могут совместно использовать одну привязку и ожидать передачи данных по универсальному коду ресурса (URI) или адресу очереди.</span><span class="sxs-lookup"><span data-stu-id="32c62-157">It is possible for two endpoints to share the same binding and listen Uniform Resource Identifier (URI), or queue address.</span></span> <span data-ttu-id="32c62-158">Если две конечные точки производят чтение из одной очереди и поведение пакетной обработки с транзакциями добавлено в обе конечные точки, возможно возникновение конфликта между заданными размерами пакетов.</span><span class="sxs-lookup"><span data-stu-id="32c62-158">If two endpoints are reading from the same queue, and transacted batching behavior is added to both endpoints, a conflict in the batch sizes specified could arise.</span></span> <span data-ttu-id="32c62-159">Этот конфликт устраняется реализацией пакетной обработки с использованием минимального размера пакета из заданных в двух поведениях пакетной обработки с транзакциями.</span><span class="sxs-lookup"><span data-stu-id="32c62-159">This is resolved by implementing batching using the minimal batch size specified between the two transacted batching behaviors.</span></span> <span data-ttu-id="32c62-160">Если в этом сценарии для одной конечной точки не задана пакетная обработка с транзакциями, пакетная обработка не будет использоваться в обеих конечных точках.</span><span class="sxs-lookup"><span data-stu-id="32c62-160">In this scenario, if one of the endpoints does not specify transacted batching, then both endpoints would not use batching.</span></span>  
  
## <a name="example"></a><span data-ttu-id="32c62-161">Пример</span><span class="sxs-lookup"><span data-stu-id="32c62-161">Example</span></span>  

 <span data-ttu-id="32c62-162">В следующем примере показано, как задать `TransactedBatchingBehavior` в файле конфигурации.</span><span class="sxs-lookup"><span data-stu-id="32c62-162">The following example shows how to specify the `TransactedBatchingBehavior` in a configuration file.</span></span>  
  
```xml  
<behaviors>
  <endpointBehaviors>
    <behavior name="TransactedBatchingBehavior"
              maxBatchSize="100" />
  </endpointBehaviors>
</behaviors>
```  
  
 <span data-ttu-id="32c62-163">В следующем примере показано, как задать <xref:System.ServiceModel.Description.TransactedBatchingBehavior> в коде.</span><span class="sxs-lookup"><span data-stu-id="32c62-163">The following example shows how to specify the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> in code.</span></span>  
  
```csharp
using (ServiceHost serviceHost = new ServiceHost(typeof(OrderProcessorService)))
{
     ServiceEndpoint sep = ServiceHost.AddServiceEndpoint(typeof(IOrderProcessor), new NetMsmqBinding(), "net.msmq://localhost/private/ServiceModelSamplesTransacted");
     sep.Behaviors.Add(new TransactedBatchingBehavior(100));

     // Open the ServiceHost to create listeners and start listening for messages.
    serviceHost.Open();
  
    // The service can now be accessed.
    Console.WriteLine("The service is ready.");
    Console.WriteLine("Press <ENTER> to terminate service.");
    Console.WriteLine();
    Console.ReadLine();
  
    // Close the ServiceHostB to shut down the service.
    serviceHost.Close();
}  
```  
  
## <a name="see-also"></a><span data-ttu-id="32c62-164">См. также</span><span class="sxs-lookup"><span data-stu-id="32c62-164">See also</span></span>

- [<span data-ttu-id="32c62-165">Общие сведения об очередях</span><span class="sxs-lookup"><span data-stu-id="32c62-165">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="32c62-166">Очереди в WCF</span><span class="sxs-lookup"><span data-stu-id="32c62-166">Queuing in WCF</span></span>](queuing-in-wcf.md)
