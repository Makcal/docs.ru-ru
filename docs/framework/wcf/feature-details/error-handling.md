---
description: Дополнительные сведения об обработке ошибок в Windows Communication Foundation (WCF)
title: Обработка ошибок
ms.date: 03/30/2017
ms.assetid: c948841a-7db9-40ae-9b78-587d216cbcaf
ms.openlocfilehash: e09c07037e2b3398e2f82307242032a29c356ce5
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99704775"
---
# <a name="error-handling-in-windows-communication-foundation-wcf"></a><span data-ttu-id="f58eb-103">Обработка ошибок в Windows Communication Foundation (WCF)</span><span class="sxs-lookup"><span data-stu-id="f58eb-103">Error handling in Windows Communication Foundation (WCF)</span></span>

<span data-ttu-id="f58eb-104">Есть несколько способов проектирования решений по обработке исключений, когда служба обнаруживает непредвиденное исключение или ошибку.</span><span class="sxs-lookup"><span data-stu-id="f58eb-104">When a service encounters an unexpected exception or error, there are multiple ways to design an exception-handling solution.</span></span> <span data-ttu-id="f58eb-105">Хотя не существует единого решения для обработки ошибок или рекомендации, существует несколько допустимых путей, которые следует учитывать.</span><span class="sxs-lookup"><span data-stu-id="f58eb-105">While there is no single "correct" or "best practice" error-handling solution, there are multiple valid paths for one to consider.</span></span> <span data-ttu-id="f58eb-106">Обычно рекомендуется реализовать гибридное решение, объединяющее несколько подходов из приведенного ниже списка, в зависимости от сложности реализации WCF, типа и частоты исключений, обработанной и необработанной природы исключений, а также любых связанных с трассировкой, ведением журнала или требований политики.</span><span class="sxs-lookup"><span data-stu-id="f58eb-106">It is normally recommended that one implement a hybrid solution that combines multiple approaches from the list below, depending on the complexity of the WCF implementation, the type and frequency of the exceptions, the handled vs. unhandled nature of the exceptions, and any associated tracing, logging, or policy requirements.</span></span>

<span data-ttu-id="f58eb-107">Эти решения более подробно рассматриваются далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="f58eb-107">These solutions are explained more deeply in the rest of this section.</span></span>

## <a name="the-microsoft-enterprise-library"></a><span data-ttu-id="f58eb-108">Библиотека Microsoft Enterprise</span><span class="sxs-lookup"><span data-stu-id="f58eb-108">The Microsoft Enterprise Library</span></span>

<span data-ttu-id="f58eb-109">Программный блок обработки исключений библиотеки Microsoft Enterprise помогает реализовать общие принципы проектирования и создать согласованную стратегию обработки исключений, возникающих на всех уровнях архитектуры корпоративного приложения.</span><span class="sxs-lookup"><span data-stu-id="f58eb-109">The Microsoft Enterprise Library Exception Handling Application Block helps implement common design patterns and create a consistent strategy for processing exceptions that occur in all architectural layers of an enterprise application.</span></span> <span data-ttu-id="f58eb-110">Он предназначен для поддержки обычного кода, содержащегося в инструкциях CATCH в компонентах приложения.</span><span class="sxs-lookup"><span data-stu-id="f58eb-110">It is designed to support the typical code contained in catch statements in application components.</span></span> <span data-ttu-id="f58eb-111">Вместо того чтобы повторять этот код (например, код, который записывает сведения об исключении в журнал) в двух одинаковых блоках CATCH по всему приложению, можно использовать программный блок обработки исключений, который позволяет разработчикам инкапсулировать эту логику в многократно используемых обработчиках исключений.</span><span class="sxs-lookup"><span data-stu-id="f58eb-111">Instead of repeating this code (such as code that logs exception information) in identical catch blocks throughout an application, the Exception Handling Application Block allows developers to encapsulate this logic as reusable exception handlers.</span></span>

<span data-ttu-id="f58eb-112">В состав этой библиотеки входит готовый обработчик исключений контрактов ошибок.</span><span class="sxs-lookup"><span data-stu-id="f58eb-112">This Library includes out-of-the-box a Fault Contract Exception Handler.</span></span> <span data-ttu-id="f58eb-113">Этот обработчик исключений предназначен для использования в границах службы WCF и создает новый контракт сбоя из исключения.</span><span class="sxs-lookup"><span data-stu-id="f58eb-113">This exception handler is designed for use at WCF service boundaries, and generates a new Fault Contract from the exception.</span></span>

<span data-ttu-id="f58eb-114">Программные блоки предназначены для встраивания широко используемых методов и обеспечивают общий подход к обработке исключений в пределах всего приложения.</span><span class="sxs-lookup"><span data-stu-id="f58eb-114">Application blocks aim to incorporate commonly used best practices and provide a common approach for exception handling throughout your application.</span></span> <span data-ttu-id="f58eb-115">С другой стороны, могут быть весьма полезными самостоятельно разрабатываемые пользовательские обработчики ошибок и контракты ошибок.</span><span class="sxs-lookup"><span data-stu-id="f58eb-115">On the other hand, custom error handlers and fault contracts developed on one’s own can also be very useful.</span></span> <span data-ttu-id="f58eb-116">Например, пользовательские обработчики ошибок предоставляют отличную возможность автоматически повышать все исключения до уровня FaultExceptions, а также добавляют в приложение возможности ведения журналов.</span><span class="sxs-lookup"><span data-stu-id="f58eb-116">For instance, custom error handlers provide an excellent opportunity to automatically promote all exceptions to FaultExceptions and also to add logging capabilities to your application.</span></span>

<span data-ttu-id="f58eb-117">Дополнительные сведения см. в [статье корпоративная библиотека Microsoft](/previous-versions/msp-n-p/ff632023(v=pandp.10)).</span><span class="sxs-lookup"><span data-stu-id="f58eb-117">For more information, please see [Microsoft Enterprise Library](/previous-versions/msp-n-p/ff632023(v=pandp.10)).</span></span>

## <a name="dealing-with-expected-exceptions"></a><span data-ttu-id="f58eb-118">Работа с ожидаемыми исключениями</span><span class="sxs-lookup"><span data-stu-id="f58eb-118">Dealing with expected exceptions</span></span>

<span data-ttu-id="f58eb-119">Правильный курс действий заключается в перехвате ожидаемых исключений в каждой операции или соответствующей точке расширения, принятии решения о том, можно ли их восстановить из, и возвращать соответствующую пользовательскую ошибку в FaultException \<T> .</span><span class="sxs-lookup"><span data-stu-id="f58eb-119">The proper course of action is to catch expected exceptions in every operation or relevant extensibility point, decide whether they can be recovered from, and return the proper custom fault in a FaultException\<T>.</span></span>
  
## <a name="dealing-with-unexpected-exceptions-using-an-ierrorhandler"></a><span data-ttu-id="f58eb-120">Работа с непредвиденными исключениями с помощью IErrorHandler</span><span class="sxs-lookup"><span data-stu-id="f58eb-120">Dealing with unexpected exceptions using an IErrorHandler</span></span>

<span data-ttu-id="f58eb-121">Чтобы справиться с непредвиденными исключениями, рекомендуемым действием является «привязать» IErrorHandler.</span><span class="sxs-lookup"><span data-stu-id="f58eb-121">To deal with unexpected exceptions, the recommended course of action is to "hook" an IErrorHandler.</span></span> <span data-ttu-id="f58eb-122">Обработчики ошибок перехватывают исключения только на уровне среды выполнения WCF (уровень Service Model), а не на уровне канала.</span><span class="sxs-lookup"><span data-stu-id="f58eb-122">Error handlers only catch exceptions at the WCF runtime level (the "service model" layer), not at the channel layer.</span></span> <span data-ttu-id="f58eb-123">Единственным способом подключения IErrorHandler на уровне канала является создание пользовательского канала, что в большинстве случаев делать не рекомендуется.</span><span class="sxs-lookup"><span data-stu-id="f58eb-123">The only way to hook an IErrorHandler at the channel level is to create a custom channel, which is not recommended in most scenarios.</span></span>

<span data-ttu-id="f58eb-124">"Непредвиденное исключение" обычно не является исключением Неустранимая и исключением обработки. Вместо этого произошло непредвиденное исключение пользователя.</span><span class="sxs-lookup"><span data-stu-id="f58eb-124">An "unexpected exception" is generally neither an irrecoverable exception nor a processing exception; it is, instead, an unexpected user exception.</span></span> <span data-ttu-id="f58eb-125">Исключение Неустранимая (например, исключение нехватки памяти), которое обычно обрабатывается [обработчиком исключений модели службы](xref:System.ServiceModel.Dispatcher.ExceptionHandler) , обычно не может быть корректно обработано, и единственной причиной для обработки такого исключения может быть дополнительное ведение журнала или возвращение клиенту стандартного исключения.</span><span class="sxs-lookup"><span data-stu-id="f58eb-125">An irrecoverable exception (such as an out-of-memory exception) – one generally handled by the [Service Model Exception Handler](xref:System.ServiceModel.Dispatcher.ExceptionHandler) automatically – cannot generally be handled gracefully, and the only reason to handle such an exception at all may be do additional logging or to return a standard exception to the client.</span></span> <span data-ttu-id="f58eb-126">Исключение при обработке возникает при обработке сообщения, например на уровне сериализации, кодировщика или модуля форматирования. Как правило, его нельзя обработать с помощью IErrorHandler, поскольку на момент возникновения таких исключений вмешательство обработчика обычно происходит либо слишком рано, либо слишком поздно.</span><span class="sxs-lookup"><span data-stu-id="f58eb-126">A processing exception occurs in the processing of the message – for example, at the serialization, encoder, or formatter level – generally cannot be handled at an IErrorHandler, because it is generally either too early or too late for the error handler to intervene by the time these exceptions occur.</span></span> <span data-ttu-id="f58eb-127">Аналогичным образом с помощью IErrorHandler нельзя обрабатывать исключения транспорта.</span><span class="sxs-lookup"><span data-stu-id="f58eb-127">Similarly, transport exceptions cannot be handled at an IErrorHandler.</span></span>

<span data-ttu-id="f58eb-128">С помощью IErrorHandler можно явно управлять поведением приложения, когда возникает исключение.</span><span class="sxs-lookup"><span data-stu-id="f58eb-128">With an IErrorHandler, you can explicitly control the behavior of your application when an exception is thrown.</span></span> <span data-ttu-id="f58eb-129">Вы можете сделать следующее:</span><span class="sxs-lookup"><span data-stu-id="f58eb-129">You may:</span></span>  

1. <span data-ttu-id="f58eb-130">Решите, следует ли отправить клиенту ошибку.</span><span class="sxs-lookup"><span data-stu-id="f58eb-130">Decide whether or not to send a fault to the client.</span></span>

2. <span data-ttu-id="f58eb-131">Замена исключения на ошибку.</span><span class="sxs-lookup"><span data-stu-id="f58eb-131">Replace an exception with a fault.</span></span>

3. <span data-ttu-id="f58eb-132">Замена сбоя другой ошибкой.</span><span class="sxs-lookup"><span data-stu-id="f58eb-132">Replace a fault with another fault.</span></span>

4. <span data-ttu-id="f58eb-133">Выполните ведение журнала или трассировку.</span><span class="sxs-lookup"><span data-stu-id="f58eb-133">Perform logging or tracing.</span></span>

5. <span data-ttu-id="f58eb-134">Выполнение других настраиваемых действий.</span><span class="sxs-lookup"><span data-stu-id="f58eb-134">Perform other custom activities.</span></span>

<span data-ttu-id="f58eb-135">Можно установить пользовательский обработчик ошибок путем добавления его в свойство ErrorHandlers диспетчеров каналов для данной службы.</span><span class="sxs-lookup"><span data-stu-id="f58eb-135">One can install a custom error handler by adding it to the ErrorHandlers property of the channel dispatchers for your service.</span></span>  <span data-ttu-id="f58eb-136">Может применяться несколько обработчиков ошибок, и они будут вызываться в порядке добавления в данную коллекцию.</span><span class="sxs-lookup"><span data-stu-id="f58eb-136">It is possible to have more than one error handler and they are called in the order they are added to this collection.</span></span>

<span data-ttu-id="f58eb-137">IErrorHandler.ProvideFault управляет отправкой клиенту сообщений об ошибках.</span><span class="sxs-lookup"><span data-stu-id="f58eb-137">IErrorHandler.ProvideFault controls the fault message that is sent to the client.</span></span> <span data-ttu-id="f58eb-138">Этот метод вызывается независимо от типа исключения, возникшего в результате операции в данной службе.</span><span class="sxs-lookup"><span data-stu-id="f58eb-138">This method is called regardless of the type of the exception thrown by an operation in your service.</span></span> <span data-ttu-id="f58eb-139">Если ни одна операция не выполняется, WCF предполагает поведение по умолчанию и продолжит работу, как если бы на месте не было пользовательских обработчиков ошибок.</span><span class="sxs-lookup"><span data-stu-id="f58eb-139">If no operation is performed here, WCF assumes its default behavior and continues as if there were no custom error handlers in place.</span></span>

<span data-ttu-id="f58eb-140">Одна область, в которой можно использовать этот подход, - если необходимо создать центральное расположение для преобразования исключений в ошибки, прежде чем они будут отправлены клиенту (при условии, что экземпляр не удаляется и канал не переходит в состояние «Ошибка»).</span><span class="sxs-lookup"><span data-stu-id="f58eb-140">One area that you could perhaps use this approach is when you want to create a central place for converting exceptions to faults before they are sent to the client (ensuring that the instance is not disposed and the channel is not moved to the Faulted state).</span></span>

<span data-ttu-id="f58eb-141">Метод IErrorHandler. HandleError обычно используется для реализации поведения, связанного с ошибками, таких как ведение журнала ошибок, системные уведомления, завершение работы приложения и т. д. IErrorHandler. HandleError может вызываться в нескольких местах внутри службы, и в зависимости от того, где возникает ошибка, метод HandleError может вызываться или не быть вызван тем же потоком, что и операция. в этом отношении нет никаких гарантий.</span><span class="sxs-lookup"><span data-stu-id="f58eb-141">The IErrorHandler.HandleError method is usually used to implement error-related behaviors such as error logging, system notifications, shutting down the application, etc. IErrorHandler.HandleError can be called at multiple places inside the service, and depending on where the error is thrown, the HandleError method may or may not be called by the same thread as the operation; no guarantees are made in this regard.</span></span>

## <a name="dealing-with-exceptions-outside-wcf"></a><span data-ttu-id="f58eb-142">Работа с исключениями вне WCF</span><span class="sxs-lookup"><span data-stu-id="f58eb-142">Dealing with exceptions outside WCF</span></span>

<span data-ttu-id="f58eb-143">Часто исключения конфигурации, исключения строки подключения к базам данных и другие подобные исключения могут возникать в контексте приложения WCF, но сами они не являются исключениями, вызываемыми моделью службы или самой веб-службой.</span><span class="sxs-lookup"><span data-stu-id="f58eb-143">Often, configuration exceptions, database connection string exceptions, and other similar exceptions may occur within the context of a WCF application, but are themselves are not exceptions caused by the service model or the web service itself.</span></span> <span data-ttu-id="f58eb-144">Эти исключения являются "обычными" исключениями, которые являются внешними по отношению к веб-службе, и должны обрабатываться так же, как другие внешние исключения в среде.</span><span class="sxs-lookup"><span data-stu-id="f58eb-144">These exceptions are "regular" exceptions external to the web service, and should be handled just as other external exceptions in the environment are to be handled.</span></span>

## <a name="tracing-exceptions"></a><span data-ttu-id="f58eb-145">Трассировка исключений</span><span class="sxs-lookup"><span data-stu-id="f58eb-145">Tracing exceptions</span></span>

<span data-ttu-id="f58eb-146">Трассировка — единственное место «Catch-All», где один может видеть все исключения.</span><span class="sxs-lookup"><span data-stu-id="f58eb-146">Tracing is the only "catch-all" place where one can potentially see all exceptions.</span></span> <span data-ttu-id="f58eb-147">Дополнительные сведения о трассировке исключений и занесении их в журналы см. в разделе «Трассировка и ведение журнала».</span><span class="sxs-lookup"><span data-stu-id="f58eb-147">For more information on tracing and logging exceptions, see Tracing and Logging.</span></span>

## <a name="uri-template-errors-when-using-webgetattribute-and-webinvokeattribute"></a><span data-ttu-id="f58eb-148">Ошибки шаблона URI при использовании WebGetAttribute и WebInvokeAttribute</span><span class="sxs-lookup"><span data-stu-id="f58eb-148">URI template errors when using WebGetAttribute and WebInvokeAttribute</span></span>

<span data-ttu-id="f58eb-149">Атрибуты WebGet и WebInvoke позволяют указывать шаблон URI, сопоставляющий компоненты адреса запроса с параметрами операции.</span><span class="sxs-lookup"><span data-stu-id="f58eb-149">The WebGet and WebInvoke attributes allow you to specify a URI template that maps components of the request address to operation parameters.</span></span> <span data-ttu-id="f58eb-150">Например, шаблон URI «weather/{state}/{city}» сопоставляет адрес запроса с литеральными лексемами, параметром «state» и параметром «city».</span><span class="sxs-lookup"><span data-stu-id="f58eb-150">For example, the URI template "weather/{state}/{city}" maps the request address into literal tokens, a parameter named state, and a parameter named city.</span></span> <span data-ttu-id="f58eb-151">Затем эти параметры могут быть связаны по имени с некоторым из формальных параметров операции.</span><span class="sxs-lookup"><span data-stu-id="f58eb-151">These parameters might then be bound by name to some of the formal parameters of the operation.</span></span>

<span data-ttu-id="f58eb-152">Параметры шаблона отображаются в виде строк в пределах URI, тогда как формальные параметры типизированного контракта могут иметь нестроковые типы.</span><span class="sxs-lookup"><span data-stu-id="f58eb-152">The template parameters appear in the form of strings within the URI while the formal parameters of a typed contract might be of non-string types.</span></span> <span data-ttu-id="f58eb-153">Таким образом, преобразование должно происходить до вызова операции.</span><span class="sxs-lookup"><span data-stu-id="f58eb-153">Therefore, a conversion needs to take place before the operation can be invoked.</span></span> <span data-ttu-id="f58eb-154">Доступна [Таблица форматов преобразования](wcf-web-http-programming-model-overview.md) .</span><span class="sxs-lookup"><span data-stu-id="f58eb-154">A [table of conversion formats](wcf-web-http-programming-model-overview.md) is available.</span></span>

<span data-ttu-id="f58eb-155">Однако если преобразование выполнить не удалось, то невозможно сообщить операции, что возникло какое-то нарушение.</span><span class="sxs-lookup"><span data-stu-id="f58eb-155">However, if the conversion fails, then there's no way to let the operation know that something has gone wrong.</span></span> <span data-ttu-id="f58eb-156">Вместо этого преобразование типа проявляется в виде сбоев при подготовке к отправке.</span><span class="sxs-lookup"><span data-stu-id="f58eb-156">The type conversion instead surfaces in the form of a dispatch failure.</span></span>

<span data-ttu-id="f58eb-157">Наличие ошибок подготовки к отправке при преобразовании типов можно проверить так же, как многие другие типы ошибок отправки - путем установки обработчика ошибки.</span><span class="sxs-lookup"><span data-stu-id="f58eb-157">A type conversion dispatch failure can be inspected the same as with many other types of dispatch failures by installing an error handler.</span></span> <span data-ttu-id="f58eb-158">Для обработки исключения уровня службы вызывается точка расширения IErrorHandler.</span><span class="sxs-lookup"><span data-stu-id="f58eb-158">The IErrorHandler extensibility point is called to handle service-level exceptions.</span></span> <span data-ttu-id="f58eb-159">Там можно выбрать, будет ли ответ отправлен обратно в вызывающий код, или будут выполнены какие-либо пользовательские задачи или действия с отчетами.</span><span class="sxs-lookup"><span data-stu-id="f58eb-159">From there, the response to be sent back to the caller – as well as perform any custom tasks and reporting – may be chosen.</span></span>

## <a name="see-also"></a><span data-ttu-id="f58eb-160">См. также</span><span class="sxs-lookup"><span data-stu-id="f58eb-160">See also</span></span>

- [<span data-ttu-id="f58eb-161">Базовое программирование для WCF</span><span class="sxs-lookup"><span data-stu-id="f58eb-161">Basic WCF Programming</span></span>](../basic-wcf-programming.md)
