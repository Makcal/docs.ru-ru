---
description: 'Дополнительные сведения: использование очередей Dead-Letter для управления сбоями при пересылку сообщений'
title: Использование очередей недоставленных сообщений для обработки сбоев при передаче сообщений
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 9e891c6a-d960-45ea-904f-1a00e202d61a
ms.openlocfilehash: 497da84d37cf7c82a2da09e4303b8e53e7e0b46c
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99704450"
---
# <a name="using-dead-letter-queues-to-handle-message-transfer-failures"></a><span data-ttu-id="46918-103">Использование очередей недоставленных сообщений для обработки сбоев при передаче сообщений</span><span class="sxs-lookup"><span data-stu-id="46918-103">Using Dead-Letter Queues to Handle Message Transfer Failures</span></span>

<span data-ttu-id="46918-104">Сообщения в очереди могут вызвать сбой доставки.</span><span class="sxs-lookup"><span data-stu-id="46918-104">Queued messages can fail delivery.</span></span> <span data-ttu-id="46918-105">Сообщения, во время доставки которых произошел сбой, записываются в очередь недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-105">These failed messages are recorded in a dead-letter queue.</span></span> <span data-ttu-id="46918-106">Сбой доставки может быть вызван такими причинами, как сбои сети, удаленная очередь, заполнение очереди, сбой проверки подлинности или сбой доставки по времени.</span><span class="sxs-lookup"><span data-stu-id="46918-106">The failed delivery can be caused by reasons such as network failures, a deleted queue, a full queue, authentication failure, or a failure to deliver on time.</span></span>  
  
 <span data-ttu-id="46918-107">Сообщения могут длительное время оставаться в очереди, если принимающее приложение не считывает их из очереди за отведенное время.</span><span class="sxs-lookup"><span data-stu-id="46918-107">Queued messages can remain in the queue for a long time if the receiving application does not read them from the queue in a timely fashion.</span></span> <span data-ttu-id="46918-108">Такое поведение может не быть свойственно чувствительным к времени сообщениям.</span><span class="sxs-lookup"><span data-stu-id="46918-108">This behavior may not be appropriate for time-sensitive messages.</span></span> <span data-ttu-id="46918-109">Критичные к времени сообщения имеют свойство срок жизни (TTL), заданное в привязке с очередью, которое указывает, насколько долго сообщения могут находиться в очереди до истечения срока действия.</span><span class="sxs-lookup"><span data-stu-id="46918-109">Time-sensitive messages have a Time to Live (TTL) property set in the queued binding, which indicates how long the messages can be in the queue before they must expire.</span></span> <span data-ttu-id="46918-110">Просроченные сообщения отправляются в специальную очередь, называемую очередью недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-110">Expired messages are sent to a special queue called the dead-letter queue.</span></span> <span data-ttu-id="46918-111">Сообщения могут быть помещены в очередь недоставленных сообщений и по другим причинам, таким как превышение квоты очереди или сбой проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="46918-111">Messages can also be put in a dead-letter queue for other reasons, such as exceeding a queue quota or because of authentication failure.</span></span>  
  
 <span data-ttu-id="46918-112">Обычно для прочтения сообщений из очереди недоставленных сообщений и причин сбоя приложения записывают компенсирующую логику.</span><span class="sxs-lookup"><span data-stu-id="46918-112">Generally, applications write compensation logic to read messages from the dead-letter queue and failure reasons.</span></span> <span data-ttu-id="46918-113">Компенсирующая логика зависит от причины сбоя.</span><span class="sxs-lookup"><span data-stu-id="46918-113">The compensation logic depends on the cause of the failure.</span></span> <span data-ttu-id="46918-114">Например, в случае сбоя проверки подлинности можно исправить сертификат, прикрепленный к сообщению, и отправить сообщение повторно.</span><span class="sxs-lookup"><span data-stu-id="46918-114">For example, in the case of authentication failure, you can correct the certificate attached with the message and resend the message.</span></span> <span data-ttu-id="46918-115">Если сбой доставки произошел по причине достижения квоты целевой очереди, можно повторить попытку отправки в надежде, что проблема с квотой была устранена.</span><span class="sxs-lookup"><span data-stu-id="46918-115">If delivery failed because the target queue quota was reached, you can reattempt delivery in the hope that the quota problem was resolved.</span></span>  
  
 <span data-ttu-id="46918-116">Большинство систем организации очереди имеют общесистемную очередь недоставленных сообщений, в которой хранятся все сообщения данной системы, во время доставки которых произошел сбой.</span><span class="sxs-lookup"><span data-stu-id="46918-116">Most queuing systems have a system-wide dead-letter queue where all failed messages from that system are stored.</span></span> <span data-ttu-id="46918-117">Очередь сообщений (MSMQ) имеет две общесистемные очереди недоставленных сообщений: общесистемная очередь недоставленных транзакционных сообщений, в которой хранятся сообщения, по причине сбоя не доставленные в транзакционную очередь, и общесистемная очередь недоставленных нетранзакционных сообщений, в которой хранятся сообщения, по причине сбоя не доставленные в нетранзакционную очередь.</span><span class="sxs-lookup"><span data-stu-id="46918-117">Message Queuing (MSMQ) provides two system-wide dead-letter queues: a transactional system-wide dead-letter queue that stores messages that failed delivery to the transactional queue and a non-transactional system-wide dead-letter queue that stores messages that failed delivery to the non-transactional queue.</span></span> <span data-ttu-id="46918-118">Если два клиента отправляют сообщения двум разным службам, и, следовательно, разные очереди в WCF используют одну и ту же службу MSMQ для отправки, то в системную очередь недоставленных сообщений можно поместить сообщения.</span><span class="sxs-lookup"><span data-stu-id="46918-118">If two clients are sending messages to two different services, and therefore different queues in WCF are sharing the same MSMQ service to send, then it is possible to have a mix of messages in the system dead-letter queue.</span></span> <span data-ttu-id="46918-119">Это не всегда оптимально.</span><span class="sxs-lookup"><span data-stu-id="46918-119">This is not always optimal.</span></span> <span data-ttu-id="46918-120">В некоторых случаях (по соображениям безопасности, например), может быть нежелательно, чтобы один клиент прочел сообщения другого клиента из очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-120">In several cases (security, for example), you may not want one client to read another client's messages from a dead-letter queue.</span></span> <span data-ttu-id="46918-121">При использовании общей очереди недоставленных сообщений клиенты также вынуждены просматривать всю очередь, чтобы найти отправленное ими сообщение, что, в зависимости от количества сообщений в очереди недоставленных сообщений, может оказаться чрезмерно дорого.</span><span class="sxs-lookup"><span data-stu-id="46918-121">A shared dead-letter queue also requires clients to browse through the queue to find a message that they sent, which can be prohibitively expensive based on the number of messages in the dead-letter queue.</span></span> <span data-ttu-id="46918-122">Таким образом, в `NetMsmqBinding` WCF `MsmqIntegrationBinding,` и MSMQ в Windows Vista предусмотрена пользовательская очередь недоставленных сообщений (иногда она называется очередью недоставленных сообщений конкретного приложения).</span><span class="sxs-lookup"><span data-stu-id="46918-122">Therefore, in WCF`NetMsmqBinding`, `MsmqIntegrationBinding,` and MSMQ on Windows Vista provide a custom dead-letter queue (sometimes referred to as an application-specific dead-letter queue).</span></span>  
  
 <span data-ttu-id="46918-123">Пользовательская очередь недоставленных сообщений обеспечивает изоляцию между клиентами, использующими для отправки сообщений одну службу MSMQ.</span><span class="sxs-lookup"><span data-stu-id="46918-123">The custom dead-letter queue provides isolation between clients that share the same MSMQ service to send messages.</span></span>  
  
 <span data-ttu-id="46918-124">В Windows Server 2003 и Windows XP Windows Communication Foundation (WCF) предоставляет очередь недоставленных сообщений на уровне системы для всех клиентских приложений, помещенных в очередь.</span><span class="sxs-lookup"><span data-stu-id="46918-124">On Windows Server 2003 and Windows XP, Windows Communication Foundation (WCF) provides a system-wide dead-letter queue for all queued client applications.</span></span> <span data-ttu-id="46918-125">В Windows Vista WCF предоставляет очередь недоставленных сообщений для каждого клиентского приложения, находящихся в очереди.</span><span class="sxs-lookup"><span data-stu-id="46918-125">On Windows Vista, WCF provides a dead-letter queue for each queued client application.</span></span>  
  
## <a name="specifying-use-of-the-dead-letter-queue"></a><span data-ttu-id="46918-126">Указание использования очереди недоставленных сообщений</span><span class="sxs-lookup"><span data-stu-id="46918-126">Specifying Use of the Dead-Letter Queue</span></span>  

 <span data-ttu-id="46918-127">Очередь недоставленных сообщений находится в диспетчере очереди отправляющего приложения.</span><span class="sxs-lookup"><span data-stu-id="46918-127">A dead-letter queue is in the queue manager of the sending application.</span></span> <span data-ttu-id="46918-128">В диспетчере очереди хранятся сообщения с истекшим сроком или сообщения, во время передачи или доставки которых произошел сбой.</span><span class="sxs-lookup"><span data-stu-id="46918-128">It stores messages that have expired or that have failed transfer or delivery.</span></span>  
  
 <span data-ttu-id="46918-129">Привязка имеет следующие свойства очереди недоставленных писем.</span><span class="sxs-lookup"><span data-stu-id="46918-129">The binding has the following dead-letter queue properties:</span></span>  
  
- <xref:System.ServiceModel.MsmqBindingBase.DeadLetterQueue%2A>  
  
- <xref:System.ServiceModel.MsmqBindingBase.CustomDeadLetterQueue%2A>  
  
## <a name="reading-messages-from-the-dead-letter-queue"></a><span data-ttu-id="46918-130">Чтение сообщений из очереди недоставленных сообщений</span><span class="sxs-lookup"><span data-stu-id="46918-130">Reading Messages from the Dead-Letter Queue</span></span>  

 <span data-ttu-id="46918-131">Приложение, считывающее сообщения из очереди недоставленных сообщений, похоже на службу WCF, которая считывает данные из очереди приложений, за исключением следующих незначительных отличий:</span><span class="sxs-lookup"><span data-stu-id="46918-131">An application that reads messages out of a dead-letter queue is similar to a WCF service that reads from an application queue, except for the following minor differences:</span></span>  
  
- <span data-ttu-id="46918-132">Для чтения сообщений из системной очереди недоставленных транзакционных сообщений универсальный код ресурса (URI) должен иметь вид net.msmq://localhost/system$;DeadXact.</span><span class="sxs-lookup"><span data-stu-id="46918-132">To read messages from a system transactional dead-letter queue, the Uniform Resource Identifier (URI) must be of the form: net.msmq://localhost/system$;DeadXact.</span></span>  
  
- <span data-ttu-id="46918-133">Для чтения сообщений из системной очереди недоставленных нетранзакционных сообщений код URI должен иметь вид net.msmq://localhost/system$;DeadLetter.</span><span class="sxs-lookup"><span data-stu-id="46918-133">To read messages from a system non-transactional dead-letter queue, the URI must be of the form: net.msmq://localhost/system$;DeadLetter.</span></span>  
  
- <span data-ttu-id="46918-134">Чтобы считать сообщения из пользовательской очереди недоставленных сообщений, URI должен иметь вид: net. msmq://ЛОКАЛХОСТ/привате/ \<*custom-dlq-name*> , где *Custom-очередь dlq-name* — это имя пользовательской очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-134">To read messages from a custom dead-letter queue, the URI must be of the form:net.msmq://localhost/private/\<*custom-dlq-name*> where *custom-dlq-name* is the name of the custom dead-letter queue.</span></span>  
  
 <span data-ttu-id="46918-135">Дополнительные сведения об устранении очередей см. в статье [конечные точки службы и адресация очередей](service-endpoints-and-queue-addressing.md).</span><span class="sxs-lookup"><span data-stu-id="46918-135">For more information about how to address queues, see [Service Endpoints and Queue Addressing](service-endpoints-and-queue-addressing.md).</span></span>  
  
 <span data-ttu-id="46918-136">Стек WCF на получателе сопоставляет адреса, прослушиваемые службой, с адресом в сообщении.</span><span class="sxs-lookup"><span data-stu-id="46918-136">The WCF stack on the receiver matches addresses that the service is listening on with the address on the message.</span></span> <span data-ttu-id="46918-137">Если адреса совпадают, сообщение отправляется, если нет - не отправляется.</span><span class="sxs-lookup"><span data-stu-id="46918-137">If the addresses match, the message is dispatched; if not, the message is not dispatched.</span></span> <span data-ttu-id="46918-138">Это может создать проблемы при чтении сообщений из очереди недоставленных сообщений, поскольку сообщения в очереди недоставленных сообщений обычно адресованы не службе и не службе очереди отправленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-138">This can cause problems when reading from the dead-letter queue, because messages in the dead-letter queue are typically addressed to the service and not the dead-letter queue service.</span></span> <span data-ttu-id="46918-139">Поэтому для чтения службой сообщений из очереди недоставленных сообщений необходима установка фильтра по адресу `ServiceBehavior`, которая дает команду стеку считать совпадающими все сообщения в очереди независимо от адресата.</span><span class="sxs-lookup"><span data-stu-id="46918-139">Therefore, the service reading from the dead-letter queue must install an address filter `ServiceBehavior` that instructs the stack to match all messages in the queue independently of the addressee.</span></span> <span data-ttu-id="46918-140">В частности, нужно добавить `ServiceBehavior` при помощи параметра <xref:System.ServiceModel.AddressFilterMode.Any>в службу, считывающую сообщения из очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-140">Specifically, you must add a `ServiceBehavior` with the <xref:System.ServiceModel.AddressFilterMode.Any> parameter to the service reading messages from the dead-letter queue.</span></span>  
  
## <a name="poison-message-handling-from-the-dead-letter-queue"></a><span data-ttu-id="46918-141">Обработка подозрительных сообщений из очереди недоставленных сообщений</span><span class="sxs-lookup"><span data-stu-id="46918-141">Poison Message Handling from the Dead-Letter Queue</span></span>  

 <span data-ttu-id="46918-142">При некоторых условиях в очередях недоставленных сообщений возможна обработка подозрительных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-142">Poison message handling is available on dead-letter queues, with some conditions.</span></span> <span data-ttu-id="46918-143">Поскольку создать вложенные очереди из системных очередей нельзя, `ReceiveErrorHandling` при прочтении из системной очереди недоставленных сообщений не может быть установлен в значение `Move`.</span><span class="sxs-lookup"><span data-stu-id="46918-143">Because you cannot create sub-queues from system queues, when reading from the system dead-letter queue, the `ReceiveErrorHandling` cannot be set to `Move`.</span></span> <span data-ttu-id="46918-144">Обратите внимание, что при чтении сообщений из пользовательской очереди недоставленных сообщений могут использоваться вложенные очереди, и, таким образом, `Move` является подходящим средством удаления подозрительного сообщения.</span><span class="sxs-lookup"><span data-stu-id="46918-144">Note that if you are reading from a custom dead-letter queue, you can have sub-queues and, therefore, `Move` is a valid disposition for the poison message.</span></span>  
  
 <span data-ttu-id="46918-145">Если `ReceiveErrorHandling` установлен в значение `Reject`, подозрительные сообщения при чтении из пользовательской очереди недоставленных сообщений помещаются в системную очередь недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-145">When `ReceiveErrorHandling` is set to `Reject`, when reading from the custom dead letter queue, the poison message is put in the system dead-letter queue.</span></span> <span data-ttu-id="46918-146">При чтении из системной очереди недоставленных сообщений сообщение отбрасывается (удаляется).</span><span class="sxs-lookup"><span data-stu-id="46918-146">If reading from the system dead-letter queue, the message is dropped (purged).</span></span> <span data-ttu-id="46918-147">При возврате из системной очереди недоставленных сообщений в MSMQ сообщение отбрасывается (удаляется).</span><span class="sxs-lookup"><span data-stu-id="46918-147">A reject from a system dead-letter queue in MSMQ drops (purges) the message.</span></span>  
  
## <a name="example"></a><span data-ttu-id="46918-148">Пример</span><span class="sxs-lookup"><span data-stu-id="46918-148">Example</span></span>  

 <span data-ttu-id="46918-149">В приведенном ниже примере показано, как создавать очередь недоставленных сообщений и как использовать ее для обработки просроченных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-149">The following example shows how to create a dead-letter queue and how to use it to process expired messages.</span></span> <span data-ttu-id="46918-150">Этот пример основан на примере в [процедуре обмена сообщениями в очереди с конечными точками WCF](how-to-exchange-queued-messages-with-wcf-endpoints.md).</span><span class="sxs-lookup"><span data-stu-id="46918-150">The example is based on the example in [How to: Exchange Queued Messages with WCF Endpoints](how-to-exchange-queued-messages-with-wcf-endpoints.md).</span></span> <span data-ttu-id="46918-151">В приведенном ниже примере показано, как писать клиентский код для службы обработки заказов, в которой используется очередь недоставленных сообщений для каждого приложения.</span><span class="sxs-lookup"><span data-stu-id="46918-151">The following example shows how to write the client code to the order processing service that uses a dead-letter queue for each application.</span></span> <span data-ttu-id="46918-152">В примере также показано, как обрабатывать сообщения из очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-152">The example also shows how to process messages from the dead-letter queue.</span></span>  
  
 <span data-ttu-id="46918-153">В следующем примере показан код для клиента, задающего очередь недоставленных сообщений для каждого приложения.</span><span class="sxs-lookup"><span data-stu-id="46918-153">The following is code for a client that specifies a dead-letter queue for each application.</span></span>  
  
 [!code-csharp[S_DeadLetter#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/client.cs#1)]
 [!code-vb[S_DeadLetter#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/client.vb#1)]  
  
 <span data-ttu-id="46918-154">В следующем примере показан код для файла конфигурации клиента.</span><span class="sxs-lookup"><span data-stu-id="46918-154">The following is code for the client configuration file.</span></span>  

 <span data-ttu-id="46918-155">В следующем примере показан код для службы обработки сообщений из очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-155">The following is code for a service processing messages from a dead-letter queue.</span></span>  
  
 [!code-csharp[S_DeadLetter#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/dlservice.cs#3)]
 [!code-vb[S_DeadLetter#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/dlservice.vb#3)]  
  
 <span data-ttu-id="46918-156">В следующем примере показан код для файла конфигурации службы очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="46918-156">The following is code for the dead-letter queue service configuration file.</span></span>  

## <a name="see-also"></a><span data-ttu-id="46918-157">См. также</span><span class="sxs-lookup"><span data-stu-id="46918-157">See also</span></span>

- [<span data-ttu-id="46918-158">Общие сведения об очередях</span><span class="sxs-lookup"><span data-stu-id="46918-158">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="46918-159">Практическое руководство. Обмен сообщениями в очереди с конечными точками WCF</span><span class="sxs-lookup"><span data-stu-id="46918-159">How to: Exchange Queued Messages with WCF Endpoints</span></span>](how-to-exchange-queued-messages-with-wcf-endpoints.md)
- [<span data-ttu-id="46918-160">Обработка подозрительных сообщений</span><span class="sxs-lookup"><span data-stu-id="46918-160">Poison Message Handling</span></span>](poison-message-handling.md)
