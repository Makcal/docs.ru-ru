---
description: 'Дополнительные сведения: Отладка ошибок проверки подлинности Windows'
title: Отладка ошибок проверки подлинности Windows
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, authentication
- WCF, Windows authentication
ms.assetid: 181be4bd-79b1-4a66-aee2-931887a6d7cc
ms.openlocfilehash: cfc8bf8ce9b9c5da3d9b25949321ed1ac2b62d98
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99756491"
---
# <a name="debug-windows-authentication-errors"></a><span data-ttu-id="bc27d-103">Отладка ошибок проверки подлинности Windows</span><span class="sxs-lookup"><span data-stu-id="bc27d-103">Debug Windows authentication errors</span></span>

<span data-ttu-id="bc27d-104">При использовании в качестве механизма обеспечения безопасности проверки подлинности Windows процессы безопасности обрабатываются интерфейсом поставщика поддержки безопасности SSPI.</span><span class="sxs-lookup"><span data-stu-id="bc27d-104">When using Windows authentication as a security mechanism, the Security Support Provider Interface (SSPI) handles security processes.</span></span> <span data-ttu-id="bc27d-105">При возникновении ошибок безопасности на уровне SSPI они выводятся Windows Communication Foundation (WCF).</span><span class="sxs-lookup"><span data-stu-id="bc27d-105">When security errors occur at the SSPI layer, they are surfaced by Windows Communication Foundation (WCF).</span></span> <span data-ttu-id="bc27d-106">В этом разделе описаны общие принципы и некоторые вопросы, помогающие диагностировать такие ошибки.</span><span class="sxs-lookup"><span data-stu-id="bc27d-106">This topic provides a framework and set of questions to help diagnose the errors.</span></span>  
  
 <span data-ttu-id="bc27d-107">Общие сведения о протоколе Kerberos см. в статье [Описание](/previous-versions/windows/it-pro/windows-2000-server/bb742516(v=technet.10))протокола Kerberos. Общие сведения о SSPI см. в разделе [SSPI](/windows/win32/secauthn/sspi).</span><span class="sxs-lookup"><span data-stu-id="bc27d-107">For an overview of the Kerberos protocol, see [Kerberos Explained](/previous-versions/windows/it-pro/windows-2000-server/bb742516(v=technet.10)); for an overview of SSPI, see [SSPI](/windows/win32/secauthn/sspi).</span></span>  
  
 <span data-ttu-id="bc27d-108">Для проверки подлинности Windows в WCF обычно используется поставщик услуг безопасности *Negotiate* , который выполняет взаимную проверку подлинности Kerberos между клиентом и службой.</span><span class="sxs-lookup"><span data-stu-id="bc27d-108">For Windows authentication, WCF typically uses the *Negotiate* Security Support Provider (SSP), which performs Kerberos mutual authentication between the client and service.</span></span> <span data-ttu-id="bc27d-109">Если протокол Kerberos недоступен, WCF по умолчанию переходит к диспетчеру NT LAN Manager (NTLM).</span><span class="sxs-lookup"><span data-stu-id="bc27d-109">If the Kerberos protocol is not available, by default WCF falls back to NT LAN Manager (NTLM).</span></span> <span data-ttu-id="bc27d-110">Однако можно настроить WCF для использования только протокола Kerberos (и исключения, если протокол Kerberos недоступен).</span><span class="sxs-lookup"><span data-stu-id="bc27d-110">However, you can configure WCF to use only the Kerberos protocol (and to throw an exception if Kerberos is not available).</span></span> <span data-ttu-id="bc27d-111">Можно также настроить WCF для использования ограниченных форм протокола Kerberos.</span><span class="sxs-lookup"><span data-stu-id="bc27d-111">You can also configure WCF to use restricted forms of the Kerberos protocol.</span></span>  
  
## <a name="debugging-methodology"></a><span data-ttu-id="bc27d-112">Методология отладки</span><span class="sxs-lookup"><span data-stu-id="bc27d-112">Debugging Methodology</span></span>  

 <span data-ttu-id="bc27d-113">Базовый метод отладки состоит в следующем.</span><span class="sxs-lookup"><span data-stu-id="bc27d-113">The basic method is as follows:</span></span>  
  
1. <span data-ttu-id="bc27d-114">Определите, используется ли проверка подлинности Windows.</span><span class="sxs-lookup"><span data-stu-id="bc27d-114">Determine whether you are using Windows authentication.</span></span> <span data-ttu-id="bc27d-115">Если используется какая-либо другая схема, этот раздел неприменим к такому сценарию.</span><span class="sxs-lookup"><span data-stu-id="bc27d-115">If you are using any other scheme, this topic does not apply.</span></span>  
  
2. <span data-ttu-id="bc27d-116">Если вы уверены, что используете проверку подлинности Windows, определите, использует ли конфигурация WCF Direct или Negotiate.</span><span class="sxs-lookup"><span data-stu-id="bc27d-116">If you are sure you are using Windows authentication, determine whether your WCF configuration uses Kerberos direct or Negotiate.</span></span>  
  
3. <span data-ttu-id="bc27d-117">После определения протокола, который используется в текущей конфигурации (Kerberos или NTLM), можно рассматривать сообщения об ошибках в правильном контексте.</span><span class="sxs-lookup"><span data-stu-id="bc27d-117">Once you have determined whether your configuration is using the Kerberos protocol or NTLM, you can understand error messages in the correct context.</span></span>  
  
### <a name="availability-of-the-kerberos-protocol-and-ntlm"></a><span data-ttu-id="bc27d-118">Доступность протокола Kerberos и NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-118">Availability of the Kerberos Protocol and NTLM</span></span>  

 <span data-ttu-id="bc27d-119">Поставщику SSP Kerberos необходимо, чтоб контроллер домена выступал в роли центра распространения ключей Kerberos.</span><span class="sxs-lookup"><span data-stu-id="bc27d-119">The Kerberos SSP requires a domain controller to act as the Kerberos Key Distribution Center (KDC).</span></span> <span data-ttu-id="bc27d-120">Протокол Kerberos доступен только в том случае, если и клиент, и служба используют удостоверения домена.</span><span class="sxs-lookup"><span data-stu-id="bc27d-120">The Kerberos protocol is available only when both the client and service are using domain identities.</span></span> <span data-ttu-id="bc27d-121">При других сочетаниях учетных записей используется протокол NTLM, что подтверждается следующей таблицей.</span><span class="sxs-lookup"><span data-stu-id="bc27d-121">In other account combinations, NTLM is used, as summarized in the following table.</span></span>  
  
 <span data-ttu-id="bc27d-122">В заголовке таблицы приведены возможные типы учетных записей, используемые сервером.</span><span class="sxs-lookup"><span data-stu-id="bc27d-122">The table headers show possible account types used by the server.</span></span> <span data-ttu-id="bc27d-123">В левом столбце приведены возможные типы учетных записей, используемые клиентом.</span><span class="sxs-lookup"><span data-stu-id="bc27d-123">The left column shows possible account types used by the client.</span></span>  
  
||<span data-ttu-id="bc27d-124">Локальный пользователь</span><span class="sxs-lookup"><span data-stu-id="bc27d-124">Local User</span></span>|<span data-ttu-id="bc27d-125">Локальная система</span><span class="sxs-lookup"><span data-stu-id="bc27d-125">Local System</span></span>|<span data-ttu-id="bc27d-126">Пользователь домена</span><span class="sxs-lookup"><span data-stu-id="bc27d-126">Domain User</span></span>|<span data-ttu-id="bc27d-127">Компьютер домена</span><span class="sxs-lookup"><span data-stu-id="bc27d-127">Domain Machine</span></span>|  
|-|----------------|------------------|-----------------|--------------------|  
|<span data-ttu-id="bc27d-128">Локальный пользователь</span><span class="sxs-lookup"><span data-stu-id="bc27d-128">Local User</span></span>|<span data-ttu-id="bc27d-129">NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-129">NTLM</span></span>|<span data-ttu-id="bc27d-130">NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-130">NTLM</span></span>|<span data-ttu-id="bc27d-131">NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-131">NTLM</span></span>|<span data-ttu-id="bc27d-132">NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-132">NTLM</span></span>|  
|<span data-ttu-id="bc27d-133">Локальная система</span><span class="sxs-lookup"><span data-stu-id="bc27d-133">Local System</span></span>|<span data-ttu-id="bc27d-134">Anonymous NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-134">Anonymous NTLM</span></span>|<span data-ttu-id="bc27d-135">Anonymous NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-135">Anonymous NTLM</span></span>|<span data-ttu-id="bc27d-136">Anonymous NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-136">Anonymous NTLM</span></span>|<span data-ttu-id="bc27d-137">Anonymous NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-137">Anonymous NTLM</span></span>|  
|<span data-ttu-id="bc27d-138">Пользователь домена</span><span class="sxs-lookup"><span data-stu-id="bc27d-138">Domain User</span></span>|<span data-ttu-id="bc27d-139">NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-139">NTLM</span></span>|<span data-ttu-id="bc27d-140">NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-140">NTLM</span></span>|<span data-ttu-id="bc27d-141">Kerberos</span><span class="sxs-lookup"><span data-stu-id="bc27d-141">Kerberos</span></span>|<span data-ttu-id="bc27d-142">Kerberos</span><span class="sxs-lookup"><span data-stu-id="bc27d-142">Kerberos</span></span>|  
|<span data-ttu-id="bc27d-143">Компьютер домена</span><span class="sxs-lookup"><span data-stu-id="bc27d-143">Domain Machine</span></span>|<span data-ttu-id="bc27d-144">NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-144">NTLM</span></span>|<span data-ttu-id="bc27d-145">NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-145">NTLM</span></span>|<span data-ttu-id="bc27d-146">Kerberos</span><span class="sxs-lookup"><span data-stu-id="bc27d-146">Kerberos</span></span>|<span data-ttu-id="bc27d-147">Kerberos</span><span class="sxs-lookup"><span data-stu-id="bc27d-147">Kerberos</span></span>|  
  
 <span data-ttu-id="bc27d-148">Здесь четыре типа учетных записей включают:</span><span class="sxs-lookup"><span data-stu-id="bc27d-148">Specifically, the four account types include:</span></span>  
  
- <span data-ttu-id="bc27d-149">локальный пользователь: профиль пользователя, относящийся только к конкретному компьютеру.</span><span class="sxs-lookup"><span data-stu-id="bc27d-149">Local User: Machine-only user profile.</span></span> <span data-ttu-id="bc27d-150">Пример: `MachineName\Administrator` или `MachineName\ProfileName`.</span><span class="sxs-lookup"><span data-stu-id="bc27d-150">For example: `MachineName\Administrator` or `MachineName\ProfileName`.</span></span>  
  
- <span data-ttu-id="bc27d-151">локальная система: встроенная учетная запись SYSTEM на входящем в состав домена компьютере;</span><span class="sxs-lookup"><span data-stu-id="bc27d-151">Local System: The built-in account SYSTEM on a machine that is not joined to a domain.</span></span>  
  
- <span data-ttu-id="bc27d-152">пользователь домена: учетная запись пользователя в домене Windows.</span><span class="sxs-lookup"><span data-stu-id="bc27d-152">Domain User: A user account on a Windows domain.</span></span> <span data-ttu-id="bc27d-153">Например, `DomainName\ProfileName`.</span><span class="sxs-lookup"><span data-stu-id="bc27d-153">For example: `DomainName\ProfileName`.</span></span>  
  
- <span data-ttu-id="bc27d-154">компьютер домена: процесс с удостоверением компьютера, выполняющийся на компьютере, который входит в состав домена Windows.</span><span class="sxs-lookup"><span data-stu-id="bc27d-154">Domain Machine: A process with machine identity running on a machine joined to a Windows domain.</span></span> <span data-ttu-id="bc27d-155">Например, `MachineName\Network Service`.</span><span class="sxs-lookup"><span data-stu-id="bc27d-155">For example: `MachineName\Network Service`.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="bc27d-156">Получение учетных данных службы происходит при вызове метода <xref:System.ServiceModel.ICommunicationObject.Open%2A> класса <xref:System.ServiceModel.ServiceHost>.</span><span class="sxs-lookup"><span data-stu-id="bc27d-156">The service credential is captured when the <xref:System.ServiceModel.ICommunicationObject.Open%2A> method of the <xref:System.ServiceModel.ServiceHost> class is called.</span></span> <span data-ttu-id="bc27d-157">Чтение учетных данных клиента происходит всякий раз, когда клиент отправляет сообщение.</span><span class="sxs-lookup"><span data-stu-id="bc27d-157">The client credential is read whenever the client sends a message.</span></span>  
  
## <a name="common-windows-authentication-problems"></a><span data-ttu-id="bc27d-158">Распространенные проблемы проверки подлинности Windows</span><span class="sxs-lookup"><span data-stu-id="bc27d-158">Common Windows Authentication Problems</span></span>  

 <span data-ttu-id="bc27d-159">В этом разделе описаны некоторые распространенные проблемы проверки подлинности Windows и возможные решения.</span><span class="sxs-lookup"><span data-stu-id="bc27d-159">This section discusses some common Windows authentication problems and possible remedies.</span></span>  
  
### <a name="kerberos-protocol"></a><span data-ttu-id="bc27d-160">Протокол Kerberos</span><span class="sxs-lookup"><span data-stu-id="bc27d-160">Kerberos Protocol</span></span>  
  
#### <a name="spnupn-problems-with-the-kerberos-protocol"></a><span data-ttu-id="bc27d-161">Проблемы SPN/UPN, возникающие при использовании протокола Kerberos</span><span class="sxs-lookup"><span data-stu-id="bc27d-161">SPN/UPN Problems with the Kerberos Protocol</span></span>  

 <span data-ttu-id="bc27d-162">Если при проверке подлинности Windows используется протокол Kerberos, или он выбирается с помощью интерфейса SSPI, URL-адрес, используемый конечной точкой клиента, должен включать полное доменное имя узла службы внутри URL-адреса службы.</span><span class="sxs-lookup"><span data-stu-id="bc27d-162">When using Windows authentication, and the Kerberos protocol is used or negotiated by SSPI, the URL the client endpoint uses must include the fully qualified domain name of the service's host inside the service URL.</span></span> <span data-ttu-id="bc27d-163">При этом подразумевается, что у учетной записи, от имени которой выполняется служба, есть доступ к ключу имени участника службы (SPN) компьютера (по умолчанию), который был создан при добавлении компьютера в домен Active Directory, что чаще всего осуществляется путем запуска службы от имени учетной записи Network Service.</span><span class="sxs-lookup"><span data-stu-id="bc27d-163">This assumes that the account under which the service is running has access to the machine (default) service principal name (SPN) key that is created when the computer is added to the Active Directory domain, which is most commonly done by running the service under the Network Service account.</span></span> <span data-ttu-id="bc27d-164">Если у службы нет доступа к ключу имени участника-службы этого компьютера, необходимо предоставить правильное имя участника-службы или имя участника-пользователя (UPN) учетной записи, под которой выполняется служба в удостоверении конечной точки клиента.</span><span class="sxs-lookup"><span data-stu-id="bc27d-164">If the service does not have access to the machine SPN key, you must supply the correct SPN or user principal name (UPN) of the account under which the service is running in the client's endpoint identity.</span></span> <span data-ttu-id="bc27d-165">Дополнительные сведения о том, как WCF работает с SPN и UPN, см. в статье [удостоверение службы и проверка подлинности](service-identity-and-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="bc27d-165">For more information about how WCF works with SPN and UPN, see [Service Identity and Authentication](service-identity-and-authentication.md).</span></span>  
  
 <span data-ttu-id="bc27d-166">В сценариях с балансировкой нагрузки, например при использовании веб-ферм или веб-садов, распространена практика определения уникальной учетной записи для каждого из приложений, назначения этой учетной записи имени участника-службы и контроль за тем, чтобы все службы приложения выполнялись от имени этой учетной записи.</span><span class="sxs-lookup"><span data-stu-id="bc27d-166">In load-balancing scenarios, such as Web farms or Web gardens, a common practice is to define a unique account for each application, assign an SPN to that account, and ensure that all of the application's services run in that account.</span></span>  
  
 <span data-ttu-id="bc27d-167">Чтобы получить для учетной записи службы имя участника-службы, нужны права администратора домена Active Directory.</span><span class="sxs-lookup"><span data-stu-id="bc27d-167">To obtain an SPN for your service's account, you need to be an Active Directory domain administrator.</span></span> <span data-ttu-id="bc27d-168">Дополнительные сведения см. в статье [техническое дополнение Kerberos для Windows](/previous-versions/msp-n-p/ff649429(v=pandp.10)).</span><span class="sxs-lookup"><span data-stu-id="bc27d-168">For more information, see [Kerberos Technical Supplement for Windows](/previous-versions/msp-n-p/ff649429(v=pandp.10)).</span></span>  
  
#### <a name="kerberos-protocol-direct-requires-the-service-to-run-under-a-domain-machine-account"></a><span data-ttu-id="bc27d-169">Для непосредственного применения протокола Kerberos необходимо, чтобы служба выполнялась от имени учетной записи компьютера домена</span><span class="sxs-lookup"><span data-stu-id="bc27d-169">Kerberos Protocol Direct Requires the Service to Run Under a Domain Machine Account</span></span>  

 <span data-ttu-id="bc27d-170">Такая ситуация возникает, когда свойство `ClientCredentialType` имеет значение `Windows`, а свойство <xref:System.ServiceModel.MessageSecurityOverHttp.NegotiateServiceCredential%2A> - `false`, как показано в следующем примере кода.</span><span class="sxs-lookup"><span data-stu-id="bc27d-170">This occurs when the `ClientCredentialType` property is set to `Windows` and the <xref:System.ServiceModel.MessageSecurityOverHttp.NegotiateServiceCredential%2A> property is set to `false`, as shown in the following code.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#1)]
 [!code-vb[C_DebuggingWindowsAuth#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#1)]  
  
 <span data-ttu-id="bc27d-171">Чтобы решить эту проблему, запустите службу от имени учетной записи компьютера домена, например учетной записи Network Service, на компьютере, входящем в домен.</span><span class="sxs-lookup"><span data-stu-id="bc27d-171">To remedy, run the service using a Domain Machine account, such as Network Service, on a domain joined machine.</span></span>  
  
### <a name="delegation-requires-credential-negotiation"></a><span data-ttu-id="bc27d-172">Для делегирования требуется согласование учетных данных</span><span class="sxs-lookup"><span data-stu-id="bc27d-172">Delegation Requires Credential Negotiation</span></span>  

 <span data-ttu-id="bc27d-173">Для использования протокола проверки подлинности Kerberos с делегированием необходимо реализовать протокол Kerberos с согласованием учетных данных (иногда называется многоступенчатой проверкой подлинности Kerberos).</span><span class="sxs-lookup"><span data-stu-id="bc27d-173">To use the Kerberos authentication protocol with delegation, you must implement the Kerberos protocol with credential negotiation (sometimes called "multi-leg" or "multi-step" Kerberos).</span></span> <span data-ttu-id="bc27d-174">Если проверка подлинности Kerberos реализована без согласования учетных данных (иногда называется одноступенчатой проверкой подлинности Kerberos), возникает исключение.</span><span class="sxs-lookup"><span data-stu-id="bc27d-174">If you implement Kerberos authentication without credential negotiation (sometimes called "one-shot" or "single-leg" Kerberos), an exception will be thrown.</span></span>  
  
 <span data-ttu-id="bc27d-175">Чтобы реализовать протокол Kerberos с согласованием учетных данных, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="bc27d-175">To implement Kerberos with credential negotiation, do the following steps:</span></span>  
  
1. <span data-ttu-id="bc27d-176">Реализуйте делегирование, присвоив свойству <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> значение <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="bc27d-176">Implement delegation by setting <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span>  
  
2. <span data-ttu-id="bc27d-177">Потребуйте согласования SSPI:</span><span class="sxs-lookup"><span data-stu-id="bc27d-177">Require SSPI negotiation:</span></span>  
  
    1. <span data-ttu-id="bc27d-178">если используются стандартные привязки, установите свойство `NegotiateServiceCredential` равным `true`;</span><span class="sxs-lookup"><span data-stu-id="bc27d-178">If you are using standard bindings, set the `NegotiateServiceCredential` property to `true`.</span></span>  
  
    2. <span data-ttu-id="bc27d-179">если используются пользовательские привязки, установите атрибут `AuthenticationMode` элемента `Security` равным `SspiNegotiated`.</span><span class="sxs-lookup"><span data-stu-id="bc27d-179">If you are using custom bindings, set the `AuthenticationMode` attribute of the `Security` element to `SspiNegotiated`.</span></span>  
  
3. <span data-ttu-id="bc27d-180">Потребуйте, чтобы при согласовании SSPI использовался протокол Kerberos, запретив использование NTLM:</span><span class="sxs-lookup"><span data-stu-id="bc27d-180">Require the SSPI negotiation to use Kerberos by disallowing the use of NTLM:</span></span>  
  
    1. <span data-ttu-id="bc27d-181">для этого в коде воспользуйтесь инструкцией: `ChannelFactory.Credentials.Windows.AllowNtlm = false`;</span><span class="sxs-lookup"><span data-stu-id="bc27d-181">Do this in code, with the following statement: `ChannelFactory.Credentials.Windows.AllowNtlm = false`</span></span>  
  
    2. <span data-ttu-id="bc27d-182">либо в файле конфигурации установите атрибут `allowNtlm` равным `false`.</span><span class="sxs-lookup"><span data-stu-id="bc27d-182">Or you can do this in the configuration file by setting the `allowNtlm` attribute to `false`.</span></span> <span data-ttu-id="bc27d-183">Этот атрибут содержится в [\<windows>](../../configure-apps/file-schema/wcf/windows-of-clientcredentials-element.md) .</span><span class="sxs-lookup"><span data-stu-id="bc27d-183">This attribute is contained in the [\<windows>](../../configure-apps/file-schema/wcf/windows-of-clientcredentials-element.md).</span></span>  
  
### <a name="ntlm-protocol"></a><span data-ttu-id="bc27d-184">Протокол NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-184">NTLM Protocol</span></span>  
  
#### <a name="negotiate-ssp-falls-back-to-ntlm-but-ntlm-is-disabled"></a><span data-ttu-id="bc27d-185">В результате согласования SSP используется протокол NTLM, хотя протокол NTLM отключен</span><span class="sxs-lookup"><span data-stu-id="bc27d-185">Negotiate SSP Falls Back to NTLM, but NTLM Is Disabled</span></span>  

 <span data-ttu-id="bc27d-186"><xref:System.ServiceModel.Security.WindowsClientCredential.AllowNtlm%2A>Свойству присвоено значение `false` , которое приводит к тому, что Windows Communication Foundation (WCF) наилучшим образом выдавать исключение, если используется NTLM.</span><span class="sxs-lookup"><span data-stu-id="bc27d-186">The <xref:System.ServiceModel.Security.WindowsClientCredential.AllowNtlm%2A> property is set to `false`, which causes Windows Communication Foundation (WCF) to make a best-effort to throw an exception if NTLM is used.</span></span> <span data-ttu-id="bc27d-187">Установка этого свойства в значение `false` может препятствовать отправке учетных данных NTLM по сети.</span><span class="sxs-lookup"><span data-stu-id="bc27d-187">Setting this property to `false` may not prevent NTLM credentials from being sent over the wire.</span></span>  
  
 <span data-ttu-id="bc27d-188">Ниже показано, как отключить переключение к протоколу NTLM.</span><span class="sxs-lookup"><span data-stu-id="bc27d-188">The following shows how to disable fallback to NTLM.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#4)]
 [!code-vb[C_DebuggingWindowsAuth#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#4)]  
  
#### <a name="ntlm-logon-fails"></a><span data-ttu-id="bc27d-189">Сбой входа NTLM</span><span class="sxs-lookup"><span data-stu-id="bc27d-189">NTLM Logon Fails</span></span>  

 <span data-ttu-id="bc27d-190">Учетные данные клиента недействительны на стороне службы.</span><span class="sxs-lookup"><span data-stu-id="bc27d-190">The client credentials are not valid on the service.</span></span> <span data-ttu-id="bc27d-191">Проверьте, что имя пользователя и пароль заданы правильно и соответствуют учетной записи, которая известна компьютеру, на котором выполняется служба.</span><span class="sxs-lookup"><span data-stu-id="bc27d-191">Check that the user name and password are correctly set and correspond to an account that is known to the computer where the service is running.</span></span> <span data-ttu-id="bc27d-192">Протокол NTLM использует указанные учетные данные для входа на компьютер службы.</span><span class="sxs-lookup"><span data-stu-id="bc27d-192">NTLM uses the specified credentials to log on to the service's computer.</span></span> <span data-ttu-id="bc27d-193">Хотя эти учетные данные могут быть недействительными на компьютере клиента, сбой входа произойдет, если они будут недействительными на компьютере службы.</span><span class="sxs-lookup"><span data-stu-id="bc27d-193">While the credentials may be valid on the computer where the client is running, this logon will fail if the credentials are not valid on the service's computer.</span></span>  
  
#### <a name="anonymous-ntlm-logon-occurs-but-anonymous-logons-are-disabled-by-default"></a><span data-ttu-id="bc27d-194">Происходит анонимный вход NTLM, хотя по умолчанию анонимный вход отключен</span><span class="sxs-lookup"><span data-stu-id="bc27d-194">Anonymous NTLM Logon Occurs, but Anonymous Logons Are Disabled by Default</span></span>  

 <span data-ttu-id="bc27d-195">При создании клиента свойство <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> устанавливается равным <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, как показано в следующем примере кода, но по умолчанию сервер запрещает анонимный вход.</span><span class="sxs-lookup"><span data-stu-id="bc27d-195">When creating a client, the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property is set to <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, as shown in the following example, but by default the server disallows anonymous logons.</span></span> <span data-ttu-id="bc27d-196">Это происходит потому, что свойство <xref:System.ServiceModel.Security.WindowsServiceCredential.AllowAnonymousLogons%2A> класса <xref:System.ServiceModel.Security.WindowsServiceCredential> по умолчанию имеет значение `false`.</span><span class="sxs-lookup"><span data-stu-id="bc27d-196">This occurs because the default value of the <xref:System.ServiceModel.Security.WindowsServiceCredential.AllowAnonymousLogons%2A> property of the <xref:System.ServiceModel.Security.WindowsServiceCredential> class is `false`.</span></span>  
  
 <span data-ttu-id="bc27d-197">Следующий код клиента пытается включить анонимный вход (обратите внимание, что по умолчанию свойство имеет значение `Identification`).</span><span class="sxs-lookup"><span data-stu-id="bc27d-197">The following client code attempts to enable anonymous logons (note that the default property is `Identification`).</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#5)]
 [!code-vb[C_DebuggingWindowsAuth#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#5)]  
  
 <span data-ttu-id="bc27d-198">Следующий код службы изменяет значение по умолчанию, чтобы разрешить анонимный вход сервера.</span><span class="sxs-lookup"><span data-stu-id="bc27d-198">The following service code changes the default to enable anonymous logons by the server.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#6)]
 [!code-vb[C_DebuggingWindowsAuth#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#6)]  
  
 <span data-ttu-id="bc27d-199">Дополнительные сведения об олицетворении см. в разделе [Делегирование и олицетворение](delegation-and-impersonation-with-wcf.md).</span><span class="sxs-lookup"><span data-stu-id="bc27d-199">For more information about impersonation, see [Delegation and Impersonation](delegation-and-impersonation-with-wcf.md).</span></span>  
  
 <span data-ttu-id="bc27d-200">Либо клиент может выполняться в качестве службы Windows от имени встроенной учетной записи SYSTEM.</span><span class="sxs-lookup"><span data-stu-id="bc27d-200">Alternatively, the client is running as a Windows service, using the built-in account SYSTEM.</span></span>  
  
### <a name="other-problems"></a><span data-ttu-id="bc27d-201">Другие проблемы</span><span class="sxs-lookup"><span data-stu-id="bc27d-201">Other Problems</span></span>  
  
#### <a name="client-credentials-are-not-set-correctly"></a><span data-ttu-id="bc27d-202">Учетные данные клиента заданы неверно</span><span class="sxs-lookup"><span data-stu-id="bc27d-202">Client Credentials Are Not Set Correctly</span></span>  

 <span data-ttu-id="bc27d-203">При проверке подлинности Windows используется экземпляр <xref:System.ServiceModel.Security.WindowsClientCredential>, возвращаемый свойством <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> класса <xref:System.ServiceModel.ClientBase%601>, а не экземпляр <xref:System.ServiceModel.Security.UserNamePasswordClientCredential>.</span><span class="sxs-lookup"><span data-stu-id="bc27d-203">Windows authentication uses the <xref:System.ServiceModel.Security.WindowsClientCredential> instance returned by the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class, not the <xref:System.ServiceModel.Security.UserNamePasswordClientCredential>.</span></span> <span data-ttu-id="bc27d-204">Ниже приведен пример с ошибкой.</span><span class="sxs-lookup"><span data-stu-id="bc27d-204">The following shows an incorrect example.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#2)]
 [!code-vb[C_DebuggingWindowsAuth#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#2)]  
  
 <span data-ttu-id="bc27d-205">Ниже приведен пример без ошибки.</span><span class="sxs-lookup"><span data-stu-id="bc27d-205">The following shows the correct example.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#3)]
 [!code-vb[C_DebuggingWindowsAuth#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#3)]  
  
#### <a name="sspi-is-not-available"></a><span data-ttu-id="bc27d-206">Интерфейс SSPI недоступен</span><span class="sxs-lookup"><span data-stu-id="bc27d-206">SSPI Is Not Available</span></span>  

 <span data-ttu-id="bc27d-207">Следующие операционные системы не поддерживают проверку подлинности Windows при использовании в качестве сервера: Windows XP Home Edition, Windows XP Media Center Edition и домашние выпуски Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="bc27d-207">The following operating systems do not support Windows authentication when used as a server: Windows XP Home Edition, Windows XP Media Center Edition, and Windows Vista Home editions.</span></span>  
  
#### <a name="developing-and-deploying-with-different-identities"></a><span data-ttu-id="bc27d-208">Разработка и развертывание с использованием различных удостоверений</span><span class="sxs-lookup"><span data-stu-id="bc27d-208">Developing and Deploying with Different Identities</span></span>  

 <span data-ttu-id="bc27d-209">В случае разработки приложения на одном компьютере и его развертывания на другом компьютере с использованием для проверки подлинности на каждом из компьютеров учетных записей различных типов работа приложения может различаться.</span><span class="sxs-lookup"><span data-stu-id="bc27d-209">If you develop your application on one machine, and deploy on another, and use different account types to authenticate on each machine, you may experience different behavior.</span></span> <span data-ttu-id="bc27d-210">Предположим, приложение разрабатывается на компьютере под управлением Windows XP Professional Edition с использованием режима проверки подлинности `SSPI Negotiated`.</span><span class="sxs-lookup"><span data-stu-id="bc27d-210">For example, suppose you develop your application on a Windows XP Pro machine using the `SSPI Negotiated` authentication mode.</span></span> <span data-ttu-id="bc27d-211">Если для проверки подлинности используется учетная запись локального пользователя, будет использоваться протокол NTLM.</span><span class="sxs-lookup"><span data-stu-id="bc27d-211">If you use a local user account to authenticate with, then NTLM protocol will be used.</span></span> <span data-ttu-id="bc27d-212">После разработки приложения служба развертывается на компьютере под управлением Windows Server 2003, где она выполняется от имени учетной записи домена.</span><span class="sxs-lookup"><span data-stu-id="bc27d-212">Once the application is developed, you deploy the service to a Windows Server 2003 machine where it runs under a domain account.</span></span> <span data-ttu-id="bc27d-213">На этом этапе клиент не сможет проверить подлинность службы, так как он будет использовать Kerberos и контроллер домена.</span><span class="sxs-lookup"><span data-stu-id="bc27d-213">At this point, the client will not be able to authenticate the service because it will be using Kerberos and a domain controller.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="bc27d-214">См. также</span><span class="sxs-lookup"><span data-stu-id="bc27d-214">See also</span></span>

- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.Security.WindowsServiceCredential>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ClientBase%601>
- [<span data-ttu-id="bc27d-215">Делегирование и олицетворение</span><span class="sxs-lookup"><span data-stu-id="bc27d-215">Delegation and Impersonation</span></span>](delegation-and-impersonation-with-wcf.md)
- [<span data-ttu-id="bc27d-216">Неподдерживаемые сценарии</span><span class="sxs-lookup"><span data-stu-id="bc27d-216">Unsupported Scenarios</span></span>](unsupported-scenarios.md)
