---
description: 'Дополнительные сведения: обработка подозрительных сообщений'
title: Обработка подозрительных сообщений
ms.date: 03/30/2017
ms.assetid: 8d1c5e5a-7928-4a80-95ed-d8da211b8595
ms.openlocfilehash: 1d6c8027d44da4d79562e4e427654a3d85df3e88
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99793627"
---
# <a name="poison-message-handling"></a><span data-ttu-id="c50da-103">Обработка подозрительных сообщений</span><span class="sxs-lookup"><span data-stu-id="c50da-103">Poison Message Handling</span></span>

<span data-ttu-id="c50da-104">*Опасное сообщение* — это сообщение, которое превысило максимальное число попыток доставки в приложение.</span><span class="sxs-lookup"><span data-stu-id="c50da-104">A *poison message* is a message that has exceeded the maximum number of delivery attempts to the application.</span></span> <span data-ttu-id="c50da-105">Такая ситуация может возникнуть, если приложение с очередью не может обработать сообщение из-за ошибок.</span><span class="sxs-lookup"><span data-stu-id="c50da-105">This situation can arise when a queue-based application cannot process a message because of errors.</span></span> <span data-ttu-id="c50da-106">Чтобы отвечать требованиям надежности, приложение с очередью получает сообщения транзакционно.</span><span class="sxs-lookup"><span data-stu-id="c50da-106">To meet reliability demands, a queued application receives messages under a transaction.</span></span> <span data-ttu-id="c50da-107">Прерывание транзакции, в которой получено очередное сообщение, приводит к тому, что сообщение остается в очереди и новая попытка доставить его предпринимается в новой транзакции.</span><span class="sxs-lookup"><span data-stu-id="c50da-107">Aborting the transaction in which a queued message was received leaves the message in the queue so that the message is retried under a new transaction.</span></span> <span data-ttu-id="c50da-108">Если причина прерывания транзакции не устранена, принимающее приложение может зациклиться, получая и прерывая прием одного и того же сообщения, до достижения максимального числа попыток доставки и пометки сообщения как подозрительного.</span><span class="sxs-lookup"><span data-stu-id="c50da-108">If the problem that caused the transaction to abort is not corrected, the receiving application can get stuck in a loop receiving and aborting the same message until the maximum number of delivery attempts has been exceeded and a poison message results.</span></span>  
  
 <span data-ttu-id="c50da-109">Сообщение может стать подозрительным по многим причинам.</span><span class="sxs-lookup"><span data-stu-id="c50da-109">A message can become a poison message for many reasons.</span></span> <span data-ttu-id="c50da-110">Наиболее распространенные причины — зависящие от приложения.</span><span class="sxs-lookup"><span data-stu-id="c50da-110">The most common reasons are application-specific.</span></span> <span data-ttu-id="c50da-111">Например, если приложение читает сообщение из очереди и выполняет определенную обработку базы данных, приложение может потерпеть неудачу при попытке заблокировать базу данных и транзакция будет прервана.</span><span class="sxs-lookup"><span data-stu-id="c50da-111">For example, if an application reads a message from a queue and performs some database processing, the application may fail to get a lock on the database, causing it to abort the transaction.</span></span> <span data-ttu-id="c50da-112">Из-за прерывания транзакции базы данных сообщение остается в очереди, поэтому приложение повторно читает сообщение и делает попытку заблокировать базу данных.</span><span class="sxs-lookup"><span data-stu-id="c50da-112">Because the database transaction was aborted, the message remains in the queue, which causes the application to reread the message a second time and make another attempt to acquire a lock on the database.</span></span> <span data-ttu-id="c50da-113">Сообщения также могут быть подозрительными, если они содержат недопустимую информацию.</span><span class="sxs-lookup"><span data-stu-id="c50da-113">Messages can also become poison if they contain invalid information.</span></span> <span data-ttu-id="c50da-114">Например, заказ на покупку может содержать недопустимый номер заказчика.</span><span class="sxs-lookup"><span data-stu-id="c50da-114">For example, a purchase order may contain an invalid customer number.</span></span> <span data-ttu-id="c50da-115">В таких случаях приложение может по своему выбору прервать транзакцию и пометить сообщение как подозрительное.</span><span class="sxs-lookup"><span data-stu-id="c50da-115">In these cases, the application may voluntarily abort the transaction and force the message to become a poison message.</span></span>  
  
 <span data-ttu-id="c50da-116">В редких случаях не удается отправить сообщения приложению.</span><span class="sxs-lookup"><span data-stu-id="c50da-116">On rare occasions, messages can fail to get dispatched to the application.</span></span> <span data-ttu-id="c50da-117">Уровень Windows Communication Foundation (WCF) может обнаружить проблему с сообщением, например, если сообщение содержит неправильный кадр, к нему прикреплены недопустимые учетные данные или недопустимый заголовок действия.</span><span class="sxs-lookup"><span data-stu-id="c50da-117">The Windows Communication Foundation (WCF) layer may find a problem with the message, such as if the message has the wrong frame, invalid message credentials attached to it, or an invalid action header.</span></span> <span data-ttu-id="c50da-118">В таких случаях приложение не получает сообщение. Однако сообщение все еще может превратиться в подозрительное и быть обработано вручную.</span><span class="sxs-lookup"><span data-stu-id="c50da-118">In these cases, the application never receives the message; however, the message can still become a poison message and be processed manually.</span></span>  
  
## <a name="handling-poison-messages"></a><span data-ttu-id="c50da-119">Обработка подозрительных сообщений</span><span class="sxs-lookup"><span data-stu-id="c50da-119">Handling Poison Messages</span></span>  

 <span data-ttu-id="c50da-120">В WCF обработка подозрительных сообщений позволяет принимающему приложению работать с сообщениями, которые не могут быть отправлены в приложение или сообщения, отправляемые приложению, но не обрабатываются из-за особенностей конкретного приложения.</span><span class="sxs-lookup"><span data-stu-id="c50da-120">In WCF, poison message handling provides a mechanism for a receiving application to deal with messages that cannot be dispatched to the application or messages that are dispatched to the application but that fail to be processed because of application-specific reasons.</span></span> <span data-ttu-id="c50da-121">Настройте обработку подозрительных сообщений со следующими свойствами в каждой из доступных привязок в очереди:</span><span class="sxs-lookup"><span data-stu-id="c50da-121">Configure poison message handling with the following properties in each of the available queued bindings:</span></span>  
  
- <span data-ttu-id="c50da-122">`ReceiveRetryCount`.</span><span class="sxs-lookup"><span data-stu-id="c50da-122">`ReceiveRetryCount`.</span></span> <span data-ttu-id="c50da-123">Целое значение, указывающее максимальное число повторных попыток доставить сообщение из очереди приложения в приложение.</span><span class="sxs-lookup"><span data-stu-id="c50da-123">An integer value that indicates the maximum number of times to retry delivery of a message from the application queue to the application.</span></span> <span data-ttu-id="c50da-124">Значение по умолчанию — 5.</span><span class="sxs-lookup"><span data-stu-id="c50da-124">The default value is 5.</span></span> <span data-ttu-id="c50da-125">Это важно в тех случаях, когда немедленная повторная попытка решает проблему, например проблему со временной взаимоблокировкой в базе данных.</span><span class="sxs-lookup"><span data-stu-id="c50da-125">This is sufficient in cases where an immediate retry fixes the problem, such as with a temporary deadlock on a database.</span></span>  
  
- <span data-ttu-id="c50da-126">`MaxRetryCycles`.</span><span class="sxs-lookup"><span data-stu-id="c50da-126">`MaxRetryCycles`.</span></span> <span data-ttu-id="c50da-127">Целое значение, указывающее максимальное число циклов повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="c50da-127">An integer value that indicates the maximum number of retry cycles.</span></span> <span data-ttu-id="c50da-128">Цикл повторной попытки состоит из передачи сообщения из очереди приложения во вложенную очередь повторной отправки и, через настраиваемый промежуток времени, передачи из вложенной очереди повторной отправки обратно в очередь приложения для новой попытки доставки.</span><span class="sxs-lookup"><span data-stu-id="c50da-128">A retry cycle consists of transferring a message from the application queue to the retry subqueue and, after a configurable delay, from the retry subqueue back into the application queue to reattempt delivery.</span></span> <span data-ttu-id="c50da-129">Значение по умолчанию — 2.</span><span class="sxs-lookup"><span data-stu-id="c50da-129">The default value is 2.</span></span> <span data-ttu-id="c50da-130">В Windows Vista, сообщение пытается выполнить максимум ( `ReceiveRetryCount` + 1) \* ( `MaxRetryCycles` + 1) раз.</span><span class="sxs-lookup"><span data-stu-id="c50da-130">On Windows Vista, the message is tried a maximum of (`ReceiveRetryCount` +1) \* (`MaxRetryCycles` + 1) times.</span></span> <span data-ttu-id="c50da-131">`MaxRetryCycles` не учитывается в Windows Server 2003 и Windows XP.</span><span class="sxs-lookup"><span data-stu-id="c50da-131">`MaxRetryCycles` is ignored on Windows Server 2003 and Windows XP.</span></span>  
  
- <span data-ttu-id="c50da-132">`RetryCycleDelay`.</span><span class="sxs-lookup"><span data-stu-id="c50da-132">`RetryCycleDelay`.</span></span> <span data-ttu-id="c50da-133">Промежуток времени между циклами повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="c50da-133">The time delay between retry cycles.</span></span> <span data-ttu-id="c50da-134">Значение по умолчанию составляет 30 минут.</span><span class="sxs-lookup"><span data-stu-id="c50da-134">The default value is 30 minutes.</span></span> <span data-ttu-id="c50da-135">`MaxRetryCycles` и `RetryCycleDelay` вместе реализуют механизм устранения проблемы, решением которой может быть повторная попытка доставки сообщения с периодической задержкой.</span><span class="sxs-lookup"><span data-stu-id="c50da-135">`MaxRetryCycles` and `RetryCycleDelay` together provide a mechanism to address the problem where a retry after a periodic delay fixes the problem.</span></span> <span data-ttu-id="c50da-136">Например, это помогает для блокированного набора строк при отложенном завершении транзакции в SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c50da-136">For example, this handles a locked row set in SQL Server pending transaction commit.</span></span>  
  
- <span data-ttu-id="c50da-137">`ReceiveErrorHandling`.</span><span class="sxs-lookup"><span data-stu-id="c50da-137">`ReceiveErrorHandling`.</span></span> <span data-ttu-id="c50da-138">Перечисление, указывающее, какое действие выполняется для сообщения, доставка которого не удалась после максимального числа повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="c50da-138">An enumeration that indicates the action to take for a message that has failed delivery after the maximum number of retries has been attempted.</span></span> <span data-ttu-id="c50da-139">Возможные значения: Fault, Drop, Reject и Move.</span><span class="sxs-lookup"><span data-stu-id="c50da-139">The values can be Fault, Drop, Reject, and Move.</span></span> <span data-ttu-id="c50da-140">Значение по умолчанию - Fault.</span><span class="sxs-lookup"><span data-stu-id="c50da-140">The default option is Fault.</span></span>  
  
- <span data-ttu-id="c50da-141">Fault.</span><span class="sxs-lookup"><span data-stu-id="c50da-141">Fault.</span></span> <span data-ttu-id="c50da-142">Отправляется ошибка прослушивателю, который привел к сбою `ServiceHost`.</span><span class="sxs-lookup"><span data-stu-id="c50da-142">This option sends a fault to the listener that caused the `ServiceHost` to fault.</span></span> <span data-ttu-id="c50da-143">Сообщение должно быть удалено из очереди приложения при помощи внешнего механизма, прежде чем приложение сможет продолжить обрабатывать сообщения очереди.</span><span class="sxs-lookup"><span data-stu-id="c50da-143">The message must be removed from the application queue by some external mechanism before the application can continue to process messages from the queue.</span></span>  
  
- <span data-ttu-id="c50da-144">Drop.</span><span class="sxs-lookup"><span data-stu-id="c50da-144">Drop.</span></span> <span data-ttu-id="c50da-145">Подозрительное сообщение отбрасывается и никогда не будет доставлено в приложение.</span><span class="sxs-lookup"><span data-stu-id="c50da-145">This option drops the poison message and the message is never delivered to the application.</span></span> <span data-ttu-id="c50da-146">Если к этому моменту время, заданное свойством `TimeToLive` сообщения, истекло, сообщение может появиться в очереди недоставленных сообщений отправителя.</span><span class="sxs-lookup"><span data-stu-id="c50da-146">If the message's `TimeToLive` property has expired at this point, then the message may appear in the sender's dead-letter queue.</span></span> <span data-ttu-id="c50da-147">Если не истекло, сообщение нигде не появляется.</span><span class="sxs-lookup"><span data-stu-id="c50da-147">If not, the message does not appear anywhere.</span></span> <span data-ttu-id="c50da-148">Этот вариант означает, что пользователь не позаботился о том, что должно произойти в случае потери сообщения.</span><span class="sxs-lookup"><span data-stu-id="c50da-148">This option indicates that the user has not specified what to do if the message is lost.</span></span>  
  
- <span data-ttu-id="c50da-149">Reject.</span><span class="sxs-lookup"><span data-stu-id="c50da-149">Reject.</span></span> <span data-ttu-id="c50da-150">Этот параметр доступен только в Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="c50da-150">This option is available only on Windows Vista.</span></span> <span data-ttu-id="c50da-151">Это указывает очереди сообщений (MSMQ) отправить отрицательное подтверждение обратно в Диспетчер очереди отправки, который приложение не может получить сообщение.</span><span class="sxs-lookup"><span data-stu-id="c50da-151">This instructs Message Queuing (MSMQ) to send a negative acknowledgment back to the sending queue manager that the application cannot receive the message.</span></span> <span data-ttu-id="c50da-152">Сообщение помещается в очередь недоставленных сообщений диспетчера передающей очереди.</span><span class="sxs-lookup"><span data-stu-id="c50da-152">The message is placed in the sending queue manager's dead-letter queue.</span></span>  
  
- <span data-ttu-id="c50da-153">Move.</span><span class="sxs-lookup"><span data-stu-id="c50da-153">Move.</span></span> <span data-ttu-id="c50da-154">Этот параметр доступен только в Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="c50da-154">This option is available only on Windows Vista.</span></span> <span data-ttu-id="c50da-155">Подозрительное сообщение перемещается в очередь подозрительных сообщений для дальнейшей обработки приложением по работе с подозрительными сообщениями.</span><span class="sxs-lookup"><span data-stu-id="c50da-155">This moves the poison message to a poison-message queue for later processing by a poison-message handling application.</span></span> <span data-ttu-id="c50da-156">Очередь подозрительных сообщений является вложенной очередью очереди приложения.</span><span class="sxs-lookup"><span data-stu-id="c50da-156">The poison-message queue is a subqueue of the application queue.</span></span> <span data-ttu-id="c50da-157">Приложение для обработки подозрительных сообщений может быть службой WCF, считывающей сообщения из очереди подозрительных сообщений.</span><span class="sxs-lookup"><span data-stu-id="c50da-157">A poison-message handling application can be a WCF service that reads messages out of the poison queue.</span></span> <span data-ttu-id="c50da-158">Очередь подозрительных сообщений — это подочередь очереди приложений, которую можно решить как net. msmq:// \<*machine-name*> / *аппликатионкуеуе*;p оисон, где *Machine-Name* — это имя компьютера, на котором находится очередь, а *аппликатионкуеуе* — имя очереди конкретного приложения.</span><span class="sxs-lookup"><span data-stu-id="c50da-158">The poison queue is a subqueue of the application queue and can be addressed as net.msmq://\<*machine-name*>/*applicationQueue*;poison, where *machine-name* is the name of the computer on which the queue resides and the *applicationQueue* is the name of the application-specific queue.</span></span>  
  
<span data-ttu-id="c50da-159">Далее приведены максимальные числа попыток доставки для сообщения.</span><span class="sxs-lookup"><span data-stu-id="c50da-159">The following are the maximum number of delivery attempts made for a message:</span></span>  
  
- <span data-ttu-id="c50da-160">((ReceiveRetryCount + 1) \* (MaxRetryCycles + 1)) в Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="c50da-160">((ReceiveRetryCount+1) \* (MaxRetryCycles + 1)) on Windows Vista.</span></span>  
  
- <span data-ttu-id="c50da-161">(ReceiveRetryCount + 1) в Windows Server 2003 и Windows XP.</span><span class="sxs-lookup"><span data-stu-id="c50da-161">(ReceiveRetryCount + 1) on Windows Server 2003 and Windows XP.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="c50da-162">Для успешно доставленного сообщения повторных попыток доставки не выполняется.</span><span class="sxs-lookup"><span data-stu-id="c50da-162">No retries are made for a message that is delivered successfully.</span></span>  
  
 <span data-ttu-id="c50da-163">Чтобы отследить количество попыток чтения сообщения, в Windows Vista хранится устойчивое свойство сообщения, которое подсчитывает количество прерываний и свойство количества перемещений, которое подсчитывает количество передвижений сообщения между очередью приложения и подочередями.</span><span class="sxs-lookup"><span data-stu-id="c50da-163">To keep track of the number of times a message read is attempted, Windows Vista maintains a durable message property that counts the number of aborts and a move count property that counts the number of times the message moves between the application queue and subqueues.</span></span> <span data-ttu-id="c50da-164">Канал WCF использует их для вычисления числа повторных попыток получения и числа циклов повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="c50da-164">The WCF channel uses these to compute the receive retry count and the retry cycles count.</span></span> <span data-ttu-id="c50da-165">В Windows Server 2003 и Windows XP Счетчик прерываний сохраняется в памяти каналом WCF и сбрасывается в случае сбоя приложения.</span><span class="sxs-lookup"><span data-stu-id="c50da-165">On Windows Server 2003 and Windows XP, the abort count is maintained in memory by the WCF channel and is reset if the application fails.</span></span> <span data-ttu-id="c50da-166">Кроме того, канал WCF может содержать счетчики прерываний для до 256 сообщений в памяти в любое время.</span><span class="sxs-lookup"><span data-stu-id="c50da-166">Also, the WCF channel can hold the abort counts for up to 256 messages in memory at any time.</span></span> <span data-ttu-id="c50da-167">Когда прочитывается 257-е сообщение, подсчет числа прекращений для самого старого сообщения сбрасывается.</span><span class="sxs-lookup"><span data-stu-id="c50da-167">If a 257th message is read, then the oldest message's abort count is reset.</span></span>  
  
 <span data-ttu-id="c50da-168">Свойства подсчета прекращений и перемещений доступны для операции службы через контекст операции.</span><span class="sxs-lookup"><span data-stu-id="c50da-168">The abort count and move count properties are available to the service operation through the operation context.</span></span> <span data-ttu-id="c50da-169">В следующем примере кода представлен способ обращения к ним.</span><span class="sxs-lookup"><span data-stu-id="c50da-169">The following code example shows how to access them.</span></span>  
  
 [!code-csharp[S_UE_MSMQ_Poison#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/service.cs#1)]  
  
 <span data-ttu-id="c50da-170">WCF предоставляет две стандартные привязки в очереди:</span><span class="sxs-lookup"><span data-stu-id="c50da-170">WCF provides two standard queued bindings:</span></span>  
  
- <span data-ttu-id="c50da-171"><xref:System.ServiceModel.NetMsmqBinding>.</span><span class="sxs-lookup"><span data-stu-id="c50da-171"><xref:System.ServiceModel.NetMsmqBinding>.</span></span> <span data-ttu-id="c50da-172">Привязка платформа .NET Framework, подходящая для выполнения связи на основе очередей с другими конечными точками WCF.</span><span class="sxs-lookup"><span data-stu-id="c50da-172">A .NET Framework binding suitable for performing queue-based communication with other WCF endpoints.</span></span>  
  
- <span data-ttu-id="c50da-173"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span><span class="sxs-lookup"><span data-stu-id="c50da-173"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span></span> <span data-ttu-id="c50da-174">Привязка, подходящая для взаимодействия с существующими приложениями MSMQ.</span><span class="sxs-lookup"><span data-stu-id="c50da-174">A binding suitable for communicating with existing Message Queuing applications.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="c50da-175">Вы можете изменить свойства в этих привязках в зависимости от требований службы WCF.</span><span class="sxs-lookup"><span data-stu-id="c50da-175">You can alter properties in these bindings based on the requirements of your WCF service.</span></span> <span data-ttu-id="c50da-176">Весь механизм обработки подозрительных сообщений является локальным для принимающего приложения.</span><span class="sxs-lookup"><span data-stu-id="c50da-176">The entire poison message handling mechanism is local to the receiving application.</span></span> <span data-ttu-id="c50da-177">Этот процесс невидим для отправляющего приложения, если только принимающее приложение не останавливается и не посылает отправителю уведомление о недоставке.</span><span class="sxs-lookup"><span data-stu-id="c50da-177">The process is invisible to the sending application unless the receiving application ultimately stops and sends a negative acknowledgment back to the sender.</span></span> <span data-ttu-id="c50da-178">В таком случае сообщение перемещается в очередь недоставленных сообщений отправителя.</span><span class="sxs-lookup"><span data-stu-id="c50da-178">In that case, the message is moved to the sender's dead-letter queue.</span></span>  
  
## <a name="best-practice-handling-msmqpoisonmessageexception"></a><span data-ttu-id="c50da-179">Рекомендации. Обработка исключения MsmqPoisonMessageException</span><span class="sxs-lookup"><span data-stu-id="c50da-179">Best Practice: Handling MsmqPoisonMessageException</span></span>  

 <span data-ttu-id="c50da-180">Когда служба определяет, что сообщение подозрительно, транспорт очереди создает исключение <xref:System.ServiceModel.MsmqPoisonMessageException>, содержащее `LookupId` подозрительного сообщения.</span><span class="sxs-lookup"><span data-stu-id="c50da-180">When the service determines that a message is poison, the queued transport throws a <xref:System.ServiceModel.MsmqPoisonMessageException> that contains the `LookupId` of the poison message.</span></span>  
  
 <span data-ttu-id="c50da-181">Принимающее приложение может реализовывать интерфейс <xref:System.ServiceModel.Dispatcher.IErrorHandler> для обработки всех необходимых ошибок.</span><span class="sxs-lookup"><span data-stu-id="c50da-181">A receiving application can implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface to handle any errors that the application requires.</span></span> <span data-ttu-id="c50da-182">Дополнительные сведения см. в разделе [расширение управления обработкой ошибок и создание отчетов](../samples/extending-control-over-error-handling-and-reporting.md).</span><span class="sxs-lookup"><span data-stu-id="c50da-182">For more information, see [Extending Control Over Error Handling and Reporting](../samples/extending-control-over-error-handling-and-reporting.md).</span></span>  
  
 <span data-ttu-id="c50da-183">Приложению может требоваться определенная автоматическая обработка подозрительных сообщений, перемещающая подозрительные сообщения в очередь подозрительных сообщений, чтобы служба могла получить доступ к оставшимся сообщениям в очереди.</span><span class="sxs-lookup"><span data-stu-id="c50da-183">The application may require some kind of automated handling of poison messages that moves the poison messages to a poison message queue so that the service can access the rest of the messages in the queue.</span></span> <span data-ttu-id="c50da-184">Использование механизма обработчика ошибок для ожидания возникновения исключений, связанных с подозрительными сообщениями, возможно только если параметр <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> имеет значение <xref:System.ServiceModel.ReceiveErrorHandling.Fault>.</span><span class="sxs-lookup"><span data-stu-id="c50da-184">The only scenario for using the error-handler mechanism to listen for poison-message exceptions is when the <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> setting is set to <xref:System.ServiceModel.ReceiveErrorHandling.Fault>.</span></span> <span data-ttu-id="c50da-185">Пример подозрительного сообщения для MSMQ 3.0 иллюстрирует такое поведение.</span><span class="sxs-lookup"><span data-stu-id="c50da-185">The poison-message sample for Message Queuing 3.0 demonstrates this behavior.</span></span> <span data-ttu-id="c50da-186">Далее описаны основные шаги, которые необходимо предпринять для обработки подозрительных сообщений, также даны рекомендации.</span><span class="sxs-lookup"><span data-stu-id="c50da-186">The following outlines the steps to take to handle poison messages, including best practices:</span></span>  
  
1. <span data-ttu-id="c50da-187">Убедитесь, что параметры, заданные для подозрительных сообщений, отражают требования приложения.</span><span class="sxs-lookup"><span data-stu-id="c50da-187">Ensure your poison settings reflect the requirements of your application.</span></span> <span data-ttu-id="c50da-188">При работе с параметрами убедитесь, что вы понимаете различия между возможностями очереди сообщений в Windows Vista, Windows Server 2003 и Windows XP.</span><span class="sxs-lookup"><span data-stu-id="c50da-188">When working with the settings, ensure that you understand the differences between the capabilities of Message Queuing on Windows Vista, Windows Server 2003, and Windows XP.</span></span>  
  
2. <span data-ttu-id="c50da-189">При необходимости реализуйте объект `IErrorHandler` для управления ошибками подозрительных сообщений.</span><span class="sxs-lookup"><span data-stu-id="c50da-189">If necessary, implement the `IErrorHandler` to handle poison-message errors.</span></span> <span data-ttu-id="c50da-190">Поскольку, если задать для свойства `ReceiveErrorHandling` значение `Fault`, потребуется ручной механизм для перемещения подозрительного сообщения из очереди или для исправления проблем, связанных со внешними обстоятельствами, стандартное использование - реализация `IErrorHandler` со значением `ReceiveErrorHandling` свойства `Fault`, как показано в следующем коде.</span><span class="sxs-lookup"><span data-stu-id="c50da-190">Because setting `ReceiveErrorHandling` to `Fault` requires a manual mechanism to move the poison message out of the queue or to correct an external dependent issue, the typical usage is to implement `IErrorHandler` when `ReceiveErrorHandling` is set to `Fault`, as shown in the following code.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonerrorhandler.cs#2)]  
  
3. <span data-ttu-id="c50da-191">Создайте атрибут `PoisonBehaviorAttribute`, который сможет использовать поведение службы.</span><span class="sxs-lookup"><span data-stu-id="c50da-191">Create a `PoisonBehaviorAttribute` that the service behavior can use.</span></span> <span data-ttu-id="c50da-192">Поведение устанавливает `IErrorHandler` в диспетчере.</span><span class="sxs-lookup"><span data-stu-id="c50da-192">The behavior installs the `IErrorHandler` on the dispatcher.</span></span> <span data-ttu-id="c50da-193">См. следующий пример кода.</span><span class="sxs-lookup"><span data-stu-id="c50da-193">See the following code example.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonbehaviorattribute.cs#3)]  
  
4. <span data-ttu-id="c50da-194">Убедитесь, что служба помечена атрибутом PoisonBehaviorAttribute.</span><span class="sxs-lookup"><span data-stu-id="c50da-194">Ensure that your service is annotated with the poison behavior attribute.</span></span>  

 <span data-ttu-id="c50da-195">Кроме того, если свойство `ReceiveErrorHandling` имеет значение `Fault`, `ServiceHost` завершает работу с ошибкой, если встречает подозрительное сообщение.</span><span class="sxs-lookup"><span data-stu-id="c50da-195">In addition, if the `ReceiveErrorHandling` is set to `Fault`, the `ServiceHost` faults when encountering the poison message.</span></span> <span data-ttu-id="c50da-196">Можно подключиться к событию с ошибкой и завершить работу службы, предпринять действия по исправлению ошибки и перезапустить службу.</span><span class="sxs-lookup"><span data-stu-id="c50da-196">You can hook up to the faulted event and shut down the service, take corrective actions, and restart.</span></span> <span data-ttu-id="c50da-197">Например, `LookupId` в исключении <xref:System.ServiceModel.MsmqPoisonMessageException>, распространенный на объект `IErrorHandler`, может запоминаться, и когда узел службы завершает работу с ошибкой, можно использовать API `System.Messaging` для получения сообщения из очереди с помощью `LookupId`, чтобы удалить сообщение из очереди и сохранить его во внешнем хранилище или другой очереди.</span><span class="sxs-lookup"><span data-stu-id="c50da-197">For example, the `LookupId` in the <xref:System.ServiceModel.MsmqPoisonMessageException> propagated to the `IErrorHandler` can be noted and when the service host faults, you could use the `System.Messaging` API to receive the message from the queue using the `LookupId` to remove the message from the queue and store the message in some external store or another queue.</span></span> <span data-ttu-id="c50da-198">Затем можно перезапустить `ServiceHost`, чтобы возобновить нормальную работу.</span><span class="sxs-lookup"><span data-stu-id="c50da-198">You can then restart `ServiceHost` to resume normal processing.</span></span> <span data-ttu-id="c50da-199">Это поведение демонстрируется [в обработке подозрительных сообщений в MSMQ 4,0](../samples/poison-message-handling-in-msmq-4-0.md) .</span><span class="sxs-lookup"><span data-stu-id="c50da-199">The [Poison Message Handling in MSMQ 4.0](../samples/poison-message-handling-in-msmq-4-0.md) demonstrates this behavior.</span></span>  
  
## <a name="transaction-time-out-and-poison-messages"></a><span data-ttu-id="c50da-200">Время ожидания транзакции и подозрительные сообщения</span><span class="sxs-lookup"><span data-stu-id="c50da-200">Transaction Time-Out and Poison Messages</span></span>  

 <span data-ttu-id="c50da-201">Между транспортным каналом очереди и пользовательским кодом может возникнуть класс ошибок.</span><span class="sxs-lookup"><span data-stu-id="c50da-201">A class of errors can occur between the queued transport channel and the user code.</span></span> <span data-ttu-id="c50da-202">Эти ошибки могут быть обнаружены промежуточными уровнями, например уровнем безопасности сообщений или логикой отправки службы.</span><span class="sxs-lookup"><span data-stu-id="c50da-202">These errors can be detected by layers in-between, such as the message security layer or the service dispatching logic.</span></span> <span data-ttu-id="c50da-203">Например, отсутствие сертификата X.509, обнаруженное на уровне безопасности SOAP, и отсутствие действия - случаи отправки сообщения приложению.</span><span class="sxs-lookup"><span data-stu-id="c50da-203">For example, a missing X.509 certificate detected in the SOAP security layer and a missing action are cases where the message does get dispatched to the application.</span></span> <span data-ttu-id="c50da-204">Когда возникает такая ситуация, модель службы отбрасывает сообщение.</span><span class="sxs-lookup"><span data-stu-id="c50da-204">When this happens, the service model drops the message.</span></span> <span data-ttu-id="c50da-205">Так как чтение сообщения происходит в транзакции и результат транзакции не может быт получен, время ожидания транзакции истекает, транзакция прерывается и сообщение помещается обратно в очередь.</span><span class="sxs-lookup"><span data-stu-id="c50da-205">Because the message is read in a transaction and an outcome for that transaction cannot be provided, the transaction eventually times out, aborts, and the message is put back into the queue.</span></span> <span data-ttu-id="c50da-206">Иными словами, для определенного класса ошибок транзакция не прекращается немедленно, но ожидает до истечения времени ожидания транзакции. Вы можете изменить время ожидания транзакции для службы с помощью <xref:System.ServiceModel.ServiceBehaviorAttribute> .</span><span class="sxs-lookup"><span data-stu-id="c50da-206">In other words, for a certain class of errors, the transaction does not immediately abort but waits until the transaction times out. You can modify the transaction time-out for a service using <xref:System.ServiceModel.ServiceBehaviorAttribute>.</span></span>  
  
 <span data-ttu-id="c50da-207">Чтобы изменить время ожидания транзакции на уровне компьютера, измените файл machine.config и задайте время ожидания для соответствующей транзакции. Важно отметить, что в зависимости от времени ожидания, установленного в транзакции, транзакция в конечном итоге прерывается и возвращается в очередь, а ее счетчик прерываний увеличивается.</span><span class="sxs-lookup"><span data-stu-id="c50da-207">To change the transaction time-out on a computer-wide basis, modify the machine.config file and set the appropriate transaction time-out. It is important to note that, depending on the time-out set in the transaction, the transaction eventually aborts and goes back to the queue and its abort count is incremented.</span></span> <span data-ttu-id="c50da-208">В итоге сообщение становится подозрительным и предпринимаются действия в соответствии с параметрами пользователя.</span><span class="sxs-lookup"><span data-stu-id="c50da-208">Eventually, the message becomes poison and the right disposition is made according to the user settings.</span></span>  
  
## <a name="sessions-and-poison-messages"></a><span data-ttu-id="c50da-209">Сеансы и подозрительные сообщения</span><span class="sxs-lookup"><span data-stu-id="c50da-209">Sessions and Poison Messages</span></span>  

 <span data-ttu-id="c50da-210">Сеанс проходит те же процедуры повторных попыток и обработки подозрительных сообщений, что и отдельное сообщение.</span><span class="sxs-lookup"><span data-stu-id="c50da-210">A session undergoes the same retry and poison-message handling procedures as a single message.</span></span> <span data-ttu-id="c50da-211">Свойства, перечисленные ранее для подозрительных сообщений, применимы и к целому сеансу.</span><span class="sxs-lookup"><span data-stu-id="c50da-211">The properties previously listed for poison messages apply to the entire session.</span></span> <span data-ttu-id="c50da-212">Это значит, что происходит повторная попытка выполнения сеанса целиком, и он перемещается в конечную очередь подозрительных сообщений или очередь недоставленных сообщений отправителя, если сообщение не принято.</span><span class="sxs-lookup"><span data-stu-id="c50da-212">This means that the entire session is retried and goes to a final poison-message queue or the sender’s dead-letter queue if the message is rejected.</span></span>  
  
## <a name="batching-and-poison-messages"></a><span data-ttu-id="c50da-213">Пакетирование и подозрительные сообщения</span><span class="sxs-lookup"><span data-stu-id="c50da-213">Batching and Poison Messages</span></span>  

 <span data-ttu-id="c50da-214">Если сообщение о сбое становится подозрительным и представляет собой часть пакета, весь пакет откатывается и канал возвращается к чтению сообщений по одному.</span><span class="sxs-lookup"><span data-stu-id="c50da-214">If a message becomes a poison message and is part of a batch, then the entire batch is rolled back and the channel returns to reading one message at a time.</span></span> <span data-ttu-id="c50da-215">Дополнительные сведения о пакетной обработке см. [в разделе пакетирование сообщений в транзакции](batching-messages-in-a-transaction.md) .</span><span class="sxs-lookup"><span data-stu-id="c50da-215">For more information about batching, see [Batching Messages in a Transaction](batching-messages-in-a-transaction.md)</span></span>  
  
## <a name="poison-message-handling-for-messages-in-a-poison-queue"></a><span data-ttu-id="c50da-216">Обработка подозрительных сообщений из очереди подозрительных сообщений</span><span class="sxs-lookup"><span data-stu-id="c50da-216">Poison-message Handling for Messages in a Poison Queue</span></span>  

 <span data-ttu-id="c50da-217">Обработка подозрительного сообщения не заканчивается его перемещением в очередь подозрительных сообщений.</span><span class="sxs-lookup"><span data-stu-id="c50da-217">Poison-message handling does not end when a message is placed in the poison-message queue.</span></span> <span data-ttu-id="c50da-218">Сообщения из очереди подозрительных сообщений по прежнему должны прочитываться и обрабатываться.</span><span class="sxs-lookup"><span data-stu-id="c50da-218">Messages in the poison-message queue must still be read and handled.</span></span> <span data-ttu-id="c50da-219">При чтении сообщений из конечной вложенной очереди подозрительных сообщений можно использовать подмножество параметров обработки подозрительных сообщений.</span><span class="sxs-lookup"><span data-stu-id="c50da-219">You can use a subset of the poison-message handling settings when reading messages from the final poison subqueue.</span></span> <span data-ttu-id="c50da-220">Применимые параметры: `ReceiveRetryCount` и `ReceiveErrorHandling`.</span><span class="sxs-lookup"><span data-stu-id="c50da-220">The applicable settings are `ReceiveRetryCount` and `ReceiveErrorHandling`.</span></span> <span data-ttu-id="c50da-221">`ReceiveErrorHandling` можно установить в значение Drop, Reject или Fault.</span><span class="sxs-lookup"><span data-stu-id="c50da-221">You can set `ReceiveErrorHandling` to Drop, Reject, or Fault.</span></span> <span data-ttu-id="c50da-222">`MaxRetryCycles` не обрабатывает исключение, если параметр `ReceiveErrorHandling` установлен в значение Move.</span><span class="sxs-lookup"><span data-stu-id="c50da-222">`MaxRetryCycles` is ignored and an exception is thrown if `ReceiveErrorHandling` is set to Move.</span></span>  
  
## <a name="windows-vista-windows-server-2003-and-windows-xp-differences"></a><span data-ttu-id="c50da-223">Различия Windows Vista, Windows Server 2003 и Windows XP</span><span class="sxs-lookup"><span data-stu-id="c50da-223">Windows Vista, Windows Server 2003, and Windows XP Differences</span></span>  

 <span data-ttu-id="c50da-224">Как отмечалось ранее, не все параметры обработки подозрительных сообщений применяются к Windows Server 2003 и Windows XP.</span><span class="sxs-lookup"><span data-stu-id="c50da-224">As noted earlier, not all poison-message handling settings apply to Windows Server 2003 and Windows XP.</span></span> <span data-ttu-id="c50da-225">Следующие основные различия между очередью сообщений в Windows Server 2003, Windows XP и Windows Vista связаны с обработкой подозрительных сообщений:</span><span class="sxs-lookup"><span data-stu-id="c50da-225">The following key differences between Message Queuing on Windows Server 2003, Windows XP, and Windows Vista are relevant to poison-message handling:</span></span>  
  
- <span data-ttu-id="c50da-226">Очередь сообщений в Windows Vista поддерживает подочереди, в то время как Windows Server 2003 и Windows XP не поддерживают подочереди.</span><span class="sxs-lookup"><span data-stu-id="c50da-226">Message Queuing in Windows Vista supports subqueues, while Windows Server 2003 and Windows XP do not support subqueues.</span></span> <span data-ttu-id="c50da-227">Вложенные очереди используются при обработке подозрительных сообщений.</span><span class="sxs-lookup"><span data-stu-id="c50da-227">Subqueues are used in poison-message handling.</span></span> <span data-ttu-id="c50da-228">Очереди повторных попыток и очередь подозрительных сообщений являются вложенными очередями очереди приложения, созданной на основе параметров обработки подозрительных сообщений.</span><span class="sxs-lookup"><span data-stu-id="c50da-228">The retry queues and the poison queue are subqueues to the application queue that is created based on the poison-message handling settings.</span></span> <span data-ttu-id="c50da-229">Значение `MaxRetryCycles` указывает, сколько необходимо создать вложенных очередей повторных попыток.</span><span class="sxs-lookup"><span data-stu-id="c50da-229">The `MaxRetryCycles` dictates how many retry subqueues to create.</span></span> <span data-ttu-id="c50da-230">Поэтому при работе в Windows Server 2003 или Windows XP `MaxRetryCycles` они игнорируются и `ReceiveErrorHandling.Move` не разрешаются.</span><span class="sxs-lookup"><span data-stu-id="c50da-230">Therefore, when running on Windows Server 2003 or Windows XP, `MaxRetryCycles` are ignored and `ReceiveErrorHandling.Move` is not allowed.</span></span>  
  
- <span data-ttu-id="c50da-231">Очередь сообщений в Windows Vista поддерживает негативное подтверждение, в то время как в Windows Server 2003 и Windows XP это не так.</span><span class="sxs-lookup"><span data-stu-id="c50da-231">Message Queuing in Windows Vista supports negative acknowledgment, while Windows Server 2003 and Windows XP do not.</span></span> <span data-ttu-id="c50da-232">Уведомление о недоставке от диспетчера принимающей очереди приводит к тому, что диспетчер передающей очереди помещает сообщение в очередь недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="c50da-232">A negative acknowledgment from the receiving queue manager causes the sending queue manager to place the rejected message in the dead-letter queue.</span></span> <span data-ttu-id="c50da-233">`ReceiveErrorHandling.Reject`Это не допускается в Windows Server 2003 и Windows XP.</span><span class="sxs-lookup"><span data-stu-id="c50da-233">As such, `ReceiveErrorHandling.Reject` is not allowed with Windows Server 2003 and Windows XP.</span></span>  
  
- <span data-ttu-id="c50da-234">Служба очереди сообщений в Windows Vista поддерживает свойство Message, которое хранит количество попыток доставки сообщений.</span><span class="sxs-lookup"><span data-stu-id="c50da-234">Message Queuing in Windows Vista supports a message property that keeps count of the number of times message delivery is attempted.</span></span> <span data-ttu-id="c50da-235">Это свойство счетчика прерываний недоступно в Windows Server 2003 и Windows XP.</span><span class="sxs-lookup"><span data-stu-id="c50da-235">This abort count property is not available on Windows Server 2003 and Windows XP.</span></span> <span data-ttu-id="c50da-236">WCF поддерживает счетчик прерываний в памяти, поэтому возможно, что это свойство не может содержать точное значение, если одно и то же сообщение считывается несколькими службами WCF в ферме.</span><span class="sxs-lookup"><span data-stu-id="c50da-236">WCF maintains the abort count in memory, so it is possible that this property may not contain an accurate value when the same message is read by more than one WCF service in a farm.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c50da-237">См. также</span><span class="sxs-lookup"><span data-stu-id="c50da-237">See also</span></span>

- [<span data-ttu-id="c50da-238">Общие сведения об очередях</span><span class="sxs-lookup"><span data-stu-id="c50da-238">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="c50da-239">Различия в возможностях очередей в Windows Vista, Windows Server 2003 и Windows XP</span><span class="sxs-lookup"><span data-stu-id="c50da-239">Differences in Queuing Features in Windows Vista, Windows Server 2003, and Windows XP</span></span>](diff-in-queue-in-vista-server-2003-windows-xp.md)
- [<span data-ttu-id="c50da-240">Задание и обработка сбоев в контрактах и службах</span><span class="sxs-lookup"><span data-stu-id="c50da-240">Specifying and Handling Faults in Contracts and Services</span></span>](../specifying-and-handling-faults-in-contracts-and-services.md)
