---
description: 'Дополнительные сведения: протокол обмена контекстом'
title: Протокол обмена контекстом
ms.date: 03/30/2017
ms.assetid: 3dfd38e0-ae52-491c-94f4-7a862b9843d4
ms.openlocfilehash: c4c81ef28821cd7373d53822728490d50687d5f2
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99780535"
---
# <a name="context-exchange-protocol"></a><span data-ttu-id="a6973-103">Протокол обмена контекстом</span><span class="sxs-lookup"><span data-stu-id="a6973-103">Context Exchange Protocol</span></span>

<span data-ttu-id="a6973-104">В этом разделе описывается протокол обмена контекстом, представленный в выпуске Windows Communication Foundation (WCF) платформа .NET Framework версии 3,5.</span><span class="sxs-lookup"><span data-stu-id="a6973-104">This section describes the context exchange protocol introduced in Windows Communication Foundation (WCF) release .NET Framework version 3.5.</span></span> <span data-ttu-id="a6973-105">Этот протокол позволяет клиентскому каналу принимать контекст, предоставленный службой, и применять его ко всем последующим запросам, поступающим в эту службу через тот же экземпляр клиентского канала.</span><span class="sxs-lookup"><span data-stu-id="a6973-105">This protocol allows the client channel to accept a context supplied by a service and apply it to all subsequent requests to that service sent over the same client channel instance.</span></span> <span data-ttu-id="a6973-106">Для распространения контекста между сервером и клиентом реализация протокола обмена контекстом может использовать один из двух механизмов: файлы cookie HTTP или заголовок SOAP.</span><span class="sxs-lookup"><span data-stu-id="a6973-106">The implementation of the context exchange protocol can use one of the following two mechanisms to propagate the context between the server and the client: HTTP cookies or a SOAP header.</span></span>  
  
 <span data-ttu-id="a6973-107">Протокол обмена контекстом реализуется на уровне пользовательских каналов.</span><span class="sxs-lookup"><span data-stu-id="a6973-107">The context exchange protocol is implemented in a custom channel layer.</span></span> <span data-ttu-id="a6973-108">Канал передает контекст на уровень приложения и обратно с помощью свойства <xref:System.ServiceModel.Channels.ContextMessageProperty>.</span><span class="sxs-lookup"><span data-stu-id="a6973-108">The channel communicates the context to and from the application layer using a <xref:System.ServiceModel.Channels.ContextMessageProperty> property.</span></span> <span data-ttu-id="a6973-109">Для передачи данных между конечными точками значение контекста либо сериализуется в качестве заголовка SOAP на уровне канала, либо преобразуется в свойства сообщения, представляющие HTTP-запрос и ответ.</span><span class="sxs-lookup"><span data-stu-id="a6973-109">For transmission between endpoints, the value of the context is either serialized as a SOAP header at the channel layer, or converted to or from the message properties that represent a HTTP request and response.</span></span> <span data-ttu-id="a6973-110">В последнем случае предполагается, что один из используемых уровней канала преобразует свойства сообщений HTTP-запроса и ответа в файлы cookie HTTP и обратно соответственно.</span><span class="sxs-lookup"><span data-stu-id="a6973-110">In the latter case, it is expected that one of the underlying channel layers converts the HTTP request and response message properties to and from HTTP cookies, respectively.</span></span> <span data-ttu-id="a6973-111">Выбор механизма обмена контекстом осуществляется с помощью свойства <xref:System.ServiceModel.Channels.ContextExchangeMechanism> в элементе привязки <xref:System.ServiceModel.Channels.ContextBindingElement>.</span><span class="sxs-lookup"><span data-stu-id="a6973-111">The choice of the mechanism used to exchange the context is done using the <xref:System.ServiceModel.Channels.ContextExchangeMechanism> property on the <xref:System.ServiceModel.Channels.ContextBindingElement>.</span></span> <span data-ttu-id="a6973-112">Допустимые значения: `HttpCookie` или `SoapHeader`.</span><span class="sxs-lookup"><span data-stu-id="a6973-112">Valid values are `HttpCookie` or `SoapHeader`.</span></span>  
  
 <span data-ttu-id="a6973-113">На стороне клиента экземпляр канала может работать в двух режимах на основе параметров в свойстве канала <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A>.</span><span class="sxs-lookup"><span data-stu-id="a6973-113">On the client, an instance of a channel can operate in two modes based on the settings on the channel property, <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A>.</span></span>  
  
## <a name="mode-1-channel-context-management"></a><span data-ttu-id="a6973-114">Режим 1: управление контекстом канала</span><span class="sxs-lookup"><span data-stu-id="a6973-114">Mode 1: Channel Context Management</span></span>  

 <span data-ttu-id="a6973-115">Этот режим используется по умолчанию, если параметру <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> задано значение `true`.</span><span class="sxs-lookup"><span data-stu-id="a6973-115">This is the default mode where <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> is set to `true`.</span></span> <span data-ttu-id="a6973-116">В этом режиме канал контекста управляет контекстом и кэширует его в течение времени его существования.</span><span class="sxs-lookup"><span data-stu-id="a6973-116">In this mode the context channel manages the context and caches the context during its lifetime.</span></span> <span data-ttu-id="a6973-117">Контекст может быть извлечен из канала с помощью свойства канала `IContextManager` вызовом метода `GetContext`.</span><span class="sxs-lookup"><span data-stu-id="a6973-117">Context can be retrieved from the channel through channel property `IContextManager` by calling the `GetContext` method.</span></span> <span data-ttu-id="a6973-118">Можно также заранее инициализировать канал с конкретным контекстом до его открытия вызовом метода `SetContext` для свойства канала.</span><span class="sxs-lookup"><span data-stu-id="a6973-118">The channel can also be pre-initialized with specific context before being opened by calling the `SetContext` method on the channel property.</span></span> <span data-ttu-id="a6973-119">Если канал инициализирован с контекстом, его сброс невозможен.</span><span class="sxs-lookup"><span data-stu-id="a6973-119">Once the channel is initialized with context it cannot be reset.</span></span>  
  
 <span data-ttu-id="a6973-120">В этом режиме перечисленное ниже остается неизменным.</span><span class="sxs-lookup"><span data-stu-id="a6973-120">The following is a list of invariants in this mode:</span></span>  
  
- <span data-ttu-id="a6973-121">Любая попытка сброса контекста с помощью `SetContext` после того, как канал был открыт, приводит к возникновению исключения <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="a6973-121">Any attempt to reset the context using `SetContext` after the channel has been opened throws an <xref:System.InvalidOperationException>.</span></span>  
  
- <span data-ttu-id="a6973-122">Любая попытка отправить контекст с использованием свойства <xref:System.ServiceModel.Channels.ContextMessageProperty> в исходящем сообщении вызывает исключение <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="a6973-122">Any attempt to send context by using the <xref:System.ServiceModel.Channels.ContextMessageProperty> in an outgoing message throws an <xref:System.InvalidOperationException>.</span></span>  
  
- <span data-ttu-id="a6973-123">Если от сервера получено сообщение с конкретным контекстом, а канал уже инициализирован с конкретным контекстом, создается исключение <xref:System.ServiceModel.ProtocolException>.</span><span class="sxs-lookup"><span data-stu-id="a6973-123">If a message is received from server with a specific context, when the channel has already been initialized with a specific context, this results in a <xref:System.ServiceModel.ProtocolException>.</span></span>  
  
    > [!NOTE]
    > <span data-ttu-id="a6973-124">Рекомендуется получать исходный контекст с сервера, только если канал был открыт без явного задания контекста.</span><span class="sxs-lookup"><span data-stu-id="a6973-124">It is appropriate to receive an initial context from the server only if the channel is opened without any context set explicitly.</span></span>  
  
- <span data-ttu-id="a6973-125">Свойство <xref:System.ServiceModel.Channels.ContextMessageProperty> для входящего сообщения всегда null.</span><span class="sxs-lookup"><span data-stu-id="a6973-125">The <xref:System.ServiceModel.Channels.ContextMessageProperty> on incoming message is always null.</span></span>  
  
## <a name="mode-2-application-context-management"></a><span data-ttu-id="a6973-126">Режим 2: управление контекстом приложения</span><span class="sxs-lookup"><span data-stu-id="a6973-126">Mode 2: Application Context Management</span></span>  

 <span data-ttu-id="a6973-127">Этот режим используется, если свойству <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> присвоено значение `false`.</span><span class="sxs-lookup"><span data-stu-id="a6973-127">This is the mode when <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> is set to `false`.</span></span> <span data-ttu-id="a6973-128">В этом режиме канал контекста не управляет контекстом.</span><span class="sxs-lookup"><span data-stu-id="a6973-128">In this mode the context channel does not manage context.</span></span> <span data-ttu-id="a6973-129">Ответственность за извлечение, обработку и применение контекста с использованием свойства <xref:System.ServiceModel.Channels.ContextMessageProperty> возлагается на приложение.</span><span class="sxs-lookup"><span data-stu-id="a6973-129">It is the application's responsibility to retrieve, manage and apply context by using the <xref:System.ServiceModel.Channels.ContextMessageProperty>.</span></span> <span data-ttu-id="a6973-130">Любая попытка вызова метода `GetContext` или `SetContext` приводит к возникновению исключения <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="a6973-130">Any attempt to call `GetContext` or `SetContext` results in an <xref:System.InvalidOperationException>.</span></span>  
  
 <span data-ttu-id="a6973-131">Независимо от выбранного режима работы фабрика клиентских каналов поддерживает шаблоны обмена сообщениями <xref:System.ServiceModel.Channels.IRequestChannel>, <xref:System.ServiceModel.Channels.IRequestSessionChannel> и <xref:System.ServiceModel.Channels.IDuplexSessionChannel></span><span class="sxs-lookup"><span data-stu-id="a6973-131">No matter which mode is chosen the client channel factory supports <xref:System.ServiceModel.Channels.IRequestChannel>, <xref:System.ServiceModel.Channels.IRequestSessionChannel>, and <xref:System.ServiceModel.Channels.IDuplexSessionChannel> message exchange patterns.</span></span>  
  
 <span data-ttu-id="a6973-132">На стороне службы ответственность за преобразование контекста, предоставленного клиентом для входящих сообщений, в свойство сообщения <xref:System.ServiceModel.Channels.ContextMessageProperty> возлагается на экземпляр канала.</span><span class="sxs-lookup"><span data-stu-id="a6973-132">On the service, an instance of the channel is responsible for converting the context supplied by the client on incoming messages to the <xref:System.ServiceModel.Channels.ContextMessageProperty>.</span></span> <span data-ttu-id="a6973-133">Впоследствии доступ к свойству сообщения может осуществляться на уровне приложения или с использованием других каналов далее в стеке вызова.</span><span class="sxs-lookup"><span data-stu-id="a6973-133">The message property can then be accessed by the application layer or other channels further up in the call stack.</span></span> <span data-ttu-id="a6973-134">Каналы служб также позволяют указывать новое значение контекста на уровне приложения, которое затем будет распространяться обратно клиенту, путем присоединения свойства <xref:System.ServiceModel.Channels.ContextMessageProperty> к ответному сообщению.</span><span class="sxs-lookup"><span data-stu-id="a6973-134">The service channels also allow the application layer to specify a new context value to be propagated back to the client by attaching a <xref:System.ServiceModel.Channels.ContextMessageProperty> to the response message.</span></span> <span data-ttu-id="a6973-135">Это свойство преобразуется в заголовок SOAP или файл cookie HTTP, который содержит контекст, зависящий от конфигурации привязки.</span><span class="sxs-lookup"><span data-stu-id="a6973-135">This property is converted to the SOAP header or HTTP cookie that contains the context, which depends on the configuration of the binding.</span></span> <span data-ttu-id="a6973-136">Прослушиватель канала служб поддерживает шаблоны обмена сообщениями <xref:System.ServiceModel.Channels.IReplyChannel>, <xref:System.ServiceModel.Channels.IReplySessionChannel> и <xref:System.ServiceModel.Channels.IReplySessionChannel>.</span><span class="sxs-lookup"><span data-stu-id="a6973-136">The service channel listener supports <xref:System.ServiceModel.Channels.IReplyChannel>, <xref:System.ServiceModel.Channels.IReplySessionChannel>, and <xref:System.ServiceModel.Channels.IReplySessionChannel> message exchange patterns.</span></span>  
  
 <span data-ttu-id="a6973-137">Протокол обмена контекстом вводит новый заголовок SOAP `wsc:Context` для представления сведений контекста, если для распространения контекста не используются файлы cookie HTTP.</span><span class="sxs-lookup"><span data-stu-id="a6973-137">The context exchange protocol introduces a new `wsc:Context` SOAP header to represent the context information when HTTP cookies are not used to propagate the context.</span></span> <span data-ttu-id="a6973-138">Схема заголовка контекста допускает включение любого числа дочерних элементов, каждый из которых имеет строковый ключ и строковое содержимое.</span><span class="sxs-lookup"><span data-stu-id="a6973-138">The context header schema allows for any number of child elements, each with a string key and string content.</span></span> <span data-ttu-id="a6973-139">Ниже приведен пример заголовка контекста.</span><span class="sxs-lookup"><span data-stu-id="a6973-139">The following is an example of a context header.</span></span>  
  
 `<Context xmlns="http://schemas.microsoft.com/ws/2006/05/context">`  
  
 `<property name="myContext">context-2</property>`  
  
 `</Context>`  
  
 <span data-ttu-id="a6973-140">При работе в режиме `HttpCookie` файлы cookie задаются с использованием заголовка `SetCookie`.</span><span class="sxs-lookup"><span data-stu-id="a6973-140">When in `HttpCookie` mode, cookies are set using the `SetCookie` header.</span></span> <span data-ttu-id="a6973-141">Имя файла cookie - `WscContext`.</span><span class="sxs-lookup"><span data-stu-id="a6973-141">The cookie name is `WscContext`.</span></span> <span data-ttu-id="a6973-142">Значением файла cookie является кодировка Base64 заголовка `wsc:Context`.</span><span class="sxs-lookup"><span data-stu-id="a6973-142">The value of the cookie is the Base64 encoding of the `wsc:Context` header.</span></span> <span data-ttu-id="a6973-143">Это значение заключено в кавычки.</span><span class="sxs-lookup"><span data-stu-id="a6973-143">This value is enclosed in quotes.</span></span>  
  
 <span data-ttu-id="a6973-144">Значение контекста должно быть защищено от изменения во время передачи по тем же причинам, по которым защищаются заголовки WS-Addressing: этот заголовок используется, чтобы определить, куда передавать запрос в службе.</span><span class="sxs-lookup"><span data-stu-id="a6973-144">The value of the context must be protected from modification while in transit for the same reason WS-Addressing headers are protected – the header is used to determine where to dispatch the request to on the service.</span></span> <span data-ttu-id="a6973-145">Поэтому требуется, чтобы заголовок `wsc:Context` имел цифровую подпись или был зашифрован на уровне SOAP или на транспортном уровне, если привязка обеспечивает возможность защиты сообщений.</span><span class="sxs-lookup"><span data-stu-id="a6973-145">The `wsc:Context` header is therefore required to be digitally signed or signed and encrypted at either the SOAP or transport level when the binding offers message protection capability.</span></span> <span data-ttu-id="a6973-146">Если для распространения контекста используются файлы cookie HTTP, они должны быть защищены с помощью системы безопасности транспорта.</span><span class="sxs-lookup"><span data-stu-id="a6973-146">When HTTP cookies are used to propagate context, they should be protected using transport security.</span></span>  
  
 <span data-ttu-id="a6973-147">Конечные точки службы, которым требуется поддержка протокола обмена контекстом, могут явно объявить об этом в опубликованной политике.</span><span class="sxs-lookup"><span data-stu-id="a6973-147">Service endpoints that require support for the context exchange protocol can make it explicit in the published policy.</span></span> <span data-ttu-id="a6973-148">Были введены два новых утверждения политики, предъявляющие требование к клиенту, чтобы он поддерживал протокол обмена контекстом на уровне SOAP или была включена поддержка файлов cookie HTTP.</span><span class="sxs-lookup"><span data-stu-id="a6973-148">Two new policy assertions have been introduced to represent the requirement for the client to support the context exchange protocol at the SOAP level or to enable HTTP cookie support.</span></span> <span data-ttu-id="a6973-149">Создание этих утверждений в политике службы управляется значением свойства <xref:System.ServiceModel.Channels.ContextBindingElement.ContextExchangeMechanism%2A>, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="a6973-149">Generation of these assertions into the policy on the service is controlled by the value of the <xref:System.ServiceModel.Channels.ContextBindingElement.ContextExchangeMechanism%2A> property as follows:</span></span>  
  
- <span data-ttu-id="a6973-150">Для <xref:System.ServiceModel.Channels.ContextExchangeMechanism.ContextSoapHeader> создается следующее утверждение</span><span class="sxs-lookup"><span data-stu-id="a6973-150">For <xref:System.ServiceModel.Channels.ContextExchangeMechanism.ContextSoapHeader>, the following assertion is generated:</span></span>  
  
    ```xml  
    <IncludeContext
    xmlns="http://schemas.microsoft.com/ws/2006/05/context"  
    protectionLevel="Sign" />  
    ```  
  
- <span data-ttu-id="a6973-151">Для <xref:System.ServiceModel.Channels.ContextExchangeMechanism.HttpCookie> создается следующее утверждение</span><span class="sxs-lookup"><span data-stu-id="a6973-151">For <xref:System.ServiceModel.Channels.ContextExchangeMechanism.HttpCookie>, the following assertion is generated:</span></span>  
  
    ```xml  
    <HttpUseCookie xmlns="http://schemas.xmlsoap.org/soap/http"/>  
    ```  
  
## <a name="see-also"></a><span data-ttu-id="a6973-152">См. также</span><span class="sxs-lookup"><span data-stu-id="a6973-152">See also</span></span>

- [<span data-ttu-id="a6973-153">Руководство по взаимодействию по протоколам веб-служб</span><span class="sxs-lookup"><span data-stu-id="a6973-153">Web Services Protocols Interoperability Guide</span></span>](web-services-protocols-interoperability-guide.md)
