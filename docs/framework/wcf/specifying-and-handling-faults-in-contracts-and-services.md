---
description: 'Дополнительные сведения: указание и обработка ошибок в контрактах и службах'
title: Задание и обработка сбоев в контрактах и службах
ms.date: 03/30/2017
helpviewer_keywords:
- handling faults [WCF]
ms.assetid: a9696563-d404-4905-942d-1e0834c26dea
ms.openlocfilehash: 32a1c795d2be964ff5da259b70a5695ddedfadb2
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99676395"
---
# <a name="specifying-and-handling-faults-in-contracts-and-services"></a><span data-ttu-id="3dd51-103">Задание и обработка сбоев в контрактах и службах</span><span class="sxs-lookup"><span data-stu-id="3dd51-103">Specifying and Handling Faults in Contracts and Services</span></span>

<span data-ttu-id="3dd51-104">Приложения Windows Communication Foundation (WCF) обрабатывают ошибки, выполнив сопоставление объектов управляемого исключения с объектами сбоя SOAP и объектами ошибок SOAP для управляемых объектов исключений.</span><span class="sxs-lookup"><span data-stu-id="3dd51-104">Windows Communication Foundation (WCF) applications handle error situations by mapping managed exception objects to SOAP fault objects and SOAP fault objects to managed exception objects.</span></span> <span data-ttu-id="3dd51-105">В подразделах этого раздела описывается, как разрабатывать контракты, чтобы представлять ошибки в виде пользовательских ошибок SOAP, как возвращать эти ошибки в реализации службы, и как клиенты могут перехватывать такие ошибки.</span><span class="sxs-lookup"><span data-stu-id="3dd51-105">The topics in this section discuss how to design contracts to expose error conditions as custom SOAP faults, how to return such faults as part of service implementation, and how clients catch such faults.</span></span>

## <a name="error-handling-overview"></a><span data-ttu-id="3dd51-106">Общие сведения об обработке ошибок</span><span class="sxs-lookup"><span data-stu-id="3dd51-106">Error Handling Overview</span></span>

<span data-ttu-id="3dd51-107">Во всех управляемых приложениях обработка ошибок представлена объектами <xref:System.Exception>.</span><span class="sxs-lookup"><span data-stu-id="3dd51-107">In all managed applications, processing errors are represented by <xref:System.Exception> objects.</span></span> <span data-ttu-id="3dd51-108">В приложениях на основе SOAP, таких как приложения WCF, методы служб обмениваются сведениями об ошибках обработки с помощью сообщений о сбоях SOAP.</span><span class="sxs-lookup"><span data-stu-id="3dd51-108">In SOAP-based applications such as WCF applications, service methods communicate processing error information using SOAP fault messages.</span></span> <span data-ttu-id="3dd51-109">Сообщения об ошибках SOAP являются типами сообщения, которые включаются в метаданные, связанные с работой службы, и таким образом создают контракт ошибок, который клиенты могут использовать для повышения надежности и интерактивности своей работы.</span><span class="sxs-lookup"><span data-stu-id="3dd51-109">SOAP faults are message types that are included in the metadata for a service operation and therefore create a fault contract that clients can use to make their operation more robust or interactive.</span></span> <span data-ttu-id="3dd51-110">Кроме того, поскольку ошибки SOAP выражаются для клиентов в XML-форме, это система типов с высокой степенью доступности, которую клиенты могут использовать на любой платформе SOAP, увеличивая уровень доступа к приложению WCF.</span><span class="sxs-lookup"><span data-stu-id="3dd51-110">In addition, because SOAP faults are expressed to clients in XML form, it is a highly interoperable type system that clients on any SOAP platform can use, increasing the reach of your WCF application.</span></span>

<span data-ttu-id="3dd51-111">Поскольку приложения WCF выполняются в обоих типах систем ошибок, все управляемые сведения об исключениях, отправляемые клиенту, должны быть преобразованы из исключений в ошибки SOAP в службе, отправлены и преобразованы из ошибок SOAP в исключения ошибок в клиентах WCF.</span><span class="sxs-lookup"><span data-stu-id="3dd51-111">Because WCF applications run under both types of error systems, any managed exception information that is sent to the client must be converted from exceptions into SOAP faults on the service, sent, and converted from SOAP faults to fault exceptions in WCF clients.</span></span> <span data-ttu-id="3dd51-112">В случае дуплексных клиентов клиентские контракты могут отправлять ошибки SOAP обратно в службу.</span><span class="sxs-lookup"><span data-stu-id="3dd51-112">In the case of duplex clients, client contracts can also send SOAP faults back to a service.</span></span> <span data-ttu-id="3dd51-113">В обоих случаях можно использовать поведения исключений для службы по умолчанию или можно явно управлять тем, будут ли исключения сопоставляться с сообщениями об ошибке и как будет выполняться это сопоставление.</span><span class="sxs-lookup"><span data-stu-id="3dd51-113">In either case, you can use the default service exception behaviors, or you can explicitly control whether—and how—exceptions are mapped to fault messages.</span></span>

<span data-ttu-id="3dd51-114">Можно отправлять два типа ошибок SOAP: *объявленные* и *необъявленные*.</span><span class="sxs-lookup"><span data-stu-id="3dd51-114">Two types of SOAP faults can be sent: *declared* and *undeclared*.</span></span> <span data-ttu-id="3dd51-115">Объявленные ошибки SOAP представляют ошибки, в которых в операции имеется атрибут <xref:System.ServiceModel.FaultContractAttribute?displayProperty=nameWithType>, указывающий пользовательский тип ошибки SOAP.</span><span class="sxs-lookup"><span data-stu-id="3dd51-115">Declared SOAP faults are those in which an operation has a <xref:System.ServiceModel.FaultContractAttribute?displayProperty=nameWithType> attribute that specifies a custom SOAP fault type.</span></span> <span data-ttu-id="3dd51-116">Не *объявлено* Ошибки SOAP не указаны в контракте для операции.</span><span class="sxs-lookup"><span data-stu-id="3dd51-116">*Undeclared* SOAP faults are not specified in the contract for an operation.</span></span>

<span data-ttu-id="3dd51-117">Настоятельно рекомендуется, чтобы операции службы объявляли свои ошибки с помощью атрибута <xref:System.ServiceModel.FaultContractAttribute>. Это позволит формально указать все ошибки SOAP, которые клиент может получить во время обычной операции.</span><span class="sxs-lookup"><span data-stu-id="3dd51-117">It is strongly recommended that service operations declare their faults by using the <xref:System.ServiceModel.FaultContractAttribute> attribute to formally specify all SOAP faults that a client can expect to receive in the normal course of an operation.</span></span> <span data-ttu-id="3dd51-118">Кроме того, чтобы свести к минимум раскрытие информации, рекомендуется возвращать в ошибке SOAP только те сведения, которые необходимо знать клиенту.</span><span class="sxs-lookup"><span data-stu-id="3dd51-118">It is also recommended that you return in a SOAP fault only the information that a client must know to minimize information disclosure.</span></span>

<span data-ttu-id="3dd51-119">Обычно службы (и дуплексные клиенты) выполняют следующие шаги, чтобы интегрировать обработку в свои приложения.</span><span class="sxs-lookup"><span data-stu-id="3dd51-119">Typically, services (and duplex clients) take the following steps to successfully integrate error handling into their applications:</span></span>

- <span data-ttu-id="3dd51-120">Сопоставление исключений и пользовательскими ошибками SOAP.</span><span class="sxs-lookup"><span data-stu-id="3dd51-120">Map exception conditions to custom SOAP faults.</span></span>

- <span data-ttu-id="3dd51-121">Клиенты и службы отправляют и получают ошибки SOAP в виде исключений.</span><span class="sxs-lookup"><span data-stu-id="3dd51-121">Clients and services send and receive SOAP faults as exceptions.</span></span>

<span data-ttu-id="3dd51-122">Кроме того, клиенты и службы WCF могут использовать необъявленные ошибки SOAP для отладки и могут расширять поведение при ошибке по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="3dd51-122">In addition, WCF clients and services can use undeclared soap faults for debugging purposes and can extend the default error behavior.</span></span> <span data-ttu-id="3dd51-123">В следующих разделах рассматриваются эти задачи и принципы.</span><span class="sxs-lookup"><span data-stu-id="3dd51-123">The following sections discuss these tasks and concepts.</span></span>

## <a name="map-exceptions-to-soap-faults"></a><span data-ttu-id="3dd51-124">Сопоставление исключений с ошибками SOAP</span><span class="sxs-lookup"><span data-stu-id="3dd51-124">Map Exceptions to SOAP Faults</span></span>

<span data-ttu-id="3dd51-125">Первым шагом в создании операции, обрабатывающей ошибки, является определение условий, при которых клиентское приложение должно быть проинформировано об ошибках.</span><span class="sxs-lookup"><span data-stu-id="3dd51-125">The first step in creating an operation that handles error conditions is to decide under what conditions a client application should be informed about errors.</span></span> <span data-ttu-id="3dd51-126">Для некоторых операций имеются ошибки, относящиеся к их функциональности.</span><span class="sxs-lookup"><span data-stu-id="3dd51-126">Some operations have error conditions specific to their functionality.</span></span> <span data-ttu-id="3dd51-127">Например, операция `PurchaseOrder` может возвратить конкретную информацию клиенту, которому больше не разрешено размещать заказ на покупку.</span><span class="sxs-lookup"><span data-stu-id="3dd51-127">For example, a `PurchaseOrder` operation might return specific information to customers who are no longer permitted to initiate a purchase order.</span></span> <span data-ttu-id="3dd51-128">В других случаях, например в службе `Calculator`, более общая ошибка SOAP `MathFault` может описать все условия ошибки во всей службе.</span><span class="sxs-lookup"><span data-stu-id="3dd51-128">In other cases, such as a `Calculator` service, a more general `MathFault` SOAP fault may be able to describe all error conditions across an entire service.</span></span> <span data-ttu-id="3dd51-129">После определения ошибок клиентов может быть создана пользовательская ошибка SOAP. Кроме того, можно отметить, что операция возвращает данную эту ошибку при возникновении соответствующей ошибки.</span><span class="sxs-lookup"><span data-stu-id="3dd51-129">Once the error conditions of clients of your service are identified, a custom SOAP fault can be constructed and the operation can be marked as returning that SOAP fault when its corresponding error condition arises.</span></span>

<span data-ttu-id="3dd51-130">Дополнительные сведения об этом этапе разработки службы или клиента см. в разделе [Определение и указание ошибок](defining-and-specifying-faults.md).</span><span class="sxs-lookup"><span data-stu-id="3dd51-130">For more information about this step of developing your service or client, see [Defining and Specifying Faults](defining-and-specifying-faults.md).</span></span>

## <a name="clients-and-services-handle-soap-faults-as-exceptions"></a><span data-ttu-id="3dd51-131">Клиенты и службы обрабатывают ошибки SOAP в виде исключений</span><span class="sxs-lookup"><span data-stu-id="3dd51-131">Clients and Services Handle SOAP Faults as Exceptions</span></span>

<span data-ttu-id="3dd51-132">Определение условий ошибок операций, определение пользовательских ошибок SOAP и пометка этих операций как возвращающие эти ошибки являются первыми этапами успешной обработки ошибок в приложениях WCF.</span><span class="sxs-lookup"><span data-stu-id="3dd51-132">Identifying operation error conditions, defining custom SOAP faults, and marking those operations as returning those faults are the first steps in successful error handling in WCF applications.</span></span> <span data-ttu-id="3dd51-133">Следующий шаг заключается в надлежащей реализации отправки и получения этих ошибок.</span><span class="sxs-lookup"><span data-stu-id="3dd51-133">The next step is to properly implement the sending and receiving of these faults.</span></span> <span data-ttu-id="3dd51-134">Обычно службы отправляют сообщения об ошибках, чтобы информировать клиентские приложения, но дуплексные клиенты также могут отправлять службам сообщения об ошибках протокола SOAP.</span><span class="sxs-lookup"><span data-stu-id="3dd51-134">Typically services send faults to inform client applications about error conditions, but duplex clients can also send SOAP faults to services.</span></span>

<span data-ttu-id="3dd51-135">Дополнительные сведения см. в разделе [Отправка и получение ошибок](sending-and-receiving-faults.md).</span><span class="sxs-lookup"><span data-stu-id="3dd51-135">For more information, see [Sending and Receiving Faults](sending-and-receiving-faults.md).</span></span>

## <a name="undeclared-soap-faults-and-debugging"></a><span data-ttu-id="3dd51-136">Необъявленные ошибки протокола SOAP и отладка</span><span class="sxs-lookup"><span data-stu-id="3dd51-136">Undeclared SOAP Faults and Debugging</span></span>

<span data-ttu-id="3dd51-137">Объявленные ошибки протокола SOAP очень полезны для построения надежных распределенных приложений с возможностью взаимодействия.</span><span class="sxs-lookup"><span data-stu-id="3dd51-137">Declared SOAP faults are extremely useful for building robust, interoperable, distributed applications.</span></span> <span data-ttu-id="3dd51-138">Однако в некоторых случаях для службы (или дуплексного клиента) полезно отправлять необъявленную ошибку SOAP, которая не упоминается для данной операции в языке WSDL.</span><span class="sxs-lookup"><span data-stu-id="3dd51-138">However, in some cases it is useful for a service (or duplex client) to send an undeclared SOAP fault, one that is not mentioned in the Web Services Description Language (WSDL) for that operation.</span></span> <span data-ttu-id="3dd51-139">Например, при разработке службы могут произойти непредвиденные ситуации, в которых для отладки понадобится отправить информацию обратно клиенту.</span><span class="sxs-lookup"><span data-stu-id="3dd51-139">For example, when developing a service, unexpected situations can occur in which it is useful for debugging purposes to send information back to the client.</span></span> <span data-ttu-id="3dd51-140">Кроме того, можно задать <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> свойство или свойство, чтобы <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> `true` позволить клиентам WCF получать сведения о внутренних исключениях операций службы.</span><span class="sxs-lookup"><span data-stu-id="3dd51-140">In addition, you can set the <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> property or the <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> property to `true` to permit WCF clients to obtain information about internal service operation exceptions.</span></span> <span data-ttu-id="3dd51-141">Как отправка отдельных ошибок, так и Настройка свойств поведения отладки описаны в статье [Отправка и получение ошибок](sending-and-receiving-faults.md).</span><span class="sxs-lookup"><span data-stu-id="3dd51-141">Both sending individual faults and setting the debugging behavior properties are described in [Sending and Receiving Faults](sending-and-receiving-faults.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="3dd51-142">Поскольку управляемые исключения могут предоставлять внутренние сведения о приложении, <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> устанавливать <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> или `true` разрешать клиентам WCF получать сведения о внутренних исключениях операций службы, включая персональные и другие конфиденциальные сведения.</span><span class="sxs-lookup"><span data-stu-id="3dd51-142">Because managed exceptions can expose internal application information, setting <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> to `true` can permit WCF clients to obtain information about internal service operation exceptions, including personally identifiable or other sensitive information.</span></span>
>
> <span data-ttu-id="3dd51-143">Присваивать свойству <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> или <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> значение `true` рекомендуется только в качестве временного способа отладки приложения службы.</span><span class="sxs-lookup"><span data-stu-id="3dd51-143">Therefore, setting <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> to `true` is recommended only as a way to temporarily debug a service application.</span></span> <span data-ttu-id="3dd51-144">Кроме того, WSDL для метода, который возвращает такие необработанные управляемые исключения, не содержит контракт для исключения <xref:System.ServiceModel.FaultException%601> типа <xref:System.ServiceModel.ExceptionDetail>.</span><span class="sxs-lookup"><span data-stu-id="3dd51-144">In addition, the WSDL for a method that returns unhandled managed exceptions in this way does not contain the contract for the <xref:System.ServiceModel.FaultException%601> of type <xref:System.ServiceModel.ExceptionDetail>.</span></span> <span data-ttu-id="3dd51-145">Клиенты должны рассчитывать на возможность неизвестной ошибки SOAP (возвращается клиентам WCF как <xref:System.ServiceModel.FaultException?displayProperty=nameWithType> объекты) для правильного получения отладочной информации.</span><span class="sxs-lookup"><span data-stu-id="3dd51-145">Clients must expect the possibility of an unknown SOAP fault (returned to WCF clients as <xref:System.ServiceModel.FaultException?displayProperty=nameWithType> objects) to obtain the debugging information properly.</span></span>

## <a name="customizing-error-handling-with-ierrorhandler"></a><span data-ttu-id="3dd51-146">Настройка обработки ошибок с помощью интерфейса IErrorHandler</span><span class="sxs-lookup"><span data-stu-id="3dd51-146">Customizing Error Handling with IErrorHandler</span></span>

<span data-ttu-id="3dd51-147">Если имеются особые требования для настройки ответного сообщения клиента при возникновении исключения на уровне приложения или выполнения специальной обработки после возвращения ответного сообщения, реализуйте интерфейс <xref:System.ServiceModel.Dispatcher.IErrorHandler?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="3dd51-147">If you have special requirements to either customize the response message to the client when an application-level exception happens or perform some custom processing after the response message is returned, implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler?displayProperty=nameWithType> interface.</span></span>

## <a name="fault-serialization-issues"></a><span data-ttu-id="3dd51-148">Проблемы сериализации сбоя</span><span class="sxs-lookup"><span data-stu-id="3dd51-148">Fault Serialization Issues</span></span>

<span data-ttu-id="3dd51-149">При десериализации контракта сбоя службы WCF прежде всего пытаются сопоставить имя контракта сбоя в сообщении протокола SOAP с типом контракта сбоя.</span><span class="sxs-lookup"><span data-stu-id="3dd51-149">When deserializing a fault contract, WCF first attempts to match the fault contract name in the SOAP message with the fault contract type.</span></span> <span data-ttu-id="3dd51-150">Если точное соответствие не обнаружено, просматривается список доступных контрактов сбоя в алфавитном порядке для нахождения совместимого типа.</span><span class="sxs-lookup"><span data-stu-id="3dd51-150">If it cannot find an exact match it will then search the list of available fault contracts in alphabetical order for a compatible type.</span></span> <span data-ttu-id="3dd51-151">Если совместимые типы имеют два контракта сбоя (например, один является подклассом другого), при десериализации сбоя может быть использован неправильный тип.</span><span class="sxs-lookup"><span data-stu-id="3dd51-151">If two fault contracts are compatible types (one is a subclass of another, for example) the wrong type may be used to de-serialize the fault.</span></span> <span data-ttu-id="3dd51-152">Это происходит только в случае, если в контракте сбоя не указано имя, пространство имен и действие.</span><span class="sxs-lookup"><span data-stu-id="3dd51-152">This only occurs if the fault contract does not specify a name, namespace, and action.</span></span> <span data-ttu-id="3dd51-153">Во избежание данной проблемы всегда полностью определяйте контракты сбоя, указывая атрибуты имени, пространства имен и действия.</span><span class="sxs-lookup"><span data-stu-id="3dd51-153">To prevent this issue from occurring, always fully qualify fault contracts by specifying the name, namespace, and action attributes.</span></span> <span data-ttu-id="3dd51-154">Кроме того, если определено несколько родственных контрактов сбоя, производных от общего базового класса, обязательно помечайте все новые элементы атрибутом `[DataMember(IsRequired=true)]`.</span><span class="sxs-lookup"><span data-stu-id="3dd51-154">Additionally if you have defined a number of related fault contracts derived from a shared base class, make sure to mark any new members with `[DataMember(IsRequired=true)]`.</span></span> <span data-ttu-id="3dd51-155">Дополнительные сведения об использовании атрибута `IsRequired` см. в разделе <xref:System.Runtime.Serialization.DataMemberAttribute>.</span><span class="sxs-lookup"><span data-stu-id="3dd51-155">For more information on this `IsRequired` attribute see, <xref:System.Runtime.Serialization.DataMemberAttribute>.</span></span> <span data-ttu-id="3dd51-156">В этом случае базовый класс не будет считаться совместимым типом, а сбой будет десериализован в правильный производный тип.</span><span class="sxs-lookup"><span data-stu-id="3dd51-156">This will prevent a base class from being a compatible type and force the fault to be deserialized into the correct derived type.</span></span>

## <a name="see-also"></a><span data-ttu-id="3dd51-157">См. также</span><span class="sxs-lookup"><span data-stu-id="3dd51-157">See also</span></span>

- <xref:System.ServiceModel.FaultException>
- <xref:System.ServiceModel.FaultContractAttribute>
- <xref:System.ServiceModel.FaultException>
- <xref:System.Xml.Serialization.XmlSerializer>
- <xref:System.ServiceModel.XmlSerializerFormatAttribute>
- <xref:System.ServiceModel.FaultContractAttribute>
- <xref:System.ServiceModel.CommunicationException>
- <xref:System.ServiceModel.FaultContractAttribute.Action%2A>
- <xref:System.ServiceModel.FaultException.Code%2A>
- <xref:System.ServiceModel.FaultException.Reason%2A>
- <xref:System.ServiceModel.FaultCode.SubCode%2A>
- <xref:System.ServiceModel.OperationContractAttribute.IsOneWay%2A>
- [<span data-ttu-id="3dd51-158">Определение и задание сбоев</span><span class="sxs-lookup"><span data-stu-id="3dd51-158">Defining and Specifying Faults</span></span>](defining-and-specifying-faults.md)
