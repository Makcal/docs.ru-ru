---
description: 'Дополнительные сведения: моделирование поведения отмены в рабочих процессах'
title: Моделирование поведения отмены в рабочих процессах
ms.date: 03/30/2017
ms.assetid: d48f6cf3-cdde-4dd3-8265-a665acf32a03
ms.openlocfilehash: 971e044336eb0aed41e773e03f6e0fb70d959094
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99792652"
---
# <a name="modeling-cancellation-behavior-in-workflows"></a><span data-ttu-id="7e6b8-103">Моделирование поведения отмены в рабочих процессах</span><span class="sxs-lookup"><span data-stu-id="7e6b8-103">Modeling Cancellation Behavior in Workflows</span></span>

<span data-ttu-id="7e6b8-104">Действия можно отменять внутри рабочего процесса, например действием <xref:System.Activities.Statements.Parallel>, отменяющим неполные ветви, если вычисление его условия <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> возвращает значение `true`, или извне рабочего процесса, если узел вызывает метод <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-104">Activities can be canceled inside a workflow, for example by a <xref:System.Activities.Statements.Parallel> activity canceling incomplete branches when its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true`, or from outside the workflow, if the host calls <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="7e6b8-105">Чтобы предусмотреть выполнение отмены, разработчики рабочего процесса могут использовать действие <xref:System.Activities.Statements.CancellationScope>, действие <xref:System.Activities.Statements.CompensableActivity> или создать пользовательские действия, которые предоставляют логику отмены.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-105">To provide cancellation handling, workflow authors can use the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> activity, or create custom activities that provide cancellation logic.</span></span> <span data-ttu-id="7e6b8-106">В этом разделе приведены общие сведения об отмене в рабочих процессах.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-106">This topic provides an overview of cancellation in workflows.</span></span>  
  
## <a name="cancellation-compensation-and-transactions"></a><span data-ttu-id="7e6b8-107">Отмена, компенсация и транзакции</span><span class="sxs-lookup"><span data-stu-id="7e6b8-107">Cancellation, Compensation, and Transactions</span></span>  

 <span data-ttu-id="7e6b8-108">Транзакции предоставляют приложению способность прерывать (производить откат) все изменения, выполняемые в пределах транзакции, если в ходе выполнения любой части транзакции возникают какие-либо ошибки.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-108">Transactions give your application the ability to abort (roll back) all changes executed within the transaction if any errors occur during any part of the transaction process.</span></span> <span data-ttu-id="7e6b8-109">Однако не вся работа, которая может потребовать отмены, подходит для транзакций. К примерам такой работы относятся продолжительные задания или операции, в которых не задействуются ресурсы транзакций.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-109">However, not all work that may need to be canceled or undone is appropriate for transactions, such as long-running work or work that does not involve transactional resources.</span></span> <span data-ttu-id="7e6b8-110">Компенсация предоставляет модель для отмены выполненной ранее работы, которая не входит в состав транзакции, если в последующем эти действия вызвали ошибку в рабочем процессе.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-110">Compensation provides a model for undoing previously completed non-transactional work if there is a subsequent failure in the workflow.</span></span> <span data-ttu-id="7e6b8-111">Отмена предоставляет разработчикам рабочих процессов и действий модель для обработки незавершенной работы, которая не входит в состав транзакции.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-111">Cancellation provides a model for workflow and activity authors to handle non-transactional work that was not completed.</span></span> <span data-ttu-id="7e6b8-112">Если какое-либо действие отменяется до завершения его выполнения, то будет вызвана логика его отмены при ее наличии.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-112">If an activity has not completed its execution and it is canceled, its cancellation logic will be invoked if it is available.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="7e6b8-113">Дополнительные сведения о транзакциях и компенсации см. в разделе [транзакции](workflow-transactions.md) и [компенсация](compensation.md).</span><span class="sxs-lookup"><span data-stu-id="7e6b8-113">For more information about transactions and compensation, see [Transactions](workflow-transactions.md) and [Compensation](compensation.md).</span></span>  
  
## <a name="using-cancellationscope"></a><span data-ttu-id="7e6b8-114">Использование CancellationScope</span><span class="sxs-lookup"><span data-stu-id="7e6b8-114">Using CancellationScope</span></span>  

 <span data-ttu-id="7e6b8-115">Действие <xref:System.Activities.Statements.CancellationScope> имеет два раздела, которые могут содержать дочерние действия: <xref:System.Activities.Statements.CancellationScope.Body%2A> и <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-115">The <xref:System.Activities.Statements.CancellationScope> activity has two sections that can contain child activities: <xref:System.Activities.Statements.CancellationScope.Body%2A> and <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span></span> <span data-ttu-id="7e6b8-116">В раздел <xref:System.Activities.Statements.CancellationScope.Body%2A> помещаются действия, составляющие логику действия, а в раздел <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> - действия, которые обеспечивают логику отмены действия.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-116">The <xref:System.Activities.Statements.CancellationScope.Body%2A> is where the activities that make up the logic of the activity are placed, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> is where the activities that provide cancellation logic for the activity are placed.</span></span> <span data-ttu-id="7e6b8-117">Отменено может быть только незавершенное действие.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-117">An activity can be canceled only if it has not completed.</span></span> <span data-ttu-id="7e6b8-118">Если речь идет о действии <xref:System.Activities.Statements.CancellationScope>, то под завершением подразумевается завершение действий в <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-118">In the case of the <xref:System.Activities.Statements.CancellationScope> activity, completion refers to the completion of the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span></span> <span data-ttu-id="7e6b8-119">Если запрос отмены запланирован и действия в <xref:System.Activities.Statements.CancellationScope.Body%2A> не завершились, то область <xref:System.Activities.Statements.CancellationScope> будет отмечена как <xref:System.Activities.ActivityInstanceState.Canceled>, после чего будут выполнены действия <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-119">If a cancellation request is scheduled and the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A> have not completed, then the <xref:System.Activities.Statements.CancellationScope> will be marked as <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> activities will be executed.</span></span>  
  
### <a name="canceling-a-workflow-from-the-host"></a><span data-ttu-id="7e6b8-120">Отмена рабочего процесса с узла</span><span class="sxs-lookup"><span data-stu-id="7e6b8-120">Canceling a Workflow from the Host</span></span>  

 <span data-ttu-id="7e6b8-121">Узел может отменить рабочий процесс путем вызова метода <xref:System.Activities.WorkflowApplication.Cancel%2A> экземпляра <xref:System.Activities.WorkflowApplication>, в котором размещен рабочий процесс.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-121">A host can cancel a workflow by calling the <xref:System.Activities.WorkflowApplication.Cancel%2A> method of the <xref:System.Activities.WorkflowApplication> instance that is hosting the workflow.</span></span> <span data-ttu-id="7e6b8-122">В следующем примере создается рабочий процесс, который имеет <xref:System.Activities.Statements.CancellationScope>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-122">In the following example a workflow is created that has a <xref:System.Activities.Statements.CancellationScope>.</span></span> <span data-ttu-id="7e6b8-123">Происходит вызов рабочего процесса, а затем узел вызывает метод <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-123">The workflow is invoked, and then the host makes a call to <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="7e6b8-124">Основное выполнение рабочего процесса останавливается, вызывается обработчик <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> области <xref:System.Activities.Statements.CancellationScope>, после чего рабочий процесс завершается с указанием состояния <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-124">The main execution of the workflow is stopped, the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the <xref:System.Activities.Statements.CancellationScope> is invoked, and then the workflow completes with a status of <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#35](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#35)]  
  
 <span data-ttu-id="7e6b8-125">При вызове этого рабочего процесса на консоль выводятся следующие данные.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-125">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="7e6b8-126">**Starting the workflow.**</span><span class="sxs-lookup"><span data-stu-id="7e6b8-126">**Starting the workflow.**</span></span>  
<span data-ttu-id="7e6b8-127">**Вызвано CancellationHandler.** 
 **B30ebb30-df46-4d90-A211-e31c38d8db3c рабочего процесса отменен.**</span><span class="sxs-lookup"><span data-stu-id="7e6b8-127">**CancellationHandler invoked.**
**Workflow b30ebb30-df46-4d90-a211-e31c38d8db3c Canceled.**</span></span>
> [!NOTE]
> <span data-ttu-id="7e6b8-128">Если отменяется действие <xref:System.Activities.Statements.CancellationScope> и вызывается обработчик <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, то на разработчика рабочего процесса возлагается ответственность за определение того, какая часть отмененного действия была выполнена до его отмены в целях предоставления соответствующей логики отмены.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-128">When a <xref:System.Activities.Statements.CancellationScope> activity is canceled and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> invoked, it is the responsibility of the workflow author to determine the progress that the canceled activity made before it was canceled in order to provide the appropriate cancellation logic.</span></span> <span data-ttu-id="7e6b8-129">Обработчик <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> не предоставляет никаких сведений о ходе выполнения отмененного действия.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-129">The <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> does not provide any information about the progress of the canceled activity.</span></span>  
  
 <span data-ttu-id="7e6b8-130">Рабочий процесс также может быть отменен с узла, если за корнем рабочего процесса «всплывает» необработанное исключение и обработчик <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> возвращает <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-130">A workflow can also be canceled from the host if an unhandled exception bubbles up past the root of the workflow and the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler returns <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="7e6b8-131">В этом примере запускается рабочий процесс, а затем формируется исключение <xref:System.ApplicationException>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-131">In this example the workflow starts and then throws an <xref:System.ApplicationException>.</span></span> <span data-ttu-id="7e6b8-132">Рабочий процесс не обрабатывает это исключение, поэтому вызывается обработчик <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-132">This exception is unhandled by the workflow and so the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="7e6b8-133">Обработчик выдает среде выполнения команду отмены рабочего процесса, а затем вызывается обработчик <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> выполняемого в настоящее время действия <xref:System.Activities.Statements.CancellationScope>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-133">The handler instructs the runtime to cancel the workflow, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the currently executing <xref:System.Activities.Statements.CancellationScope> activity is invoked.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#36](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#36)]  
  
 <span data-ttu-id="7e6b8-134">При вызове этого рабочего процесса на консоль выводятся следующие данные.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-134">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="7e6b8-135">**Starting the workflow.**</span><span class="sxs-lookup"><span data-stu-id="7e6b8-135">**Starting the workflow.**</span></span>  
<span data-ttu-id="7e6b8-136">**Онунхандледексцептион в рабочем процессе 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9** 
 **Вызвано исключение ApplicationException.** 
 **Вызвано CancellationHandler.** 
 **6Bb2d5d6-f49a-4c6d-a988-478afb86dbe9 рабочего процесса отменен.**</span><span class="sxs-lookup"><span data-stu-id="7e6b8-136">**OnUnhandledException in Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9**
**An ApplicationException was thrown.**
**CancellationHandler invoked.**
**Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 Canceled.**</span></span>

### <a name="canceling-an-activity-from-inside-a-workflow"></a><span data-ttu-id="7e6b8-137">Отмена действия из рабочего процесса</span><span class="sxs-lookup"><span data-stu-id="7e6b8-137">Canceling an Activity from Inside a Workflow</span></span>  

 <span data-ttu-id="7e6b8-138">Действие также может быть отменено его родительским действием.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-138">An activity can also be canceled by its parent.</span></span> <span data-ttu-id="7e6b8-139">Например, если действие <xref:System.Activities.Statements.Parallel> имеет несколько выполняющихся ветвей и его условие <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> принимает значение `true`, то его незавершенные ветви будут отменены.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-139">For example, if a <xref:System.Activities.Statements.Parallel> activity has multiple executing branches and its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true` then its incomplete branches will be canceled.</span></span> <span data-ttu-id="7e6b8-140">В этом примере создается действие <xref:System.Activities.Statements.Parallel>, которое имеет две ветви.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-140">In this example a <xref:System.Activities.Statements.Parallel> activity is created that has two branches.</span></span> <span data-ttu-id="7e6b8-141">Его условию <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> задается значение `true`, поэтому действие <xref:System.Activities.Statements.Parallel> завершается сразу после завершения любой из его ветвей.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-141">Its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> is set to `true` so the <xref:System.Activities.Statements.Parallel> completes as soon as any one of its branches is completed.</span></span> <span data-ttu-id="7e6b8-142">В этом примере завершается ветвь 2, поэтому ветвь 1 отменяется.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-142">In this example branch 2 completes, and so branch 1 is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#37](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#37)]  
  
 <span data-ttu-id="7e6b8-143">При вызове этого рабочего процесса на консоль выводятся следующие данные.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-143">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="7e6b8-144">**Начало ветви 1.**</span><span class="sxs-lookup"><span data-stu-id="7e6b8-144">**Branch 1 starting.**</span></span>  
<span data-ttu-id="7e6b8-145">**Ветвь 2 завершена.** 
 **Ветвь 1 отменена.** 
 **E0685e24-18ef-4a47-acf3-5c638732f3be рабочего процесса завершен.**</span><span class="sxs-lookup"><span data-stu-id="7e6b8-145">**Branch 2 complete.**
**Branch 1 canceled.**
**Workflow e0685e24-18ef-4a47-acf3-5c638732f3be Completed.**</span></span>  <span data-ttu-id="7e6b8-146">Действия также отменяются, если исключение «всплывает» вслед за прохождением корня действия, но обрабатывается на более высоком уровне в рабочем процессе.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-146">Activities are also canceled if an exception bubbles up past the root of the activity but is handled at a higher level in the workflow.</span></span> <span data-ttu-id="7e6b8-147">В этом примере основная логика рабочего процесса состоит из действия <xref:System.Activities.Statements.Sequence>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-147">In this example, the main logic of the workflow consists of a <xref:System.Activities.Statements.Sequence> activity.</span></span> <span data-ttu-id="7e6b8-148">Последовательность <xref:System.Activities.Statements.Sequence> задается как тело <xref:System.Activities.Statements.CancellationScope.Body%2A> действия <xref:System.Activities.Statements.CancellationScope>, которое содержится в действии <xref:System.Activities.Statements.TryCatch>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-148">The <xref:System.Activities.Statements.Sequence> is specified as the <xref:System.Activities.Statements.CancellationScope.Body%2A> of a <xref:System.Activities.Statements.CancellationScope> activity which is contained by a <xref:System.Activities.Statements.TryCatch> activity.</span></span> <span data-ttu-id="7e6b8-149">Из текста последовательности <xref:System.Activities.Statements.Sequence> формируется исключение, обрабатывается родительским действием <xref:System.Activities.Statements.TryCatch>, после чего последовательность <xref:System.Activities.Statements.Sequence> отменяется.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-149">An exception is thrown from the body of the <xref:System.Activities.Statements.Sequence>, is handled by the parent <xref:System.Activities.Statements.TryCatch> activity, and the <xref:System.Activities.Statements.Sequence> is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#39](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#39)]  
  
 <span data-ttu-id="7e6b8-150">При вызове этого рабочего процесса на консоль выводятся следующие данные.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-150">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="7e6b8-151">**Начало последовательности.**</span><span class="sxs-lookup"><span data-stu-id="7e6b8-151">**Sequence starting.**</span></span>  
<span data-ttu-id="7e6b8-152">**Последовательность отменена.** 
 **Перехвачено исключение.** 
 **E3c18939-121e-4c43-af1c-ba1ce977ce55 рабочего процесса завершен.**</span><span class="sxs-lookup"><span data-stu-id="7e6b8-152">**Sequence canceled.**
**Exception caught.**
**Workflow e3c18939-121e-4c43-af1c-ba1ce977ce55 Completed.**</span></span>

### <a name="throwing-exceptions-from-a-cancellationhandler"></a><span data-ttu-id="7e6b8-153">Формирование исключений из CancellationHandler</span><span class="sxs-lookup"><span data-stu-id="7e6b8-153">Throwing Exceptions from a CancellationHandler</span></span>  

 <span data-ttu-id="7e6b8-154">Для рабочего процесса любые исключения, сформированные из обработчика <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> области <xref:System.Activities.Statements.CancellationScope>, являются неустранимыми.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-154">Any exceptions thrown from the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of a <xref:System.Activities.Statements.CancellationScope> are fatal to the workflow.</span></span> <span data-ttu-id="7e6b8-155">Если есть возможность экранирования исключений из <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, то используйте конструкцию <xref:System.Activities.Statements.TryCatch> в обработчике <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> для перехвата и обработки этих исключений.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-155">If there is a possibility of exceptions escaping from a <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, use a <xref:System.Activities.Statements.TryCatch> in the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> to catch and handle these exceptions.</span></span>  
  
### <a name="cancellation-using-compensableactivity"></a><span data-ttu-id="7e6b8-156">Отмена с помощью CompensableActivity</span><span class="sxs-lookup"><span data-stu-id="7e6b8-156">Cancellation using CompensableActivity</span></span>  

 <span data-ttu-id="7e6b8-157">Как и действие <xref:System.Activities.Statements.CancellationScope>, действие <xref:System.Activities.Statements.CompensableActivity> имеет обработчик <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-157">Like the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> has a <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span></span> <span data-ttu-id="7e6b8-158">Если действие <xref:System.Activities.Statements.CompensableActivity> отменяется, то вызываются любые действия из обработчика <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-158">If a <xref:System.Activities.Statements.CompensableActivity> is canceled, any activities in its <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> are invoked.</span></span> <span data-ttu-id="7e6b8-159">Это может применяться для отмены частично завершенной работы, которую можно компенсировать.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-159">This can be useful for undoing partially completed compensable work.</span></span> <span data-ttu-id="7e6b8-160">Сведения об использовании <xref:System.Activities.Statements.CompensableActivity> для компенсации и отмены см. в разделе [компенсация](compensation.md).</span><span class="sxs-lookup"><span data-stu-id="7e6b8-160">For information about how to use <xref:System.Activities.Statements.CompensableActivity> for compensation and cancellation, see [Compensation](compensation.md).</span></span>  
  
## <a name="cancellation-using-custom-activities"></a><span data-ttu-id="7e6b8-161">Отмена с помощью пользовательских действий</span><span class="sxs-lookup"><span data-stu-id="7e6b8-161">Cancellation using Custom Activities</span></span>  

 <span data-ttu-id="7e6b8-162">Разработчики пользовательских действий могут реализовать логику отмены в своих пользовательских действиях несколькими разными способами.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-162">Custom activity authors can implement cancellation logic into their custom activities in several different ways.</span></span> <span data-ttu-id="7e6b8-163">Пользовательские действия, которые являются производными от <xref:System.Activities.Activity>, могут реализовывать логику отмены путем размещения действия <xref:System.Activities.Statements.CancellationScope> или другого пользовательского действия, содержащего логику отмены, в тексте этого действия.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-163">Custom activities that derive from <xref:System.Activities.Activity> can implement cancellation logic by placing a <xref:System.Activities.Statements.CancellationScope> or other custom activity that contains cancellation logic in the body of the activity.</span></span> <span data-ttu-id="7e6b8-164">Действия, производные от <xref:System.Activities.AsyncCodeActivity> и <xref:System.Activities.NativeActivity>, могут переопределить соответствующий метод <xref:System.Activities.NativeActivity.Cancel%2A> и обеспечить логику отмены действий.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-164"><xref:System.Activities.AsyncCodeActivity> and <xref:System.Activities.NativeActivity> derived activities can override their respective <xref:System.Activities.NativeActivity.Cancel%2A> method and provide cancellation logic there.</span></span> <span data-ttu-id="7e6b8-165">Действия, производные от <xref:System.Activities.CodeActivity>, не обеспечивают отмену, поскольку вся их работа осуществляется в единственном всплеске выполнения, когда среда выполнения вызывает метод <xref:System.Activities.CodeActivity.Execute%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-165"><xref:System.Activities.CodeActivity> derived activities do not provide any provision for cancellation because all their work is performed in a single burst of execution when the runtime calls the <xref:System.Activities.CodeActivity.Execute%2A> method.</span></span> <span data-ttu-id="7e6b8-166">Если метод выполнения еще не был вызван и действие, основанное на действии <xref:System.Activities.CodeActivity>, отменяется, действие закрывается с состоянием <xref:System.Activities.ActivityInstanceState.Canceled>, а метод <xref:System.Activities.CodeActivity.Execute%2A> не вызывается.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-166">If the execute method has not yet been called and a <xref:System.Activities.CodeActivity> based activity is canceled, the activity closes with a status of <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.CodeActivity.Execute%2A> method is not called.</span></span>  
  
### <a name="cancellation-using-nativeactivity"></a><span data-ttu-id="7e6b8-167">Отмена с помощью NativeActivity</span><span class="sxs-lookup"><span data-stu-id="7e6b8-167">Cancellation using NativeActivity</span></span>  

 <span data-ttu-id="7e6b8-168">Действия, производные от действия <xref:System.Activities.NativeActivity>, могут переопределять метод <xref:System.Activities.NativeActivity.Cancel%2A> для предоставления пользовательской логики отмены.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-168"><xref:System.Activities.NativeActivity> derived activities can override the <xref:System.Activities.NativeActivity.Cancel%2A> method to provide custom cancellation logic.</span></span> <span data-ttu-id="7e6b8-169">Если этот метод не переопределен, то применяется предусмотренная по умолчанию логика отмены рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-169">If this method is not overridden, then the default workflow cancellation logic is applied.</span></span> <span data-ttu-id="7e6b8-170">Отмена по умолчанию — это процесс, выполняемый для <xref:System.Activities.NativeActivity> , который не переопределяет <xref:System.Activities.NativeActivity.Cancel%2A> метод или <xref:System.Activities.NativeActivity.Cancel%2A> метод, вызывающий базовый <xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A> метод.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-170">Default cancellation is the process that occurs for a <xref:System.Activities.NativeActivity> that does not override the <xref:System.Activities.NativeActivity.Cancel%2A> method or whose <xref:System.Activities.NativeActivity.Cancel%2A> method calls the base <xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="7e6b8-171">При отмене действия среда выполнения отмечает действие как подлежащее отмене и автоматически производит определенную очистку.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-171">When an activity is canceled, the runtime flags the activity for cancellation and automatically handles certain cleanup.</span></span> <span data-ttu-id="7e6b8-172">Если действие имеет только закладки, ожидающие обработки, то закладки удаляются и действие отмечается как <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-172">If the activity only has outstanding bookmarks, the bookmarks will be removed and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="7e6b8-173">Любые ожидающие обработки дочерние действия отмененного действия, в свою очередь, будут отменены.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-173">Any outstanding child activities of the canceled activity will in turn be canceled.</span></span> <span data-ttu-id="7e6b8-174">Любая попытка запланировать дополнительные дочерние действия будет проигнорирована, и действие будет отмечено как <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-174">Any attempt to schedule additional child activities will result in the attempt being ignored and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="7e6b8-175">Если любое ожидающее обработки дочернее действие завершится в состоянии <xref:System.Activities.ActivityInstanceState.Canceled> или <xref:System.Activities.ActivityInstanceState.Faulted>, то действие будет отмечено как <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-175">If any outstanding child activity completes in the <xref:System.Activities.ActivityInstanceState.Canceled> or <xref:System.Activities.ActivityInstanceState.Faulted> state, then the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="7e6b8-176">Следует отметить, что запрос отмены может быть проигнорирован.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-176">Note that a cancellation request can be ignored.</span></span> <span data-ttu-id="7e6b8-177">Если действие не имеет ожидающих обработки закладок или выполняющихся дочерних действий, а также не планирует никаких дополнительных элементов работы после того, как оно было отмечено для отмены, то оно завершится успешно.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-177">If an activity does not have any outstanding bookmarks or executing child activities and does not schedule any additional work items after being flagged for cancellation, it will complete successfully.</span></span> <span data-ttu-id="7e6b8-178">Эта предусмотренная по умолчанию логика отмены является приемлемой для многих сценариев, но если потребуется дополнительная логика отмены, то могут использоваться встроенные действия отмены или пользовательские действия.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-178">This default cancellation suffices for many scenarios, but if additional cancellation logic is needed, then the built-in cancellation activities or custom activities can be used.</span></span>  
  
 <span data-ttu-id="7e6b8-179">В следующем примере метод <xref:System.Activities.NativeActivity.Cancel%2A> переопределяет пользовательское действие <xref:System.Activities.NativeActivity>, основанное на действии `ParallelForEach`.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-179">In the following example, the <xref:System.Activities.NativeActivity.Cancel%2A> override of a <xref:System.Activities.NativeActivity> based custom `ParallelForEach` activity is defined.</span></span> <span data-ttu-id="7e6b8-180">Если действие отменяется, это переопределение отрабатывает логику отмены для действия.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-180">When the activity is canceled, this override handles the cancellation logic for the activity.</span></span> <span data-ttu-id="7e6b8-181">Этот пример является частью образца [ParallelForEach, не являющегося универсальным](./samples/non-generic-parallelforeach.md) .</span><span class="sxs-lookup"><span data-stu-id="7e6b8-181">This example is part of the [Non-Generic ParallelForEach](./samples/non-generic-parallelforeach.md) sample.</span></span>  
  
```csharp  
protected override void Cancel(NativeActivityContext context)  
{  
    // If we do not have a completion condition then we can just  
    // use default logic.  
    if (this.CompletionCondition == null)  
    {  
        base.Cancel(context);  
    }  
    else  
    {  
        context.CancelChildren();  
    }  
}  
```  
  
 <span data-ttu-id="7e6b8-182">Производные действия <xref:System.Activities.NativeActivity> могут определять, запрошена ли отмена, проверяя значение свойства <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A>, и помечать себя как отмененные действия, вызывая метод <xref:System.Activities.NativeActivityContext.MarkCanceled%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-182"><xref:System.Activities.NativeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> method.</span></span> <span data-ttu-id="7e6b8-183">Вызов метода <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> не приводит к немедленному завершению действия.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-183">Calling <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> does not immediately complete the activity.</span></span> <span data-ttu-id="7e6b8-184">Как обычно, среда выполнения завершит действие, когда у него не останется больше ожидающей выполнения работы, но если вызывается метод <xref:System.Activities.NativeActivityContext.MarkCanceled%2A>, то конечным состоянием будет <xref:System.Activities.ActivityInstanceState.Canceled>, а не <xref:System.Activities.ActivityInstanceState.Closed>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-184">As usual, the runtime will complete the activity when it has no more outstanding work, but if <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> is called the final state will be <xref:System.Activities.ActivityInstanceState.Canceled> instead of <xref:System.Activities.ActivityInstanceState.Closed>.</span></span>  
  
### <a name="cancellation-using-asynccodeactivity"></a><span data-ttu-id="7e6b8-185">Отмена с помощью AsyncCodeActivity</span><span class="sxs-lookup"><span data-stu-id="7e6b8-185">Cancellation using AsyncCodeActivity</span></span>  

 <span data-ttu-id="7e6b8-186">Действия, основанные на действии <xref:System.Activities.AsyncCodeActivity>, также могут предоставлять пользовательскую логику отмены путем переопределения метода <xref:System.Activities.AsyncCodeActivity.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-186"><xref:System.Activities.AsyncCodeActivity> based activities can also provide custom cancellation logic by overriding the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="7e6b8-187">Если этот метод не переопределен, то при отмене действия не выполняется никакая обработка отмены.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-187">If this method is not overridden, then no cancellation handling is performed if the activity is canceled.</span></span> <span data-ttu-id="7e6b8-188">В следующем примере определяется переопределение пользовательского действия <xref:System.Activities.AsyncCodeActivity.Cancel%2A>, основанного на действии <xref:System.Activities.AsyncCodeActivity> методом `ExecutePowerShell`.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-188">In the following example, the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> override of an <xref:System.Activities.AsyncCodeActivity> based custom `ExecutePowerShell` activity is defined.</span></span> <span data-ttu-id="7e6b8-189">Если действие отменяется, оно реализует желаемое поведение отмены.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-189">When the activity is canceled, it performs the desired cancellation behavior.</span></span>
  
 [!code-csharp[CFX_WorkflowApplicationExample#1020](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#1020)]  
  
 <span data-ttu-id="7e6b8-190">Производные действия <xref:System.Activities.AsyncCodeActivity> могут определять, запрошена ли отмена, проверяя значение свойства <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A>, и помечать себя как отмененные действия, вызывая метод <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A>.</span><span class="sxs-lookup"><span data-stu-id="7e6b8-190"><xref:System.Activities.AsyncCodeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> method.</span></span>
