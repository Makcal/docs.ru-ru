---
description: Дополнительные сведения см. в статье как выполнить запрос для нематериализованных экземпляров.
title: Практическое руководство. Запросы для несохраняемых экземпляров
ms.date: 03/30/2017
ms.assetid: 294019b1-c1a7-4b81-a14f-b47c106cd723
ms.openlocfilehash: 2cef64f97b32c5f1d31fa078200bc2fe15179485
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99777662"
---
# <a name="how-to-query-for-non-persisted-instances"></a><span data-ttu-id="1ad47-103">Практическое руководство. Запросы для несохраняемых экземпляров</span><span class="sxs-lookup"><span data-stu-id="1ad47-103">How to: Query for Non-persisted Instances</span></span>

<span data-ttu-id="1ad47-104">Когда новый экземпляр службы создан и для службы определено поведение хранилища экземпляров рабочих процессов SQL, узел службы создает начальную запись для экземпляра службы в хранилище экземпляров.</span><span class="sxs-lookup"><span data-stu-id="1ad47-104">When a new instance of a service is created and the service has the SQL Workflow Instance Store behavior defined, the service host creates a initial entry for that service instance in the instance store.</span></span> <span data-ttu-id="1ad47-105">Позднее, когда экземпляр службы материализуется в первый раз, поведение хранилища экземпляров рабочих процессов SQL сохраняет текущее состояние экземпляра вместе с дополнительными данными, необходимыми для его активации, восстановления и управления.</span><span class="sxs-lookup"><span data-stu-id="1ad47-105">Subsequently when the service instance persists for the first time, the SQL Workflow Instance Store behavior stores the current instance state together with additional data that is required for activation, recovery, and control.</span></span>

<span data-ttu-id="1ad47-106">Если экземпляр не материализован после создания начальной записи для экземпляра, считается, что экземпляр службы находится в нематериализованном состоянии.</span><span class="sxs-lookup"><span data-stu-id="1ad47-106">If an instance is not persisted after the initial entry for the instance is created, the service instance is said to be in the non-persisted state.</span></span> <span data-ttu-id="1ad47-107">Ко всем материализованным экземплярам службы можно выполнять запросы и управлять ими.</span><span class="sxs-lookup"><span data-stu-id="1ad47-107">All the persisted service instances can be queried and controlled.</span></span> <span data-ttu-id="1ad47-108">К нематериализованным экземплярам службы нельзя выполнять запросы, управление ими также невозможно.</span><span class="sxs-lookup"><span data-stu-id="1ad47-108">Non-persisted service instances can neither be queried nor controlled.</span></span> <span data-ttu-id="1ad47-109">Если нематериализованный экземпляр приостановлен из-за необработанного исключения, к нему можно выполнять запросы, но им нельзя управлять.</span><span class="sxs-lookup"><span data-stu-id="1ad47-109">If a non-persisted instance is suspended due to an unhandled exception it can be queried but not controlled.</span></span>

<span data-ttu-id="1ad47-110">Экземпляры устойчивой службы, которые еще не материализованы, остаются в нематериализованном состоянии в следующих ситуациях.</span><span class="sxs-lookup"><span data-stu-id="1ad47-110">Durable service instances that are not yet persisted remain in a non-persisted state in the following scenarios:</span></span>

- <span data-ttu-id="1ad47-111">Сбой узла службы происходит до первой материализации экземпляра.</span><span class="sxs-lookup"><span data-stu-id="1ad47-111">The service host crashes before the instance persisted for the first time.</span></span> <span data-ttu-id="1ad47-112">Начальная запись для экземпляра остается в хранилище экземпляров.</span><span class="sxs-lookup"><span data-stu-id="1ad47-112">The initial entry for the instance remains in the instance store.</span></span> <span data-ttu-id="1ad47-113">Экземпляр не может быть восстановлен.</span><span class="sxs-lookup"><span data-stu-id="1ad47-113">The instance is not recoverable.</span></span> <span data-ttu-id="1ad47-114">Если поступает коррелированное сообщение, экземпляр вновь становится активным.</span><span class="sxs-lookup"><span data-stu-id="1ad47-114">If a correlated message arrives, the instance becomes active again.</span></span>

- <span data-ttu-id="1ad47-115">Необработанное исключение для экземпляра происходит до первой материализации экземпляра.</span><span class="sxs-lookup"><span data-stu-id="1ad47-115">The instance experiences an unhandled exception before it persisted for the first time.</span></span> <span data-ttu-id="1ad47-116">Возникают следующие ситуации.</span><span class="sxs-lookup"><span data-stu-id="1ad47-116">The following scenarios arise</span></span>

  - <span data-ttu-id="1ad47-117">Если для свойства **унхандледексцептионактион** задано значение **прерывания**, сведения о развертывании службы записываются в хранилище экземпляров, а экземпляр выгружается из памяти.</span><span class="sxs-lookup"><span data-stu-id="1ad47-117">If the value of the **UnhandledExceptionAction** property is set to **Abandon**, the service deployment information is written to the instance store and the instance is unloaded from memory.</span></span> <span data-ttu-id="1ad47-118">Экземпляр остается в нематериализованном состоянии в базе данных сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="1ad47-118">The instance remains in non-persisted state in the persistence database.</span></span>

  - <span data-ttu-id="1ad47-119">Если для свойства **унхандледексцептионактион** задано значение **абандонандсуспенд**, сведения о развертывании службы записываются в базу данных сохраняемости, а состояние экземпляра — в значение **suspended**.</span><span class="sxs-lookup"><span data-stu-id="1ad47-119">If the value of the **UnhandledExceptionAction** property is set to **AbandonAndSuspend**, the service deployment information is written to the persistence database and the instance state is set to **Suspended**.</span></span> <span data-ttu-id="1ad47-120">Экземпляр нельзя возобновить, отменить или завершить.</span><span class="sxs-lookup"><span data-stu-id="1ad47-120">The instance cannot be resumed, canceled, or terminated.</span></span> <span data-ttu-id="1ad47-121">Узел службы не может загрузить экземпляр, так как экземпляр еще не материализован, поэтому запись в базе данных для экземпляра не завершена (не полна).</span><span class="sxs-lookup"><span data-stu-id="1ad47-121">The service host cannot load the instance because the instance hasn't persisted yet and, hence the database entry for the instance is not complete.</span></span>

  - <span data-ttu-id="1ad47-122">Если для свойства **унхандледексцептионактион** задано значение **Cancel** или **Terminate**, сведения о развертывании службы записываются в хранилище экземпляров, а состояние экземпляра — в значение **Completed**.</span><span class="sxs-lookup"><span data-stu-id="1ad47-122">If the value of the **UnhandledExceptionAction** property is set to **Cancel** or **Terminate**, the service deployment information is written to the instance store and the instance state is set to **Completed**.</span></span>

<span data-ttu-id="1ad47-123">В следующих разделах представлены образцы запросов для поиска нематериализованных экземпляров в базе данных сохраняемости SQL и удаления этих экземпляров из базы данных.</span><span class="sxs-lookup"><span data-stu-id="1ad47-123">The following sections provide sample queries to find non-persisted instances in the SQL persistence database and to delete these instances from the database.</span></span>

## <a name="to-find-all-instances-not-persisted-yet"></a><span data-ttu-id="1ad47-124">Обнаружение всех еще не материализованных экземпляров</span><span class="sxs-lookup"><span data-stu-id="1ad47-124">To find all instances not persisted yet</span></span>

<span data-ttu-id="1ad47-125">Следующий SQL-запрос возвращает идентификатор (ID) и время создания для всех экземпляров, которые еще не материализованы в базе данных сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="1ad47-125">The following SQL query returns the ID and creation time for all instances that are not persisted in to the persistence database yet.</span></span>

```sql
select InstanceId, CreationTime from [System.Activities.DurableInstancing].[Instances] where IsInitialized = 0;
```

## <a name="to-find-all-instances-not-persisted-yet-and-also-not-loaded"></a><span data-ttu-id="1ad47-126">Обнаружение всех экземпляров, которые еще не материализованы и не загружены</span><span class="sxs-lookup"><span data-stu-id="1ad47-126">To find all instances not persisted yet and also not loaded</span></span>

 <span data-ttu-id="1ad47-127">Следующий SQL-запрос возвращает идентификатор (ID) и время создания для всех экземпляров, которые не материализованы и не загружены.</span><span class="sxs-lookup"><span data-stu-id="1ad47-127">The following SQL query returns ID and creation time for all instances that are not persisted and also are not loaded.</span></span>

```sql
select InstanceId, CreationTime from [System.Activities.DurableInstancing].[Instances] where IsInitialized = 0 and CurrentMachine is NULL;
```

## <a name="to-find-all-suspended-instances-not-persisted-yet"></a><span data-ttu-id="1ad47-128">Обнаружение всех приостановленных, но еще не материализованных экземпляров</span><span class="sxs-lookup"><span data-stu-id="1ad47-128">To find all suspended instances not persisted yet</span></span>

<span data-ttu-id="1ad47-129">Следующий SQL-запрос возвращает идентификатор (ID), время создания, причину приостановки и имя исключения приостановки для всех экземпляров, которые не материализованы и находятся в приостановленном состоянии.</span><span class="sxs-lookup"><span data-stu-id="1ad47-129">The following SQL query returns ID, creation time, suspension reason, and suspension exception name for all instances that are not persisted and also in a suspended state.</span></span>

```sql
select InstanceId, CreationTime, SuspensionReason, SuspensionExceptionName from [System.Activities.DurableInstancing].[Instances] where IsInitialized = 0 and IsSuspended = 1;
```

## <a name="to-delete-non-persisted-instances-from-the-persistence-database"></a><span data-ttu-id="1ad47-130">Удаление нематериализованных экземпляров из базы данных сохраняемости</span><span class="sxs-lookup"><span data-stu-id="1ad47-130">To delete non-persisted instances from the persistence database</span></span>

<span data-ttu-id="1ad47-131">Необходимо периодически проверять хранилище экземпляров на наличие нематериализованных экземпляров и удалять экземпляры из хранилища экземпляров, если можно быть уверенным, что экземпляр не получит коррелированного сообщения.</span><span class="sxs-lookup"><span data-stu-id="1ad47-131">You should periodically check the instance store for non-persisted instances and remove instances from the instance store if you are sure that the instance will not receive a correlated message.</span></span> <span data-ttu-id="1ad47-132">Например, если экземпляр находился в базе данных в течение нескольких месяцев, а известно, что обычная продолжительность существования рабочего процесса составляет несколько дней, можно с уверенностью предположить, что это неинициализированный экземпляр, в котором произошел сбой.</span><span class="sxs-lookup"><span data-stu-id="1ad47-132">For example, if the instance has been in the database for several months and you know that the workflow typically has a lifetime of a few days, it would be safe to assume that this is an uninitialized instance that had crashed.</span></span>

<span data-ttu-id="1ad47-133">Как правило, нематериализованные экземпляры, которые не приостановлены или не загружены, можно удалять без осложнений.</span><span class="sxs-lookup"><span data-stu-id="1ad47-133">In general, it is safe to delete non-persisted instances that are not suspended or not loaded.</span></span> <span data-ttu-id="1ad47-134">Не следует удалять **все** нематериализованные экземпляры, так как этот набор экземпляров содержит только что созданные экземпляры, но еще не сохранены.</span><span class="sxs-lookup"><span data-stu-id="1ad47-134">You should not delete **all** the non-persisted instances because this instance set includes instances that are just created but are not persisted yet.</span></span> <span data-ttu-id="1ad47-135">Следует удалять только нематериализованные экземпляры, которые остались неиспользованными, так как в самом экземпляре или в узле службы рабочего процесса, в котором был загружен экземпляр, произошло исключение.</span><span class="sxs-lookup"><span data-stu-id="1ad47-135">You should only delete non-persisted instances that are left over because the workflow service host that had the instance loaded caused an exception or the instance itself caused an exception.</span></span>

> [!WARNING]
> <span data-ttu-id="1ad47-136">Удаление нематериализованных экземпляров из хранилища экземпляров уменьшает размер хранилища и может повысить производительность операций с хранилищем.</span><span class="sxs-lookup"><span data-stu-id="1ad47-136">Deleting non-persisted instances from the instance store decreases the size of the store and may improve the performance of store operations.</span></span>
