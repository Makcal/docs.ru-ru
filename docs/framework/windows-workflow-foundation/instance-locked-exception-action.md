---
description: 'Дополнительные сведения: действие исключения блокировки экземпляра'
title: Действие в случае исключения «Экземпляр заблокирован»
ms.date: 03/30/2017
ms.assetid: 164a5419-315c-4987-ad72-54cbdb88d402
ms.openlocfilehash: ebbd86aad0f2e628f2656392fd464e3c1436c148
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2021
ms.locfileid: "99792678"
---
# <a name="instance-locked-exception-action"></a><span data-ttu-id="a3dc4-103">Действие в случае исключения «Экземпляр заблокирован»</span><span class="sxs-lookup"><span data-stu-id="a3dc4-103">Instance Locked Exception Action</span></span>

<span data-ttu-id="a3dc4-104">Свойство <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore.InstanceLockedExceptionAction%2A> хранилища экземпляров рабочего процесса SQL позволяет указать, какое действие должен выполнить поставщик сохраняемости SQL при получении <xref:System.Runtime.DurableInstancing.InstanceLockedException>.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-104">The <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore.InstanceLockedExceptionAction%2A> property of the SQL Workflow Instance Store lets you specify what action the SQL persistence provider should take when it receives an <xref:System.Runtime.DurableInstancing.InstanceLockedException>.</span></span> <span data-ttu-id="a3dc4-105">Поставщик сохраняемости получает это исключение, когда пытается заблокировать экземпляр службы рабочего процесса, который в настоящий момент заблокирован другим узлом службы.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-105">The persistence provider receives this exception when it tries to lock a workflow service instance that is currently locked by another service host.</span></span> <span data-ttu-id="a3dc4-106">Возможные значения этого свойства: <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>, <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> и <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-106">The values for this property are <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>, <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>, and <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>.</span></span> <span data-ttu-id="a3dc4-107">Значение по умолчанию — <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-107">The default value is <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.</span></span> <span data-ttu-id="a3dc4-108">В следующем списке приводится описание этих трех параметров.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-108">The following list describes the three options:</span></span>  
  
- <span data-ttu-id="a3dc4-109"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-109"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.</span></span> <span data-ttu-id="a3dc4-110">Узел службы не пытается заблокировать экземпляр службы рабочего процесса и передает его <xref:System.Runtime.DurableInstancing.InstanceLockedException> вызывающему объекту.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-110">The service host does not attempt to lock the workflow service instance and passes the <xref:System.Runtime.DurableInstancing.InstanceLockedException> to the caller.</span></span>  <span data-ttu-id="a3dc4-111">Если рабочий процесс остается в памяти в течение периода, превышающего 60 секунд, используйте <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry> в качестве повторной попытки.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-111">If your workflow stays in memory for a period exceeding 60 seconds, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry> as the retry.</span></span> <span data-ttu-id="a3dc4-112">Значение по умолчанию — <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-112">The default value is <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.</span></span>  
  
- <span data-ttu-id="a3dc4-113"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-113"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>.</span></span> <span data-ttu-id="a3dc4-114">Узел службы повторно пытается заблокировать экземпляр службы Workflow Service с линейными интервалами между попытками повтора и передает исключение <xref:System.Runtime.DurableInstancing.InstanceLockedException> вызывающему объекту в конце последовательности.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-114">The service host reattempts to lock the workflow service instance with a linear interval between retry attempts and passes the <xref:System.Runtime.DurableInstancing.InstanceLockedException> to the caller at the end of the sequence.</span></span> <span data-ttu-id="a3dc4-115">Если рабочий процесс остается в памяти в течение приблизительно 5–60 секунд, а сообщения поступают пакетами, когда более вероятна отправка всех сообщений на обработку в один и тот же экземпляр на одном и том же узле до выгрузки рабочего процесса, используйте <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> для достижения оптимальной задержки без ненужной затраты ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-115">If you workflow stays in memory approximately between 5-60 seconds, and messages arrive in batches where it is more likely for messages being sent to the same instance on the same host to process all messages before unloading the workflow, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> to achieve the best latency without wasting resources.</span></span>  
  
- <span data-ttu-id="a3dc4-116"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-116"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>.</span></span> <span data-ttu-id="a3dc4-117">Узел службы повторно пытается заблокировать экземпляр службы Workflow Service с экспоненциально растущим интервалом между попытками повтора и передает исключение вызывающему объекту в конце последовательности.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-117">The service host reattempts to lock the workflow service instance with an exponential backoff interval between retry attempts, and passes the exception to the caller at the end of the sequence.</span></span> <span data-ttu-id="a3dc4-118">Если рабочий процесс остается в памяти в течение очень короткого промежутка времени (менее 5 секунд) либо веб-ферма велика и вероятность доставки другого сообщения на тот же узел невелика, используйте <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry> для достижения оптимальной задержки.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-118">If your workflow stays in memory for a very short time (less than 5 seconds), or a Web farm is large and the chance of another message being delivered to the same host is not very high, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry> to achieve the best latency.</span></span>  
  
 <span data-ttu-id="a3dc4-119">Функция «Действие при возникновении исключения заблокированного экземпляра» поддерживает следующие сценарии.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-119">The Instance Locked Exception Action feature supports the following scenarios.</span></span> <span data-ttu-id="a3dc4-120">Во всех сценариях, если свойство instanceLockedExceptionAction хранилища SqlWorkflowInstanceStore имеет значение <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> или <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>, узел прозрачно выполняет периодические попытки заблокировать экземпляры.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-120">In all scenarios, if the instanceLockedExceptionAction property of the SqlWorkflowInstanceStore is set to <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> or <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>, the host transparently retries to acquire the lock on instances periodically.</span></span>  
  
1. <span data-ttu-id="a3dc4-121">**Включение правильного завершения работы и перезапуск с перекрытием доменов приложений.**</span><span class="sxs-lookup"><span data-stu-id="a3dc4-121">**Enabling graceful shutdown and overlapped recycling of application domains.**</span></span> <span data-ttu-id="a3dc4-122">Предположим, что **AppDomain** с узлом службы, на котором запущены экземпляры службы рабочих процессов, будет перезапущен, а новый **AppDomain** будет параллельно выполнять новые запросы, а старый **AppDomain** перейдет в нормальное состояние.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-122">Suppose an **AppDomain** with a service host running workflow service instances is being recycled and a new **AppDomain** is brought up to handle new requests in parallel while the old **AppDomain** is brought down gracefully.</span></span> <span data-ttu-id="a3dc4-123">Завершение работы ожидает, пока все экземпляры служб рабочих процессов не войдут в неактивном состоянии, после чего сохраняет и выгружает экземпляры.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-123">The shutdown waits until workflow service instances are idle, and then persists and unloads the instances.</span></span> <span data-ttu-id="a3dc4-124">Любые попытки размещения экземпляра в новом **домене AppDomain** приведут к вызову <xref:System.Runtime.DurableInstancing.InstanceLockedException> .</span><span class="sxs-lookup"><span data-stu-id="a3dc4-124">Any attempts by hosts in the new **AppDomain** to lock an instance will cause an <xref:System.Runtime.DurableInstancing.InstanceLockedException>.</span></span>  
  
2. <span data-ttu-id="a3dc4-125">**Горизонтальное масштабирование устойчивых рабочих процессов в гомогенной ферме серверов.**</span><span class="sxs-lookup"><span data-stu-id="a3dc4-125">**Horizontally scaling durable workflows across a homogeneous farm of servers.**</span></span> <span data-ttu-id="a3dc4-126">Предположим, что узел фермы серверов, на котором запущен экземпляр рабочего процесса, прекращает работу в результате сбоя и узел рабочего процесса не может снять блокировку запущенного экземпляра.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-126">Suppose a node of a server farm on which a workflow instance is running crashes and the workflow host cannot remove locks on the instance it is running.</span></span> <span data-ttu-id="a3dc4-127">Когда узел служб, запущенный на другом узле фермы, получает сообщение для этого экземпляра рабочего процесса, он пытается заблокировать экземпляры и получает исключение <xref:System.Runtime.DurableInstancing.InstanceLockedException>.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-127">When a service host running on another node of the farm receives a message for that workflow instance, it tries to acquire locks on these instances it will receive the <xref:System.Runtime.DurableInstancing.InstanceLockedException>.</span></span> <span data-ttu-id="a3dc4-128">Срок блокировки истечет через некоторое время, поскольку узел, который должен был обновить блокировку, уже не существует.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-128">The locks will expire after some time because the host that was supposed to renew the lock no longer exists.</span></span>  
  
     <span data-ttu-id="a3dc4-129">**Горизонтальное масштабирование устойчивых рабочих процессов в гомогенной ферме серверов.**</span><span class="sxs-lookup"><span data-stu-id="a3dc4-129">**Horizontally scaling durable workflows across a homogeneous farm of servers.**</span></span>  <span data-ttu-id="a3dc4-130"> Предположим, что необходимо горизонтально масштабировать устойчивый рабочий процесс с использованием нескольких узлов и балансировки нагрузки на сеть (NLB). Узел рабочих процессов, работающий на одном узле фермы, загружает экземпляр рабочего процесса и обрабатывает сообщение, при этом следующее сообщение экземпляру перенаправляется узлу, который запущен на другом узле, поскольку система NLB не имеет алгоритма перенаправления сообщений на узел, на котором уже запущен экземпляр.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-130">Suppose you want to horizontally scale a durable workflow using multiple hosts behind a NLB (Network Load Balancer), the workflow host running on one node of the farm loads a workflow instance and is processing a message, and the next message to the instance is routed to the host that is running on another node because the NLB does not have routing algorithm to deliver messages to the host that is already running the instance.</span></span> <span data-ttu-id="a3dc4-131">При получении сообщения второй узел пытается загрузить экземпляр рабочего процесса и получает исключение <xref:System.Runtime.DurableInstancing.InstanceLockedException>, поскольку первый узел уже заблокировал экземпляр.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-131">Upon receiving the message, the second host attempts to load the workflow instance and receives the <xref:System.Runtime.DurableInstancing.InstanceLockedException> because the first host has a lock on the instance.</span></span> <span data-ttu-id="a3dc4-132">Первый узел снимает блокировку с экземпляра после завершения обработки первого сообщения, а второй узел получает блокировку во время второй попытки, загружает этот экземпляр и обрабатывает второе сообщение.</span><span class="sxs-lookup"><span data-stu-id="a3dc4-132">The first host unlocks the instance when it is finished with processing the first message and the second host acquires the lock when it retries the next time, loads the instance, and processes the second message.</span></span>
